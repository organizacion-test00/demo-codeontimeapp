/*!
* Data Aquarium Framework - Data Editor for Touch UI
* Copyright 2018-2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function h(n){t.notify({text:n,force:!0})}function a(n){return String.format(ut,typeof n=="string"?n:n.HeaderText)}function v(n,t){var r=n.closest(".dv-item"),i;return t==="above"?r.prev(".dv-item").length>0:(i=r.next(".dv-item"),i.length>0&&!i.find(".ui-btn").is(".app-calculated,.dv-action-see-all"))}function ft(){return t.settings("ui.inlineEditing.position")==="top"||t.pointer("touch")}function w(t,i){var r=t.session("targetDataView"),u,f;r&&(u=r.elem,f=u.closest(".dv-item").find(".app-row-status").removeClass("app-row-status-pending app-row-status-error"),i&&f.addClass("app-row-status-"+i),n.sync({dataView:r.id,elem:u,force:!0,scrollIntoView:!0}))}function e(n,i){t.lastTouch(!1);(!n.is(".app-selected")||i)&&(n.length&&t.tapping(!0),n.trigger($.Event("vclick",{ctrlKey:!0})));t.lastTouch(!0)}function nt(n){var t=n._id,i=$("#"+t+',[data-for="'+t+'"]').find(".app-row-status-new").closest(".ui-btn");return e(i,!0),!!i.length}function b(n){return n.keyCode||n.which}function tt(){r.barcode(":input")||n.activate()}function c(n){var t;return n.length&&(t=n.attr("class").match(/\bapp-field-(\S+)\b/),t&&(t=t[1])),t}function et(n){var t=[];return n._fields.forEach(function(n){var i=n.Name;n.Type==="DataView"||n.isReadOnly()||t.push(i)}),t}function y(n,i){t.scrollGrid(n,i)}function ot(r,u){var p=u.closest(".app-grid");if(p.length){var s=r.session("grid-avail-width"),o=u.closest(".dv-item"),w=Math.ceil(s-s*(i(o).width/s)),f=r.session("scroll-left")||0,b=f,a=o.find(".app-frozen").last(),e=i(n.frame()),v=e.right,h=i(o),c=h.right,l=a.length?i(a):i(o.find(".app-frozen-spacer"));if(t.pointer("mouse")&&(c-=6),v>c?f=Math.min(v-c+f+16,w):l&&l.right>e.left?u.is(".app-frozen")||(f=Math.max(f-(l.right-e.left)-16,0)):h.left>e.left&&(f=Math.max(f-(h.left-e.left)-16,0)),b!==f)return y(r,f),!0}}function it(n){var t=n.isReadOnly();return t&&(r._buffer=null,h(a(n)),r.focus({lastFocused:!0})),t}var u=$app,t=u.touch,r=u.input,n,f=t.fnVisible,l=Web.DataViewResources,k=l.Mobile,rt=l.ModalPopup,ut=k.ReadOnly,i=u.clientRect,d=u.elementAt,g,o=u.findDataView,s=t.scrollable,p=t.activePage;u.prototype.inlineEditing=function(n,i){var r=this,u;if(r._inlineEditingChecked||(r._inlineEditingChecked=!0,r.tagged("inline-editing-option-none")?(r.tagged("inline-editing")||r.tagged("inline-editing-when-pointer")&&!t.pointer("touch"))&&r.tag("inline-editing-mode"):(u=r.pageProp("inlineEditing"),u!=null?r.inlineEditing(u):r.tagged("inline-editing")&&!r._lookupInfo&&r.tag("inline-editing-mode"))),arguments.length)n?r.tag("inline-editing-mode"):r.untag("inline-editing-mode"),i!==!1&&r.pageProp("inlineEditing",n);else return!!r.tagged("inline-editing-mode")};n=t.edit={instance:function(){var n=t.dataView();return n&&n._inlineEditor?n:null},frame:function(t){var i=n._frame;return(t===!1&&(i&&i.remove(),n._frame=null),t===":visible")?i&&i[0].style.visibility!=="hidden"&&i.parent().length>0:t===":active"?i&&i[0].style.visibility!=="hidden"&&i.closest(".ui-page-active").length>0:(t==="show"?i&&(i.css({visibility:"",display:""}),n.sync({scrollIntoView:!1})):t==="hide"?i&&(i[0].style.visibility="hidden"):i||(i=n._frame=u.html.$span("app-focus-frame")),i)},field:function(t){return arguments.length?n._fieldName==t:n._fieldName},dataView:function(){var t;return n.frame(":visible")&&(t=o(n._dataViewId)),t},fieldElem:function(i){arguments.length||(i=n.dataView());var e,o,r,u;return i&&(o=i.session("dataEditor").fieldName,r=t.pageInfo(),u=">",r&&r.id===i._id||(u='.app-echo[data-for="'+i._id+'"]'),e=s().find(u+" .app-listview .app-selected .app-field-"+o).filter(f)),e},dataItem:function(t){var i=t||n.fieldElem();return i?i.closest(".dv-item"):null},detach:function(t){if(!n._moving&&(!arguments.length||t===!0||n._dataViewId===t)&&!n._active){var i=n._frame;i&&(i.css("visibility","hidden"),t===!0&&(i.closest(".ui-page").find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2"),i.remove()))}},sync:function(e){var rt,yt=n._pending,ct,pt,y,k,nt,at;if(!rt&&e&&e.reset&&yt&&(ct=yt.editor,pt=o(ct),$("#"+ct).removeClass("app-page-inlineeditor-inactive"),n._pending=null,w(pt,"error"),r.focus({lastFocused:!0}),rt=!0),(n._pending||u.dragMan._active)&&(rt=!0),!rt){e||(e={});var ut=e.elem,v=ut,l,ft=e.dataView||n._dataViewId,h=ft?typeof ft=="string"?o(ft):ft:t.toDataView(v),wt,s=e.fieldName;if(h&&h.inlineEditing())if(h.get_isForm()&&!n.instance())n.detach();else{if(t.isInTransition()){n._lastSyncOptions=e;return}if(wt=h.session("dataEditor")||{},v&&v.is(".app-field")?(s||(s=c(v)),nt=v=v.closest(".app-listview")):(l=t.scrollable(v),nt=t.dataView()===h?v=l.find(".app-listview"):v=l.find('.app-echo[data-for="'+h._id+'"]').find(".app-listview"),nt=nt.first()),s||(s=wt.fieldName),!s&&h._allFields&&(s=h._allFields[h._fields[0].AliasIndex].Name),s&&(y=ut&&ut.is(".app-field-"+s)?ut:v.find(".dv-item .ui-btn.app-selected .app-field"+(s?"-"+s:"")).filter(f).first(),y.length||(s=h._allFields[h._fields[0].AliasIndex].Name,y=v.find(".dv-item .ui-btn.app-selected .app-field"+(s?"-"+s:"")).filter(f).first()),y.length&&(v.closest(".ui-page-active").length||e.force)&&(l||(l=t.scrollable(y)),s||(s=c(y)),s))){h.session("dataEditor",{fieldName:s});k=y.find(".app-field-data").last();k.length||(k=y);var a=i(k),bt=i(l),p,tt,b=n.frame(),lt=n._dataViewId;if(lt!==h._id&&(n._dataViewId=h._id,lt&&t.summary(lt).find(".app-field-is-selected").removeClass("app-field-is-selected app-field-is-selected2")),b.parent().is(l)||b.appendTo(l),e.force!==!0&&e.ignoreOtherInputs!==!0&&$(document.activeElement).closest("[data-input]").length)return;if(k.is(".app-field-type-bool")&&(at=k.parent().height(),a={top:a.top,left:a.left,width:a.width,height:a.height},a.top=a.top-(at-a.height)/2,a.height=at),b.css({visibility:"",display:""}),b.css({left:a.left-bt.left-1,top:Math.round(a.top-bt.top+l.scrollTop()),width:a.width+2,height:Math.round(a.height)}),e.scrollIntoView&&ot(h,y)){e.scrollIntoView=!1;n.sync(e);return}if(nt.is(".app-grid")){tt=k.closest(".dv-item");p=!tt.prev().is(".dv-item");var kt=nt.find(".app-grid-header"),dt=t.dataView()===h?l.closest(".ui-page").find(".dv-heading .app-grid-header"):$(),gt=t.stickyHeaderBar(l),it=kt.find(".app-field-is-selected"),d=dt.find(".app-field-is-selected"),et=gt.find(".app-field-is-selected"),st;(!it.length&&!d.length||it.length&&(it.attr("data-field-name")!==s||p&&it.is(".app-field-is-selected2")||!p&&!it.is(".app-field-is-selected2"))||d.length&&(d.attr("data-field-name")!==s||p&&d.is(".app-field-is-selected2")||!p&&!d.is(".app-field-is-selected2"))||et.length&&(et.attr("data-field-name")!==s||p&&d.is(".app-field-is-selected2")||!p&&!et.is(".app-field-is-selected2")))&&(it.removeClass("app-field-is-selected app-field-is-selected2"),d.removeClass("app-field-is-selected app-field-is-selected2"),et.removeClass("app-field-is-selected app-field-is-selected2"),st='[data-field-name="'+s+'"]',kt.find(st).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!p),dt.find(st).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!p),gt.find(st).addClass("app-field-is-selected").toggleClass("app-field-is-selected2",!p))}if(e.scrollIntoView!==!1)t.makeVisible(n.frame(),l,tt);else{var vt=i(tt.closest(".app-listview")),g=i(b),ni=tt.find(".app-frozen-spacer"),ht=i(ni);g.left>vt.right?b.css("display","none"):g.right>vt.right&&b.css("width",g.width-(g.right-vt.right));ni.length&&!tt.find(".app-field-"+s).is(".app-frozen")&&(g.right<ht.right?b.css("display","none"):g.left<ht.right&&b.css({left:ht.right+1,width:g.right-(ht.right+1)}))}$(".app-data-input").length||l.focus();e.allowToggle&&t.lastTouch()!=null&&y.is(".app-field-type-bool")&&t.touched(y.find("i"))&&!t.busy()&&n.toggleBool(y)}}}},scrollIntoView:function(i){t.makeVisible(n.dataItem(i))},showField:function(i,e,h){if(u.touch.edit.sync({reset:!0}),e!=n._fieldName){var c=i.session("targetDataView"),l=c.elem,a=o(c.id);n._fieldName=e;r.evaluate({dataView:i,row:i.editRow(),fields:[],container:h||s().find('[data-input-container="'+i._id+'"]'),resize:!0});l=l.closest(".dv-item").find(".app-field-"+a._allFields[a.findField(e).AliasIndex].Name).filter(f);c.elem=l;n.sync({dataView:c.id,elem:l,scrollIntoView:!0,force:!0});t.resetPageHeight()}},toSyncKey:function(t){var i=n._pending;return i&&i.dataViewId===t._id&&i.syncKey?i.syncKey:t._syncKey},moveInput:function(i){var a=t.dataView(),vt=a._inlineFields,h=a._availableFields,yt,l=n.field(),ct,e,lt,rt,u=i.direction||"enter",nt,ut,d,s,at,ft,et,ot,tt,st,ht;if(t.pointer("touch")&&(u=u==="down"?"right":u==="up"?"left":u),$(document.activeElement).blur(),r.valid()){var k=a.session("targetDataView"),b=k.elem,w=o(k.id),g=b.closest(".dv-item-new").length>0;if(h||(h=a._availableFields=[],yt=[],b.closest(".dv-item").find(".app-field").filter(f).each(function(){var t=this,n=t.className.match(/\bapp\-field\-(.+?)\b/);n&&(n=n[1],n=w.findFieldUnderAlias(n),n&&(n=n.Name,vt.indexOf(n)!==-1&&h.push(n)))})),e=h.indexOf(l),u==="right"?(e++,e>h.length-1&&(e=v(b,"below")||g?0:h.length-1,!g,u="down")):u==="left"?(e--,e<0&&(e=v(b,"above")?h.length-1:0,u="up")):typeof u!="string"&&(e=-1,nt=u.closest(".app-field"),ut=c(nt),ut&&(d=w.findFieldUnderAlias(ut),d&&(e=h.indexOf(d.Name),s=k.elem.closest(".dv-item"),at=nt.closest(".dv-item"),s.is(at)?it(d)?e=-1:u="field":(u=nt,ct=d.Name)))),l=h[e]||ct,l)if(u==="right"||u==="left"||u==="field")n.showField(a,l),r.focus({fieldName:l});else{if(u==="down"||u==="up")if(s=b.closest(".dv-item"),s=u==="down"?s.next():s.prev(),s=s.find(".ui-btn"),g||s.is(".app-calculated")||!s.is(":visible"))if(g){if(et=b.closest(".dv-item").prev().find(".ui-btn"),ot=et.length?et.data("data-context"):null,e!==0&&(l=h[0],y(w,0),n.showField(a,l)),ot)for(u=ot.row,rt=[],st=w._keyFields,tt=0;tt<st.length;tt++)rt.push(u[st[tt].Index]);u="new"}else u="enter";else ft=s.find(".app-field-"+l),ft.length&&(u=ft);p().addClass("app-page-inlineeditor-inactive");typeof u=="string"||Array.isArray(u)||(n.sync({dataView:w,elem:u,force:!0,scrollIntoView:!0}),u=u.closest(".ui-btn").data("dataContext"),u&&(u=u.row));ht=n._pending={editor:a._id,pageId:n.frame().closest(".ui-page").attr("id"),dataViewId:k.id,action:a.changed()?"post":"cancel",field:w._allFields[w.findField(l).AliasIndex].Name,originalField:l,direction:u,syncKey:rt};lt=k.elem.closest(".dv-item").find(".app-row-status");ht.action==="cancel"?(ht.syncKey=null,t.goBack()):(lt.addClass("app-row-status-pending"),t.executeInContext())}}i.preventDefault()},syncKey:function(t){var i=n._pending;return i&&t._id===i.dataViewId?i.syncKey:null},_broadcastValues:function(t,i){var r=t.session("targetDataView");if(r){var e=r.elem,u=e.closest(".dv-item"),s=u.closest(".app-grid").length>0;i.forEach(function(n){var i=t.findField(n.name||n.Name),r=n.name?"newValue"in n?n.newValue:n.value:"NewValue"in n?n.NewValue:n.Value,e;i&&u.find(".app-field-"+i.Name).filter(f).each(function(){var t=$(this),n,f=t.data("inline-undo"),u;f==null&&t.data("inline-undo",{html:t.html(),isNull:t.closest(".app-null").length>0});e=i.text(r);n=t.find(".app-field-data");n.length||(n=t);n.toggleClass("app-null",r==null);u=n.find(".material-icon-check-box,.material-icon-check-box-outline-blank");u.length&&!r?u.text("check_box_outline_blank").addClass("material-icon-check-box-outline-blank").removeClass("material-icon-check-box"):u.length&&r?u.text("check_box").addClass("material-icon-check-box").removeClass("material-icon-check-box-outline-blank"):i.htmlEncode()?n.text(e):n.html(e)})});n.sync({dataView:o(r.id),elem:e,force:!0,scrollIntoView:!0});u.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit")}},undo:function(i){i||(i=t.dataView());var r=i.session("targetDataView"),u=r.elem.closest(".dv-item");u.find(".app-field").each(function(){var n=$(this),t=n.data("inline-undo");t!=null&&(n.removeData("inline-undo"),n.html(t.html),n.find(".app-field-data").length||n.toggleClass("app-null",t.isNull))});u.find(".app-row-status").removeClass("app-row-status-edit");n.sync({dataView:n._dataViewId,elem:r.elem,force:!0})},commit:function(i){function v(){var v=r==="down",c=!r||r==="enter",y=r==="new",i=o(u.dataViewId),p,a,w,s;f==="post"&&i._busy()||(n._pending=null,r==="new"&&(r=new Array(i._allFields.length)),r==="up"||v||c?(n.sync({dataView:i,fieldName:h,scrollIntoView:!0}),c||l.trigger($.Event("keydown",{keyCode:v?40:38})),(n._fieldName!==u.originalField||c)&&n.sync({dataView:i,fieldName:h,scrollIntoView:!0})):r&&Array.isArray(r)&&(i.session("dataEditor").fieldName=h,p=n.fieldElem(i),a=$(p).closest(".app-listview"),a.find(".dv-item .ui-btn").each(function(){var n=$(this),l=n.data("data-context"),o,s,f,h,c,a;if(l&&(o=l.row,o)){for(s=!0,h=i._keyFields,f=0;f<h.length;f++)if(c=h[f].Index,r[c]!=o[c]){s=!1;break}if(s)return u.syncKey&&!y?(n.addClass("app-selected"),e(n,!0),a=n.parent().nextAll(".dv-item-new"),e(a.find(".ui-btn"),!0),t.stickyHeaderBar().hide(),t.stickyHeader()):e(n.removeClass("app-selected")),w=!0,!1}}),!w&&y&&(s=t.summary(a),s.length&&(t.lastTouch(!1),s.find(".dv-action-see-all .app-btn-next").trigger($.Event("vclick",{feedback:!1})),t.lastTouch(!0),e(s.find(".app-listview .dv-item-new .ui-btn"))))),l.focus())}var u=n._pending,c,a,l,f,h,r;if(u&&(a=p().attr("id"),u.pageId===a))if(l=s(),f=u.action,r=u.direction,c=i.type,h=u.field,f==="cancel"&&c==="pagereadycomplete")v();else if(f==="post"&&c==="dataviewrefresh")v();else return},move:function(i){function ot(){u instanceof jQuery||(u=$(u));t.tooltip(!1);n.sync({dataView:k,elem:u,scrollIntoView:et});tt||(u=null)}var ft,st,ht;if(n._moving)return!0;n._moving=!0;typeof i=="string"&&(i={direction:i});var h=i.direction,g=i.originalEvent,ut=g.shiftKey,it=g.ctrlKey,lt=g.metaKey,k=n.dataView(),u=n.fieldElem(k),a,tt,et,p,l,w,nt;switch(h){case"pageup":case"pagedown":return c=s().focus().find('.app-focus[data-input="dataview"]'),c.length&&(n.frame("hide"),t.summary(c).find(".dv-action-see-all .app-btn-"+(h==="pageup"?"prev":"next")+":not(.app-btn-disabled)").trigger($.Event("vclick",{feedback:!1})),n.sync(),a=!0),n._moving=!1,a}if(u){var at=u.closest(".app-listview"),c=at.closest(".app-echo"),d=u.closest(".dv-item").find(".app-field").filter(f),rt;if(et=at.is(".app-grid"),d.each(function(n){if($(this).is(u))return rt=n,!1}),ut)switch(h){case"enter":h="up"}it||h!=="enter"||(h="down");tt=c.length>0&&!it;h==="tab"&&(ut?rt?h="left":v(u,"above")?(u=d[d.length-1],ot(),tt&&(h="up")):tt&&(h="up"):rt===d.length-1?v(u,"below")?(u=d[0],ot(),tt&&(h="down"),y(k,0)):tt&&(h="down"):h="right");switch(h){case"right":u=d[rt+1];(et||!u)&&(a=!0);break;case"left":u=d[rt-1];u||(a=!0);break;case"home":it||lt?(c.length||t.scrollable(u).scrollTop(0).closest(".ui-page").find(".app-bar-heading").hide(),l=u.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").first(),l.is(".app-selected")||e(l),g.preventDefault(),u=null):(u=d[0],y(k,0));t.fetchOnDemand();break;case"end":it||lt?(c.length||(ft=t.scrollable(u),ft.length&&ft.scrollTop(ft[0].scrollHeight)),l=u.closest(".app-listview").find(".dv-item .ui-btn:not(.app-calculated)").last(),l.is(".app-selected")||e(l),g.preventDefault(),u=null):u=d[d.length-1];it&&t.fetchOnDemand();break;case"down":case"up":p=h==="down";tt?(l=u.closest(".dv-item"),w=(p?l.next():l.prev()).find(".ui-btn"),!w.length||w.is(".app-calculated,.dv-action-see-all")||w.parent().is(".app-hidden")?(nt=c.find(".dv-action-see-all").filter(f).find(".app-btn-"+(p?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(c.data("auto-highlight",p?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):(n._moving=!1,b(g)!=38&&b(g)!=40&&r.move($("#"+c.data("for")+"_ph"),h))):(e(w),n.scrollIntoView()),u=null,a=!0):u=null;break;case"enter":u.closest(".ui-page").is(".ui-page-active")?(t.lastTouch(!1),n._dataItemSelect=!1,u.trigger("vclick"),n._dataItemSelect=!0,t.lastTouch(!0),a=!0):u=null;break;default:u=null}u&&(ot(),a=!0)}else h!=="tab"&&h!=="down"&&h!=="up"||k||(p=h==="down"||h==="tab"&&!ut,c=t.summary(s().find('.app-focus[data-input="dataview"]')),c.length&&(k=o(c.data("for")),l=c.find(".app-listview .dv-item .app-selected").parent(),st=k.inlineEditing(),(st||!l.length)&&p?(ht=c.find(".dv-item:not(.app-calculated)").first().find(".app-field").filter(f).first(),ht.length&&(b(g)===40||!c.data("skip-item-focus"))?e(ht):r.move($("#"+c.data("for")+"_ph"),ut?"up":"down")):st?r.move($("#"+c.data("for")+"_ph"),"up"):h==="tab"?r.move($("#"+c.data("for")+"_ph"),p?"down":"up"):(w=(p?l.next():l.prev()).find(".ui-btn"),!w.length||w.is(".app-calculated,.dv-action-see-all")||w.parent().is(".app-hidden")?(nt=c.find(".dv-action-see-all").filter(f).find(".app-btn-"+(p?"next":"prev")),nt.length&&!nt.is(".app-btn-disabled")?(c.data("auto-highlight",p?"first":"last"),nt.trigger($.Event("vclick",{feedback:!1}))):r.move($("#"+c.data("for")+"_ph"),p?"down":"up")):(t.makeVisible(w),e(w))),a=!0));if(n._moving=!1,h==="space"&&k&&k.multiSelect()){var ct=n.dataItem().find(".app-btn-check"),vt=ct.closest(".ui-btn"),yt=ct.is(".app-btn-check-selected")&&k._selectedKeyList.length==1;ct.trigger("vclick");yt?n.detach():vt.is(".app-selected")||n.scrollIntoView(vt.closest(".app-listview").find(".ui-btn.app-selected"));a=!0}return a||h!=="tab"||$(document.activeElement).closest("[data-input]").length||r.focus({container:s()}),a},supports:function(n,i){var r=[],u=!1,f=n._viewId;return i==="New"?(r=n.actionGroups("Grid"),r.length&&r[0].Actions.every(function(n){var t=n.CommandArgument;return n.CommandName!==i||t&&t!==f||(u=!0),!u})):(t.contextScope(n._id),t.navContext(r),t.contextScope(null),r.every(function(n){var t=n.argument;return n.command!==i||t&&t!==f||(u=!0),!u})),u},toggleBool:function(i,r){if(!t.busy()){r||(r=n.dataView());var v=c(i),e=r.findFieldUnderAlias(v),y=r.row(),f=e.Items,o=y[e.Index],l=!e.isReadOnly()&&n.supports(r,"Edit"),s=f[f.length-(o===f[f.length-1][0]?2:1)][0];l?(s=l?f[f.length-(o===f[f.length-1][0]?2:1)][0]:o,i.removeClass("material-icon-check-box-outline-blank material-icon-check-box").addClass("material-icon-check-box"+s?"":"-outline-blank").find("i").text("check_box"+(s?"":"_outline_blank")),u.execute({command:"Update","in":r,values:[{field:e.Name,value:o,newValue:s}]}).then(function(n){r.sync();h(n.errors)})):h(a(e))}},clearField:function(i,r){if(!t.busy()){r||(r=n.dataView());i||(i=n.fieldElem(r));var b=c(i),f=r.findFieldUnderAlias(b),y=f.isReadOnly()||!n.supports(r,"Edit"),k=!y&&f.AllowNulls,e=null,p=[],o,w=u._fieldMapRegex,s,d=r.row(),v=[f];if(k){if(f.Index!==f.AliasIndex&&v.push(r._allFields[f.AliasIndex]),o=f.Copy,o)for(s=w.exec(o);s;)f=r.findField(s[1]),f&&v.push(f),s=w.exec(o);v.forEach(function(n){e=null;var t=i.closest(".dv-item").find(".app-field-"+n.Name);t.is(".app-field-type-bool")?(t.find("i").val("check_box_outline_blank"),n.AllowNulls||(e=!1)):t.text(l.Data.NullValueInForms);e==null&&t.addClass("app-null");p.push({field:n.Name,value:d[n.Index],newValue:e})});u.execute({command:"Update","in":r,values:p}).then(function(n){r.sync();h(n.errors)})}else h(y?a(f):l.Validator.Required)}},activate:function(i){var l,e,y,ut,d,p;if(!n._pending&&!t.busy()&&!t.isInTransition()){$(".app-bar-notify:not(.app-hidden").data("cancel",!1).trigger("vclick");n._activateInterval=null;t.fetchOnDemand();var f=n.dataView(),o,nt,w,v,ot=i&&i.toggle,b=!1;if(f&&!n._active&&f.inlineEditing()){if(o=n.fieldElem(f),!o.length)return b;nt=c(o);var k=f.findFieldUnderAlias(nt),tt=f.get_tag(),s,rt=it(k);if(rt||(l=n.supports(f,"Edit"),l?s="Edit":n.supports(f,"New")&&(l=f.rowIsTemplate(f.extension().commandRow()),s="New")),l){if(ot&&l&&k.Type==="Boolean"){n.toggleBool(o);return}n._fieldName=k.Name;n._active=!0;n._elem=o;f._tagList=null;w=o.closest(".dv-item");w.find(".app-row-status:not(.app-row-status-new)").addClass("app-row-status-edit");f._tag=(tt||"")+" transition-none action-buttons-none content-stub-none page-header-none modal-always modal-title-none modal-tap-out modal-dock-top modal-auto-grow modal-background-transparent modal-max-xs";v=w.find(".ui-btn").data("data-context");v&&(s!=="New"||!f.tagged("optimistic-default-values-none"))&&(e=u.parseJSON(f.session("getPageTemplate")),e&&(y=!0,e.Fields.every(function(n){var t=n.ItemsStyle;return t&&(t.match(/DropDownList|ListBox|RadioButtonList/)&&(n.Items==null||!n.Items.length)||n.ItemsTargetController)&&(y=!1,n.ContextFields&&(ut=!0)),y}),ut||(y?(s==="New"?(e.Rows=[],e.NewRow=v.row,e.Inserting=!0,d=f._controller,f.odp||u.execute({controller:d,view:f._viewId,requiresNewRow:!0,background:!0}).done(function(n){function o(){r.execute({values:u})}var i=n[d][0],u=[],f,e;if(i)for(f in i)e=i[f],e!=null&&u.push({name:f,value:e});u.length&&(t.isInTransition()?t.whenPageShown(o):o())})):e.Rows=[v.row],e.Tag=(e.Tag||"")+f._tag+" view-type-inline-editor",e.SupportsCaching=!1,u.odp.response("GetPage",e)):f._tag+=" system-replacegetpagetemplate")));s==="New"&&(f._copyExternalLookupValues(),p=f._ditto,p&&p.length&&(n._ditto=p.slice(0)));f._showModal({commandName:s,commandArgument:f.get_viewId()});f._tagList=null;f._tag=tt;b=!0}else{r._buffer=null;var g=f.headerField(),ft=f.extension().commandRow(),et=f.get_view().Label;g&&ft&&(headerFieldValue=ft[g.Index]);headerFieldValue&&(et=g.format(headerFieldValue));rt||h(a(et))}}return b}},expandBy:function(r,u){var e=r.closest(".app-page-inlineeditor-overlay"),o,f,h,c,l,s,a=!1,v;return e.length&&(c=t.dataView().session("targetDataView"),l=c.elem.closest(".app-wrapper"),s=i(l),o=e.find(".app-wrapper"),scrollableRect=i(o),f=Math.min(o.width()+u+3,Math.min(800,s.width*.75)),v=i(n.frame()),f=Math.ceil(Math.max(f,v.width)),o.css({minWidth:f,maxWidth:f}),e.css({minWidth:f,maxWidth:f}).data("overlay",{w:f,f:r.closest("[data-field]").data("field")}),h=i(e),h.right>s.right&&e.css("left",s.right-h.width-11),a=!0),a},form:function(n){var t=[];return t.push('<div data-layout="form" data-layout-size="xs" class="app-form-inlineeditor"><div data-container="simple" data-wrap="true" data-density="relaxed"><i class="app-icon material-icon material-icon-arrow-back" title="'+rt.CancelButton+'">arrow_back<\/i><i class="app-icon material-icon material-icon-more app-btn-more" title="'+k.More+'"><\/i>'),n._fields.forEach(function(n){var i=n.Name;n.Type!=="DataView"&&t.push('<div data-container="row" data-visible-when="$app.touch.edit.field(\''+i+'\')"><div class="app-form-inlineeditor-label"><span data-control="label" data-field="'+i+'"><span class="app-control-inner"><\/span><\/span><\/div><span data-control="field" data-field="'+i+'" data-auto-expand="true"><span class="app-control-inner"><\/span><\/span><\/div>')}),t.push("<\/div><\/div>"),t.join("\n")},position:function(r){var nt=!ft(),tt=r.find(".app-wrapper"),ht=tt.find(".app-form-inlineeditor"),p=n.field(),ct=ht.find('[data-control="field"][data-field="'+p+'"]'),lt=ct.data("input")||"",w=!lt.match(/blob|checkboxlist/),s,st,c,d;if(r.addClass("app-page-inlineeditor").toggleClass("app-custom-density-disabled",nt).removeClass("app-page-inlineeditor-overlay"),nt){r.data("trackPosition",!1);var it=t.pageInfo(r.attr("id")).dataView,rt=it.session("targetDataView"),u=rt?rt.elem:n._elem,b,h,v,ut,k,f,o,et,ot;if(w&&(ot=it.findField(p),ot.ItemsTargetController&&(w=!1)),w)s=r.addClass("app-page-inlineeditor-overlay").toggleClass("app-page-inlineeditor-textalignright",u.css("text-align")==="right").data("overlay"),st=r.data("positioned"),s=s&&s.f===n.field()?s:null,et=u.closest(".app-grid").length>0,et&&r.addClass("app-page-inlineeditor-gridstyle"),b=u.find(".app-field-data"),b.length&&(u=b),h=i(u),u.is(".app-field-type-bool")&&(h=i(n._frame)),r.css({maxHeight:"",minHeight:"",height:"",width:"",minWidth:"",maxWidth:""}),f=s!=null?s.w:h.width+2,o=Math.round(h.height),v=Math.round(h.left)-1,ut=Math.round(h.top),k=i(t.scrollable(u)),v+f-1>k.right&&(f=k.right-v-9),r.css({left:v,top:ut,maxHeight:o,minHeight:o,height:o,Width:f,minWidth:f,maxWidth:f}),tt.css({maxHeight:o,minHeight:o,height:o,width:f,minWidth:f,maxWidth:f}),st||(r.data("positioned",!0),c=$('.ui-page-active [data-field="'+p+'"] .app-data-input-button'),c.length&&(d=$('<span class="app-control-inner">w<\/span>').appendTo(c.parent()),c.css({top:(d.outerHeight()-c.outerHeight())/2,marginTop:""}),d.remove()));else{if(t.resetPageHeight(r),u){var l=i(u),e=i(r),a=e.left,y=e.top,g=t.screen();e.height+l.bottom+8<g.height?y=l.bottom+8:l.top-8-e.height>0&&(y=l.top-8-e.height);a=l.left-4;a+e.width-1>g.width&&(a=g.width-4-e.width)}(e.top!==y||e.left!==a)&&r.css({left:a,top:y})}r.data("trackPosition",!0)}else t.resetPageHeight(r)}};$(document).on("dataitemselect.dataview.app",function(r){if(r.namespace==="app.dataview"&&n._dataItemSelect!==!1){var o=t.lastTouch(),s,u,h,e=r.dataView;e.inlineEditing()&&(o&&(s=d(),u=s.closest(".app-field"),u.length||e.extension().viewStyle()!=="Grid"||s.find(".app-field").filter(f).each(function(){var t=this,n=i(t);if(o.x<n.left||n.left<=o.x&&o.x<=n.right)return u=$(t),!1}),u.length||(h=s.closest(".dv-item"),h.length&&(fieldName=(e.session("dataEditor")||{}).fieldName,fieldName&&(u=h.find(".app-field-"+fieldName))),u.length||(u=h.find(".app-field").first())),u.length||(u=null)),n.sync({dataView:e,elem:u,scrollIntoView:!0,ignoreOtherInputs:!0,allowToggle:!0}),r.action==="select"&&e.extension()._autoSelect&&setTimeout(t.executeInContext),r.preventDefault())}}).on("resizing.app",function(t){t.namespace==="app"&&n.detach()}).on("clear.dataview.app",function(){n.detach()}).on("keyboardnavigation.app",function(t){var r=t.originalEvent,i=t.direction;if(t.namespace==="app"&&!n._active)if(i==="edit"){if(n.activate())return!1}else{if(i==="space"&&n.frame(":active")&&n.fieldElem().is(".app-field-type-bool"))return n.toggleBool(n.fieldElem()),!1;if(n.frame(":active")&&n.move({direction:i,originalEvent:r}))return!1}}).on("keyboardpreview.app",function(t){if(n.frame(":active")){var i=t.originalEvent,u=i.key||"";u.length!==1&&!u.match(/Backspace|Del|Delete/)||i.ctrlKey||i.altKey||i.metaKey||(clearTimeout(g),r.barcode(":input")||(u.match(/Del|Delete/)?n.clearField():(r._buffer=u,t.preventDefault(),g=setTimeout(tt,32))))}}).on("showcontextmenu.app",function(r){function h(n){t.lastTouch(!1);n.trigger("vclick");t.lastTouch(!0);l=!1}var u=n.fieldElem(),e=r.originalEvent,o,l,c;return u?(o=u.closest(".app-echo"),e.shiftKey&&o.length?h(o.find(".app-echo-toolbar .app-btn-more")):e.ctrlKey&&h(u.closest(".dv-item").find(".app-btn-more"))):e.ctrlKey&&(c=i(s()),p(".app-listview .app-selected .app-btn-more").filter(f).each(function(){var n=i(this);if(n.top>c.top&&n.top<c.bottom)return h($(this)),!1})),l}).on("mousedown",".app-focus-frame",function(){t.clearHtmlSelection()}).on("vclick",".app-focus-frame",function(i){if(i.type==="vclick"){var r=n.fieldElem(),u=r.is(".app-field-type-bool");t.pointer("touch")?setTimeout(n.activate,0,{toggle:u}):u&&t.touched(r.find("i"))&&setTimeout(n.toggleBool,0,r)}}).on("contextmenu taphold",".app-focus-frame",function(){n.frame().hide();var t=d();return n.frame().show(),t.trigger("contextmenu"),!1}).on("dblclick",".app-focus-frame",function(){t.pointer("mouse")&&setTimeout(n.activate,0,{toggle:!0})}).on("generatelayout.dataview.app",function(t){t.dataView._inlineEditor&&(t.layout=n.form(t.dataView))}).on("pagepositionchanged.app",function(t){n.position(t.page)}).on("pagereadycomplete.app",function(t){var i=n.instance(),c=n._elem,u,r,f,e,s,h;if(i)if(n.position(t.page),n._active=!0,t.reverse)w(i);else if(c){if(s=o(i._parentDataViewId),i._inlineFields=et(s),i.session("targetDataView",{id:s._id,elem:c}),n._elem=null,i.inserting()&&!i._newRowBroadcasted){i._newRowBroadcasted=!0;u=i.data();r=[];for(f in u)e=u[f],e!=null&&r.push({name:f,value:e});r.length&&(n._broadcastValues(i,r),n.position(t.page))}}else w(i);else n._active=!1;h=n._lastSyncOptions;h&&(n._lastSyncOptions=null,n.sync(h));n.commit(t)}).on("dataviewrefresh.app",function(i){n.commit(i);var r=i.dataView,u=r.session("inlineEditor"),f;u!=null&&(f=r._autoNewRow,r.gridChanged(),t.stickyHeaderBar().hide(),t.stickyHeader(),r.session("inlineEditor",null),u&&(f?(nt(r),r._autoNewRow=!1):tt()))}).on("datainputbroadcast.app",function(t){var i=t.dataView;i._inlineEditor&&n._broadcastValues(i,t.values)}).on("datainputmove.app",function(u){var s,o,e,h,c,l;if(n.frame(":visible")&&(s=t.dataView(),s&&s._inlineEditor)){if(e=u.direction,e&&typeof e!="string"){if(e.closest(".app-focus-frame").length)return setTimeout(function(){r.focus({lastFocused:!0})}),!1;if(o=e.closest(".app-field"),o.length||(c=t.lastTouch(),c&&e.closest(".app-grid").length?e.closest(".dv-item").find(".app-field").filter(f).each(function(){var n=i(this);if(c.x<n.left||n.left<=c.x&&c.x<=n.right)return o=$(this),!1}):e.closest(".app-listview").length||(h=(e.attr("class")||"").match(/\bapp\-field\-(\w+)\b/),h&&h[1]!==n.field()&&(o=s.session("targetDataView").elem.closest(".dv-item").find("."+h[0]),o.length&&n.field(h[1])))),o.length){if(u.direction=o,l=s.session("targetDataView"),!o.closest(".app-listview").is(l.elem.closest(".app-listview")))return}else return}u.fromDataInput||(u.fromDataInput=t.pageInfo().scrollable.find('[data-input][data-field="'+n.field()+'"]'));n.moveInput(u)}}).on("dataviewignorechanges.app",function(t){var i=t.dataView;i._inlineEditor&&n.undo(i)}).on("inlineeditingmode.dataview.app",function(i){var r=i.dataView,u=r.extension(),a=u.commandRow(),f=i.inlineEditing,o,h,c,l=i.newRow,v;if(f){if(o=s(),h=t.pageInfo(),c=h&&h.dataView===r?o.find(".app-listview .dv-item .ui-btn").first():o.find('.app-echo[data-for="'+r._id+'"] .app-listview .dv-item .ui-btn').first(),t.lastTouch(!1),l){if(nt(r))return}else a?u.tap(a,"highlight"):e(c);t.lastTouch(!0);u.viewStyle().match(/(Grid|List|Cards)/)&&(r.inlineEditing()||r.inlineEditing(f,!i.editor),v=n.frame(),n.sync({dataView:r,elem:c.find("app-field-"+r._fields[0].Name)}),l||t.makeVisible(v),r.session("inlineEditor",i.editor))}else r.inlineEditing(f),n.detach();t.scrollGrid(r,!0);l?(r._autoNewRow=!0,u.pageIndex(Math.ceil(r._totalRowCount/r._pageSize)-1),u._reset=!0,u.refresh()):r.sync()}).on("vclick",'.app-form-inlineeditor [data-container="simple"] .material-icon',function(n){var t=$(n.target);return t.is(".material-icon-arrow-back")?history.go(-1):$(document).trigger($.Event("keydown",{keyCode:121,shiftKey:!0})),!1})})();