/*!
* Data Aquarium Framework - Touch UI Input & Keyboards
* Copyright 2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function rt(t,i){var p=t&&t.match(/^(.+?)\-auto$/),r,u,h,c,l,f,a,e,o,v,y;if(!i)if(p)t=p[1];else if(k("touchOnly")!==!1&&!n.pointer("touch")||t&&k(t+".enabled")===!1)return null;if(r=s[t],r&&(u=r._html,!u)){for(r._type=t,u=['<div class="app-keyboard" type="',t,'">'],h=0;h<r.length;h++){for(l=r[h],u.push('<div class="app-row">'),c=0;c<l.length;c++)f=l[c],e=f.key||"",macro=f.macro,o=f.hint,y=f.alt,v=f.text,typeof e=="function"&&(e=e()),a=f.icon,u.push('<span data-draggable="keyboard-key" class="app-key ',f.accent?" app-accent":"",o?" app-has-hint":"",e.length===1&&!o||y?" app-simple":"",'" data-key="',e,'"',y?' data-alt="'+y+'"':"",macro?' data-macro="'+macro+'"':"",' style="',"width:",100/l.length,"%",'">',a?'<i class="material-icon">'+a+"<\/i>":"",a?"":'<span class="app-text',v?" app-text-small":"",'">'+(v?v:e)+"<\/span>",o?'<span class="app-hint">'+(typeof o=="string"?o:"&nbsp;")+"<\/span>":"","<\/span>");u.push("<\/div>")}u.push('<div class="app-row app-row-controls"><span data-draggable="keyboard-key" class="app-key" data-key="Escape" style="width:',100/r[0].length,'%"><i class="material-icon">expand_more<\/i><\/span><\/div>');u.push("<\/div>");r._html=u.join("")}return r}function gt(t){var u=$(t.target),i=u.data("type"),r;return r=rt(i),r&&!n.pointer("pen")?(i=r._type,e.keyboard(function(){yt("kbd-"+i,r._html,{input:u,inputPage:f().data({"last-focused-field":null}),inputValue:t.inputValue,inputValueRaw:t.inputValueRaw,inputDataType:t.inputDataType,inputMaxLength:t.inputMaxLength,placeholder:t.placeholder,inline:n.dataView()._inlineEditor,format:t.inputFormat,type:i})}),!1):void 0}function lt(n){return n+'<span class="app-cursor">|<\/span>'}function u(){return $(".app-modal-keyboard")}function b(n){return(n||u()).is(".app-modal-keyboard-bottom")}function k(t){return n.settings("ui.keyboard."+t)}function ut(){var t=f(".app-keyboard .app-key .app-hint"),n=0,i=0,r;t.each(function(){var t=$(this),r=o(t),u=t.prev(),f=r.width,e=Math.ceil(r.left-o(u).left);f>n&&(n=Math.ceil(f));e>i&&u.text().length===1&&(i=e)});n&&(r=t.first().parent().width(),t.each(function(){$(this).width(n).prev().css("margin-left",(r-i-n)/2)}))}function at(){ut();d("sync")}function d(t){var f=$(".app-page-modal-glass-pane"),r=f.find(".app-inner"),u,i;if(t===!0)r.length||it("app-inner-scroller").appendTo(it("app-inner").appendTo(f).css("right",-n.scrollable("scrollbar").width)),d("sync");else if(t===!1)r.remove();else if(u=h(),u&&!u.inline){i=n.scrollable(u.inputPage);r.find(".app-inner-scroller").height(i[0].scrollHeight-i.height()+p.height());r.data("target",i).off("scroll",vt).scrollTop(i.scrollTop()).on("scroll",vt)}}function vt(){var n=$(this);cancelAnimationFrame(ht);ht=requestAnimationFrame(function(){n.data("target").scrollTop(n.scrollTop())})}function g(t,i,r){var f=n.scrollable(i),u=o(i),e=o(t),s=o(f),h=f.scrollTop();u.top<s.top?(f.scrollTop(h-(s.top-u.top+12)),u=o(i),u.bottom>e.top&&f.scrollTop(f.scrollTop()-(e.bottom-u.top+4))):b(t)?u.bottom>e.top&&f.scrollTop(h+(u.top-e.top+u.height+12)):s.top>u.top?(f.scrollTop(h-(s.top-u.top)-12),r&&n.resetPageHeight(t)):s.bottom<u.bottom?(f.scrollTop(h+(u.bottom-s.bottom)+12),r&&n.resetPageHeight(t)):e.top<=u.top&&u.top<=e.bottom&&(f.scrollTop(h+(u.bottom-e.top)+12),u=o(i),u.bottom>e.top&&u.bottom<e.bottom&&f.scrollTop(f.scrollTop()-(e.bottom-u.top+4)))}function ni(t){function a(){r.css({transform:"",transition:""});l.addClass("app-has-keyboard");c||n.isInTransition(!1);n.scrollable("focus")}var f=n.hasFocus(t.input),o=t.inputPage,s=f.find(".app-control-inner"),v=t.value,h,r=u(),e,c;if(beforeFocusEvent=$.Event("beforefocus.keyboard.app",{keyboardPage:r,inputPage:o,context:t,input:f}),f.trigger(beforeFocusEvent),ut(),f.find(".app-cursor").length||f.data("originalHtml",s.html()),h=t.inputValueRaw==null&&t.placeholder?'<span class="app-cursor">|<\/span><span class="app-placeholder">'+i.htmlEncode(t.placeholder)+"<\/span>":lt(v),s.html(h),e=o.find(".app-stub-keyboard"),e.length||(e=it("app-stub-keyboard").insertAfter(f.closest("[data-layout]"))),e.height(t.inline?0:Math.max(e.height(),r.outerHeight())),g(r,f,!0),$(".app-page-modal-glass-pane").insertBefore(r),d(!0),o.data("keepKbdOpen"))o.removeData("keepKbdOpen"),l.addClass("app-has-keyboard");else if(c=n.isInTransition(),n.isInTransition(!0),r.css("visibility",""),b(r)&&!l.is(".app-has-keyboard")){r.css("transform","translate3d(0,100%,0)").one("transitionend",a);setTimeout(function(){r.css("transition","transform 150ms ease-out");setTimeout(function(){r.css("transform","")})})}else{r.css("transform","scale(.75)").one("transitionend",a);setTimeout(function(){r.css("transition","transform 150ms ease-out");setTimeout(function(){r.css("transform","")})})}}function ti(t){function ft(){l.removeClass("app-has-keyboard");d(!1);u().css("visibility","hidden");w.find(".app-stub-keyboard").remove();n.scrollable("refresh");it()||v.trigger("keyboardclosed.app")}function it(){return r&&!n.isInTransition()&&(tt?setTimeout(e.move,0,i,s==="down"?"right":"left",8):h?setTimeout(e.focus,0,{fieldName:r}):setTimeout(e.move,0,i,s,13)),r}var a=t.value,o,i=t.input,w=t.inputPage,k,g,s=t.shift?"up":"down",r=t.enter||t.tab,tt=t.inline,h,c,ut;if(p.off("throttledresize",at).off("blur",wt).off("focus",bt),v.off("keydown",pt),t.shift=t.tab=t.enter=!1,a!=t.inputValue){if(o=e.triggerSetValue(t.input,a,t.inputValue),!o.inputValid){n.vibrate();e.valid(!0);n.notify({text:o.inputError,force:!0});yt(null,null,t);return}}else k=i.find(".app-control-inner"),g=i.data("originalHtml"),i.removeData("originalHtml"),k.html(g);if(n.hasFocus(i,!1),r&&!tt&&(h=typeof r=="string",c=h?f('[data-control="field"][data-field="'+r+'"]').first():e.move(i,s,13,null,!0),ut=rt($(c).data("type")),ut)){u().data("mini")?l.removeClass("app-has-keyboard"):(w.data("keepKbdOpen",!0),i.is(c)&&!b()&&n.whenPageShown(function(){y(nt)}));it();return}y(ft)}function y(n){function i(){t.css({transform:"",transition:""});n()}var t=u();if(b()&&!t.data("mini")){t.css({transition:"transform 100ms ease-in"}).one("transitionend",i);setTimeout(function(){t.css("transform","translate3d(0, 100%,0)")})}else t.fadeOut(100,i)}function yt(t,r,u){n.whenPageShown(function(){ni(u);p.on("throttledresize",at);v.on("keydown",pt);n.whenPageShown(function(){n.stickyHeaderBar().hide();setTimeout(ti,0,u)})});p.on("blur",wt).on("focus",bt);t?(u.value=u.inputValue,i.survey({controller:t,context:u,topics:[{questions:{name:"k"}}],options:{modal:{fitContent:!0,always:!0,max:n.toWidth("tn"),title:!1,tapOut:!0,dock:"top",background:{transparent:!0,clear:f().is(".app-reading-pane-master,.app-reading-pane-detail")},keyboard:!0},transition:!1,actionButtons:!1,discardChangesPrompt:!1,contentStub:!1,trackContent:!0},layout:r})):c(1)}function ii(t){var i=t.rect,v=i.page,e=i.dataView,s,u,f,h,c,r,a;if(e&&e.tagged("modal-keyboard")){if(c=e.data("survey"),s=c.input,s.parent().length){if(u=o(s),!u.width)return;r=n.screen();h=r.width<n.toWidth("sm");f=v.toggleClass("app-modal-keyboard-bottom",h).find(".app-keyboard");i.height=f.length?f.outerHeight():1;h?(i.left=r.left,i.width=r.width,i.height=f.outerHeight(),i.right=r.right,i.top=r.top+r.height-i.height):(i.left=u.left,a=v.find(".app-keyboard"),a.length&&(i.left+=l.is(".app-input-focus-outline")?-2:parseFloat(a.css("padding-left"))-1),i.top=u.bottom+12,i.width=k(c.type+".width")||360,i.top+i.height-1>r.top+r.height-1&&(i.top=u.top-i.height-5),i.left+i.width-1>r.left+r.width-1&&(i.left=r.left+r.width-1-i.width),(i.top<r.top||i.top+i.height-1>r.top+r.height-1)&&(i.bottom=r.top+r.height-1,i.top=i.bottom-i.height+1))}return!1}}function h(){var t=n.dataView(),i=t&&t._survey;return i?i.context:null}function ft(n){var t=[],i=h(),r=i.input,u,o=i.placeholder,e;return r.find(".app-control-inner").contents().each(function(){var n=$(this);n.is(".app-cursor,.app-placeholder")||t.push(n.text())}),t=t.join(""),e=!t.length,r.toggleClass("app-null",e),n&&o&&(e?(u=r.find(".app-control-inner"),u.find(".app-placeholder").length||ct("app-placeholder").text(o).appendTo(u)):r.find(".app-control-inner .app-placeholder").remove()),n&&i.change&&setTimeout(function(){i.change({input:r,value:t,keyboardPage:f(),inputPage:i.inputPage,context:i})}),t}function et(n,t,i){var v=n.find(".app-control-inner"),p=v.contents(),u=p[i==="before"?0:2],r,e,y,o,c,l,f;if(u&&u.nodeType===3||(u=$(document.createTextNode("")),i==="before"?u.insertBefore(n.find(".app-cursor")):u.appendTo(v),u=u[0]),r=u.nodeValue,r==null&&(r=""),t==null?r=null:t.length?t==" "&&r.endsWith(" ")||(r+=t):r=r.substring(0,r.length-1),e=n.data("type"),y=s[e],e==="number"&&y&&k(e+".format")&&(o=h().format,o)){if(c=String.localeFormat(o,0),l=c.indexOf(a),r=r.replace(/\D/g,""),l>=0)if(f=c.length-l-1,t===a)for(r+=a;f--;)r+="0";else r.length<f+2&&(r="0"+r),r=r.substring(0,r.length-f)+a+r.substring(r.length-f);r=Number.parseLocale(r);r=r==0&&t!==a?t==="0"?"0":"":String.localeFormat(o,r)}u.nodeValue=r}function nt(){u().data("mini",!0).css("visibility","hidden");h().inputPage.find(".app-stub-keyboard").height(0)}function c(t){n.isInTransition(!0);history.go(t||-1)}function pt(t){function l(){return s.find("[data-key] .app-text").filter(function(){return $(this).text().toLowerCase().startsWith(r.toLowerCase())}).first().parent()}var s=$(this),r=t.key,i,e=h(),o;if(!e||n.isInTransition())return!1;if(i=l(),i.length||(i=s.find('[data-key="'+r+'"]')),i.length||r.length!==1||(o=f("[data-alt]"),o.length&&(w._insert({target:o},0),i=l(),(!i.length||i.is("[data-alt]"))&&w._insert({target:f("[data-alt]")},0))),!i.length||t.ctrlKey||t.altKey){if(r=="ArrowDown"&&t.altKey)return u().data("mini")?(e.enter=e.input.data("field"),c()):y(nt),!1;if(r.match(/Tab|Arrow(Up|Down)/))return e.tab=!0,e.shift=t.shiftKey||r==="ArrowUp",c(),!1}else return i.addClass("app-dragging"),w._insert({target:i},0),clearTimeout(i.data("timeout")),i.data("timeout",setTimeout(function(){i.removeClass("app-dragging")},150)),!1}function ri(t){if(n.pointer("touch")){var u=$(t.target),r=i.input.elementToField(u),h=r._dataView,c=h.editRow()[r.Index],l={inputContainer:u,field:r,dataView:h,modal:!0,date:c},o=u.find(".app-cursor"),s;if(!r.tagged("calendar-input-disabled"))return e.keyboard(function(){n.CalendarInput("attach",l);n.CalendarInput("focus",l);o.length||(s=u.find(".app-control-inner"),o=ct("app-cursor").text("|"),r.Watermark&&c==null?o.insertBefore(s.contents()):o.appendTo(s));n.tooltip(!1);f().removeData("lastFocusedField")}),!1}t.dataType=null}function wt(){u().data("mini")||y(nt)}function bt(){if(u().data("mini")){var n=h();n.enter=n.input.data("field");c()}}var i=$app,e=i.input,n=i.touch,v=$(document),p=$(window),l=$("body"),o=i.clientRect,ot=i.elementAt,kt=Web.DataViewResources,t=kt.Mobile.Keyboard.TelHints,dt=Sys.CultureInfo.CurrentCulture,st=dt.numberFormat,a=st.NumberDecimalSeparator,f=n.activePage,s=i.keyboard(),w,ht,tt,r=i.html,ui=r.tag,fi=r.div,ei=r.span,oi=r.$tag,si=r.$p,it=r.$div,ct=r.$span,hi=r.$a,ci=r.$i,li=r.$li,ai=r.$ul;s.number=[[{key:"1"},{key:"2"},{key:"3"},{key:"-"}],[{key:"4"},{key:"5"},{key:"6"},{key:" ",icon:"space_bar"}],[{key:"7"},{key:"8"},{key:"9"},{key:"Backspace",icon:"backspace"}],[{key:function(){return st.NumberGroupSeparator}},{key:"0"},{key:function(){return a}},{key:"Enter",icon:"keyboard_return",accent:!0}]];s.pin=[[{key:"1",hint:t.Key1},{key:"2",hint:t.Key2},{key:"3",hint:t.Key3},],[{key:"4",hint:t.Key4},{key:"5",hint:t.Key5},{key:"6",hint:t.Key6},],[{key:"7",hint:t.Key7},{key:"8",hint:t.Key8},{key:"9",hint:t.Key9},],[{key:"Backspace",icon:"backspace"},{key:"0",hint:!0},{key:"Enter",icon:"keyboard_tab",accent:!0,hint:!0}]];s.tel=[[{key:"1",hint:t.Key1},{key:"2",hint:t.Key2},{key:"3",hint:t.Key3},{key:"-"}],[{key:"4",hint:t.Key4},{key:"5",hint:t.Key5},{key:"6",hint:t.Key6},{key:" ",icon:"space_bar"}],[{key:"7",hint:t.Key7},{key:"8",hint:t.Key8},{key:"9",hint:t.Key9},{key:"Backspace",icon:"backspace"}],[{key:"*",alt:"tel_alt",text:"* #",hint:!0},{key:"0+",hint:!0},{key:"."},{key:"Enter",icon:"keyboard_return",accent:!0}]];s.tel_alt=[[{key:"("},{key:"/"},{key:")"},{key:"-"}],[{key:"N"},{key:",",text:"Pause"},{key:","},{key:" ",icon:"space_bar"}],[{key:"*"},{key:";",text:"Wait"},{key:"#"},{key:"Backspace",icon:"backspace"}],[{key:"1",alt:"tel",text:"123"},{key:"+"},{key:"."},{key:"Enter",icon:"keyboard_return",accent:!0}]];i.keyboard=function(){var n=arguments;return n.length&&(s[n[0]]=n[1]),s};w=i.dragMan["keyboard-key"]={start:function(n){var t=n.target;String.isNullOrEmpty(t.attr("data-key"))?n.cancel=!0:(n.dir="all",t.addClass("app-dragging"))},move:function(){},end:function(n){this.cancel(n)},cancel:function(n){(!n.moved||ot().closest(".app-dragging").length)&&this._insert(n,0);n.target.removeClass("app-dragging")},taphold:function(n){var t=this._insert(n,1);return t!==!1&&(n.ignore=!0),t},_insert:function(t,i){if(!t.ignore){var u=h(),e=u.input,a=u.inputMaxLength,s=t.target,r=s.attr("data-key"),l=s.attr("data-macro"),v=s.attr("data-alt"),p,o=f();if(v&&!i)p=rt(v,!0),f("[data-layout]").html(p._html),ut(),n.resetPageHeight();else{if(l)return l==="$clear"?et(e,null,"before"):e.find(".app-control-inner").html(lt(l)),u.value=ft(!0),g(o,e),!1;if(r==="Backspace")return et(e,"","before"),u.value=ft(!0),g(o,e),!1;if(r==="Enter")u.enter=!0,c();else if(r==="Escape")o.data("mini")?c():y(nt);else if(r==="Paste")n.notify({text:"paste"});else if(!i||r.length>1)(!a||u.value.length<a)&&(r=r.charAt(Math.min(r.length-1,i)),et(e,r,"before"),u.value=ft(!0),g(o,e));else return!1}}}};v.on("getpagerect.app",ii).on("showvalue.input.app","[data-type]",gt).on("showvalue.input.app",'[data-type="datetime"],[data-type="date"]',ri).on("touchstart pointerdown mousedown",".app-page-modal-glass-pane .app-inner",function(){tt=n.lastTouch()}).on("vclick",".app-page-modal-glass-pane .app-inner",function(t){var e,o,s=t.pageX,l=t.pageY,r,i,f,a;if(Math.abs(tt.x-s)<11&&Math.abs(tt.y-l)<11){if(e=$(this).parent().css("visibility","hidden"),o=$(".app-page-modal-background").css("visibility","hidden"),r=ot(s,l),i=r.closest("[data-field]"),o.css("visibility",""),e.css("visibility",""),i.length)f=h(),a=f.inputPage,i.closest(".ui-page").is(a)&&(f.enter=i.data("field"));else if(u().data("mini")||u().is(".app-modal-keyboard-bottom"))v.one("keyboardclosed.app",function(){n.invokeInTargetPage(function(){r.trigger("vclick")})});c()}return!1})})();