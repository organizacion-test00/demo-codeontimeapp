/*!
* Data Aquarium Framework - Core
* Copyright 2008-2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function ui(n,t,i){return"<"+n+(t?' class="'+t+'"':"")+(i&&!i.match(/^</)?" "+i:"")+">"+(i&&i.match(/^</)?i:"")+"<\/"+n+">"}function uu(n,t){return ui("div",n,t)}function fu(n,t){return ui("span",n,t)}function a(n,t,i){return $(ui(n,t,i))}function ir(n,t){return a("p",n,t)}function rr(n,t){return a("div",n,t)}function yt(n,t){return a("span",n,t)}function fi(n,t){return a("a",n,t)}function eu(n,t){return a("i",n,t)}function ou(n,t){return a("li",n,t)}function su(n,t){return a("ul",n,t)}function y(n){t&&t.busy(n)}function pi(n,t,i,r){return{get_statusCode:function(){return i?i.status:null},get_timedOut:function(){return!1},get_exceptionType:function(){return r||t&&t.ExceptionType},get_message:function(){return t?t.message||t.Message:i&&i.message},get_stackTrace:function(){return t?t.stack||t.StackTrace:""}}}function h(n){return JSON.stringify(n)}function g(n,t){return n.isInstanceOfType(t)}function wi(n){n.Type||(n.Type="String");n.Type!=="DataView"||t||(n.Hidden=!0);bi(n,tu,!0);bi(n,iu,0);var i=n.HeaderText||n.Label||n.Name,r=n.Tag,u=r&&r.match(/survey-(form|data)+/);i==="$blank"&&(i="&nbsp;");n.HeaderText=i;u&&(n.Tag+=" input-type-"+u[0].replace("-",""));n.Items==null&&(n.Items=[])}function bi(n,t,i){for(var u,r=0;r<t.length;r++)u=t[r],n[u]==null&&(n[u]=i)}function ur(n,t){if(!t){var i=Web.Menu.Nodes;for(var r in i)t=i[r]}return $(t).each(function(){var t=this;return n.apply(t)==!1?!1:t.children&&!ur(n,t.children)?!1:void 0}),!0}function fr(){var n=!1;return ur(function(){if(this.url&&this.url.match(/\/membership(\.aspx)?$/i))return n=!0,!1}),n}function ei(){var n=it.HoverMonitor,t=n&&n._instance;t&&t.close()}function oi(){return t&&t.kiosk()}function nt(n){return parseInt(n,10)}function hu(i){for(var h=i.coords,e=n.Geo={latitude:h.latitude,longitude:h.longitude,acquired:!0},c=null,u=0,f=n.GeoQueue,r,s;u<f.length;)if(r=o(f[u].dv),r==null||r._geoCookie!==f[u].cookie)f.splice(u,1);else if(!r._busy()){if(s=r.findField(f[u].field),c=s.tagged("modified-latitude","created-latitude")?e.latitude:s.tagged("modified-longitude","created-longitude")?e.longitude:e.latitude+","+e.longitude,r.editing())try{t?n.input.execute({dataView:r,values:[{Name:s.Name,NewValue:c}],raiseCalculate:!1}):r._updateCalculatedFields(result)}catch(l){t&&t.notify("Unable to update geolocation.")}u++}!f.length&&vt&&(ii.clearWatch(vt),vt=null)}function er(n,t){t.splice(0,0,[null,n.tagged("lookup-null-value-any")?b.AnyValue:n.tagged("lookup-null-value-placeholder")?n.Watermark:yi])}function or(n){return n instanceof jQuery&&(n=n[0]),n?n.getBoundingClientRect():{width:0,height:0}}function cu(n){var i=arguments,r=i.length;return r?r===2&&(n={x:i[0],y:i[1]}):n=t.lastTouch(),$(document.elementFromPoint(n.x,n.y))}function lu(n){return n&&n.getTimezoneOffset&&!isNaN(+n)}function sr(n){return n.left==null&&n.x==null&&(n=or(n)),n.right==null&&(n={left:n.x,top:n.y,right:n.x,bottom:n.y}),n}function hr(n,t){return n.Handler&&(t.Handler=n.Handler),n.session&&(t.session=n.session),t}function cr(n){var t=null;return $(n).each(function(){var n=this;return n.selected?(t=n,!1):n.children&&(t=cr(n.children),t)?!1:void 0}),t}function lr(n,t){$(t).each(function(){var t=this,i=t.url,f,r,e=$("<li/>").appendTo(n),u;i?(r=i.match(/^(_\w+):(.+)$/),r&&(i=r[2],f=r[1]),u=$("<a/>").attr({href:i,title:t.description,target:f})):u=$("<span/>");u.appendTo(e).text(t.title);t.children&&lr($("<ul/>").appendTo(e),t.children)})}function ar(n){n.format=_field_format;n.toColumns=_field_toColumns;n.isReadOnly=_field_isReadOnly;n.isNumber=_field_isNumber;n.lov=_field_lov;n.text=_field_text;n.trim=_field_trim;n.htmlEncode=_field_htmlEncode}function vr(t,i){return i!==!1?t.replace(n._dateRegex,'Date.fromUTCString("$1")'):t}function pt(t,i,r){var e,o=i.commandName||i.CommandName,s=i.commandArgument||i.CommandArgument,c=i.path||i.Path||"",f,u=n.rules[t._controller],h;if(u&&(r||(u=u.after),u)){if(o in u?(u=u[o],s&&s in u&&(u=u[s])):c&&(f=c.split(/\//),f[0]in u&&(u=u[f[0]]),f.length>1&&f[1]in u&&(u=u[f[1]])),typeof u=="function"){if(r&&t.editing()&&(h=t._createArguments(i),t._validateFieldValues(h.Values,i.causesValidation,!1),o!=="Calculate"&&!t.validate(h.Values)))return!1;e=u(t,i)}e===!1&&(e=!0)}return e}function yr(n){for(var i=[],u=0,o=/\$(row|master|context)\s*\.\s*(\w+)(\s*=(=|(\s*([\S\s]+?)\s*;)))?/gm,t,r,f,e;t=o.exec(n);)r=t[1],f=t[2],e=t[6],i.push(n.substr(u,t.index-u)),r==="row"&&(r=null),e?i.push(String.format('_this.updateFieldValue("{0}",{1},"{2}");',f,yr(e),r)):(i.push(String.format('_this.fieldValue("{0}"{1})',f,r?',"'+r+'"':"")),t[4]==="="&&i.push("==")),u=t.index+t[0].length;return u<n.length&&i.push(n.substr(u)),i.join("").replace(/\$(row|master|context)/g,'_this.dataView().data("$1")')}function hi(i,r,u){function o(t,u,f){for(var l=n.blobFields[t],c,h,e=0;e<l.length;e++)if(c=i.findField((f&&r||"")+l[e]),c){h=c;break}h?(s.push({Name:h.Name,NewValue:u}),h._blobField=t+":"+r):f&&o(t,u)}var e=i._pendingUploads,h,f,c={Values:[],Errors:[]},s=c.Values;e||(e=i._pendingUploads=[]);$(e).each(function(n){var t=this;if(t.fieldName===r)return h=!0,t.layers=null,u?t.files=u:(t.files=null,e.splice(n,1)),!1});!h&&u&&e.push({fieldName:r,files:u});u&&(f=u[0]);o("name",f?f.name:null,!0);o("type",f?f.type:null,!0);o("size",f?f.size:null,!0);s.length&&(t?(n.input.execute({dataView:i,values:s}),n.input.focus({fieldName:r})):i._updateCalculatedFields(c))}function pr(n,i){return $(t?t.page(n._id):n._container).find(".drop-box-"+i.Index)}function wr(n){if(n==null)return"";var t,i;return n>1024?n>1e6?(t=n>1e7?n>1e8?"{0:N0}":"{0:N1}":"{0:N2}",n/=1048576,i=l.MB):(t=n>10240?n>102400?"{0:N0}":"{0:N1}":"{0:N2}",n/=1024,i=l.KB):(t="{0}",i=l.Bytes),String.format(t,n)+" "+i}function br(n,t){if(n.match(new RegExp("["+Unicode.Ll+"]"))&&n.match(new RegExp("["+Unicode.Lu+"]"))){n=n.split(/(?:(\d+))/).join(" ");for(var f=new RegExp("["+Unicode.Lu+"]+","g"),r=[],u=0,i=f.exec(n);i;)r.push(n.substr(u,i.index-u)),r.push(" ",i[0]),u=i.index+i[0].length,i=f.exec(n);r.push(n.substr(u));n=r.join("")}return n=n.replace(/[_\s]+/g," ").trim(),t&&(n=n.charAt(0).toUpperCase()+n.slice(1)),n}var r,st,n,lt,v,wt,si;Type.registerNamespace("Web");var s=window,bt=$(s),tt=$(document),it=s.Web,c=Sys,ht=c.Application,et=c.StringBuilder,ci="",kt,ft=c.Browser,ki=/\{([\s\S]+?)\}/,di=c.CultureInfo.CurrentCulture,u=di.dateTimeFormat,e=it.DataViewResources,b=Web.DataViewResources.Data,li=b.Filters,dt=li.Labels,gt=e.HeaderFilter,kr=e.ModalPopup,ai=e.Pager,ut=e.Mobile,l=ut.Files,rt=e.Validator,ni=e.Actions.Scopes,ti=e.Grid,at=e.ODP,vi=e.Editor,dr=ti.PerformAdvancedSearch,gr=dt.Clear,yi=b.NullValueInForms,nu=b.NullValue,gi=dt.And,nr=ni.Form.Update.WhenLastCommandName.BatchEdit,tu=["AllowQBE","AllowSorting","FormatOnClient","HtmlEncode"],iu=["Len","Rows","Columns","Search","ItemsPageSize","Aggregate","OnDemandStyle","TextMode","MaskType","AutoCompletePrefixLength","CategoryIndex"],ru=["Fields","Views","Categories","ActionGroups","Filter"],tr={},p,o,w,k,f,t,ot,d,ii,vt,ct,ri={};it.DataViewMode={View:"View",Lookup:"Lookup"};it.DynamicExpressionScope={Field:0,ViewRowStyle:1,CategoryVisibility:2,DataFieldVisibility:3,DefaultValues:4,ReadOnly:5,Rule:6};it.AutoHideMode={Nothing:0,Self:1,Container:2};it.DynamicExpressionType={RegularExpression:0,ClientScript:1,ServerExpression:2,CSharp:3,VisualBasic:4,Any:4};it.DataViewAggregates=["None","Sum","Count","Avg","Max","Min"];it.FieldSearchMode={Default:0,Required:1,Suggested:2,Allowed:3,Forbidden:4};et.prototype.appendFormat=function(){this.append(String._toFormattedString(!1,arguments))};r=String.isNullOrEmpty=function(n){return n==null||!n.length};st=String.isBlank=function(t){return t==null||typeof t=="string"&&t.match(n._blankRegex)!=null};String._wordTrimRegex=/(\S{16})\S+/g;String._tagRegex=/<\/?\w.*?>/g;String.trimLongWords=function(n,t){var r,e;if(n==null)return n;if(r=this._wordTrimRegex,t!=null&&(r=new RegExp(String.format("(\\S{{{0}}})\\S+",t),"g")),e=n.replace(r,"$1..."),n.match(String._tagRegex)){for(var u=new et,o=String._tagRegex,i=o.exec(n),f=0;i;)tag=i[0],i.index>0&&u.append(n.substring(f,i.index).replace(r,"$1...")),f=i.index+tag.length,u.append(tag),i=o.exec(n);f<n.length&&u.append(n.substring(f));e=u.toString()}return e};String.htmlEncode=function(t){return typeof t=="string"&&t.match(n._htmlTest)?t:n.htmlEncode(t)};String.isJavaScriptNull=function(n){return n==="%js%null"||n==="null"};String.jsNull="%js%null";it.DataView=function(t){var i=this;n.initializeBase(i,[t]);i._controller=null;i._viewId=null;i._servicePath=null;i._baseUrl=null;i._pageIndex=-1;i._pageSize=ai.PageSizes[0];i._sortExpression=null;i._filter=[];i._externalFilter=[];i._categories=null;i._fields=null;i._allFields=null;i._rows=null;i._totalRowCount=0;i._firstPageButtonIndex=0;i._pageCount=0;i._views=[];i._actionGroups=[];i._selectedKey=[];i._selectedKeyFilter=[];i._lastCommandName=null;i._lastViewId=null;i._lookupField=null;i._filterFields=null;i._filterSource=null;i._mode=Web.DataViewMode.View;i._lookupPostBackExpression=null;i._domFilterSource=null;i._selectedKeyList=[];i._pageSizes=ai.PageSizes};n=Web.DataView;n.cache={};n.functions={};n.syncMap={notify:function(n){var t=this[n],i;if(t)for(i in t)t[i]=!0}};n.rules={};s.$app=s.$appfactory=n;n.html={tag:ui,div:uu,span:fu,$tag:a,$p:ir,$div:rr,$span:yt,$a:fi,$i:eu,$li:ou,$ul:su};RegExp.escape=function(n){return n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")};n._blankRegex=/^\s*$/;n._fieldMapRegex=/(\w+)\s*=\s*(\w+)/g;n._fieldFilterRegex=/([\w.,]+):([\s\S]*)/;n._filterRegex=/(\*|~|\$\w+\$|=|~|>=?|<(=|>){0,1})([\s\S]*?)(\0|$)$/;n._filterIteratorRegex=/(\*|~|\$\w+\$|=|~|>=?|<(=|>){0,1})([\s\S]*?)(\0|$)/g;n._keepCapitalization=/^\$(month|quarter|true|false)/;n._listRegex=/\$and\$|\$or\$/;n._simpleListRegex=/\s*,\s*/;n._htmlTest=/<\w+.*?>|&#?\w+;/;n._numericTypeRegex=/^(Byte|Currency|Decimal|Double|Int\d+|Single|SByte|UInt\d+)$/;Array.isArray||(Array.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"});n.cssToIcon=function(n){var t=n&&n.match(/glyphicon-([\w-]+)/);return t?"glyphicon "+t[0]:n};n.toHexString=function(t){if(t){var i=["0x"];Array.isArray(t)||(t=t.toString().split(n._simpleListRegex));$(t).each(function(){i.push(parseInt(this).toString(16))});t=i.join("")}return t};n.online=function(){return navigator.onLine===!0};n.htmlEncode=function(n){return n!=null&&typeof n!="string"&&(n=n.toString()),n?n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):n};n.htmlToText=function(t){var i=n._htmlConverter;return i||(i=n._htmlConverter=ir()),i.html(t.replace(/></g,"> <")).text()};n.toAjaxData=function(t){return n.htmlEncode(h(t))};n.htmlAttributeEncode=function(n){return n!=null&&typeof n=="string"?n.replace(/\x27/g,"&#39;").replace(/\x22/g,"&quot;"):n};n.pageVar=function(t,i){var r=location.pathname,u;if(ot&&(u=r.match(/apps\/(.+?)\/(.+?)(\.html)?$/),u&&(r=u[2])),t=r.replace(/\W/g,"_").toLowerCase()+"_"+t,arguments.length===1)return n.userVar(t);n.userVar(t,i)};n.sessionVar=function(n,t){try{if(arguments.length===1)return JSON.parse(sessionStorage.getItem(n));sessionStorage.setItem(n,h(t))}catch(i){}};n.userVar=function(t,i){if(ci||(ci=__settings.appInfo.replace(/\W/g,"_")),ot||(t=ci+"_"+t),arguments.length===1){try{return i=n.storage.get(t),i!=null&&(i=JSON.parse(i)),i}catch(r){}return null}if(i==null)n.storage.remove(t);else try{n.storage.set(t,h(i))}catch(r){}};n.isIE6=ft.agent==ft.InternetExplorer&&ft.version<7;n.agent={};n.clientRect=or;n.elementAt=cu;n.getScript=function(t,i){function l(){e--;e<=0&&(r.forEach(function(n){n()}),ri[t]=!0)}function v(){e--;e<=0&&l()}var o,f=i.also,s,r,u,e=1,h,c=/\[min\]\./;o=typeof i=="function"?i:i.then;t.match(/\.(js|css)$/)||(t=t+"."+n.jsExt());t.match(c)&&(t=n.jsExt().match(/^js/)?t.replace(c,""):t.replace(c,"min."));t=n.resolveClientUrl(t);r=ri[t];r==null&&$('script[src="'+t+'"]').length&&(r=ri[t]=!0);r===!0?o():r!=null?r.push(o):(r=ri[t]=[o],f&&(Array.isArray(f)||(f=[f]),n.agent.ie||(e+=f.length),f.forEach(function(t){n.getScript(t,v)})),h=t.match(/\.js(\?|$)/),s=document.head,s.append&&!n.host?(h?(u=document.createElement("script"),u.src=t):(u=document.createElement("link"),u.href=t,u.rel="stylesheet"),u.onload=l,s.append(u)):h?$.ajax({type:"GET",dataType:"script",cache:!0,url:t}).then(l):a("link","",'href="'+t+'" rel="stylesheet" ').appendTo("head"))};n.prototype={get_controller:function(){return this._controller},set_controller:function(n){this._controller=n},useCase:function(n){return this.get_useCase()===n},get_useCase:function(){return this._useCase},set_useCase:function(n){this._useCase=n},get_survey:function(){return this._survey},set_survey:function(n){this._survey=n},get_viewId:function(){var n=this,t=n._viewId,i=n._views;return!t&&i.length>0&&(t=n._viewId=i[0].Id),t||""},set_viewId:function(n){this._viewId=n},get_newViewId:function(){return this._newViewId},set_newViewId:function(n){this._newViewId=n},get_servicePath:function(){return k||(k=s.__servicePath),this._servicePath||(typeof k=="string"?k:"")},set_servicePath:function(t){this._servicePath=this.resolveClientUrl(t);n._servicePath||(n._servicePath=t)},get_baseUrl:function(){return w||(w=s.__baseUrl),this._baseUrl||(typeof w=="string"?w:"")},set_baseUrl:function(t){t==="~"&&(t="/");this._baseUrl=t;n._baseUrl||(n._baseUrl=t)},get_siteUrl:function(){var t=this.get_servicePath(),n=t.match(/(^.+?\/)\w+\/\w+\.asmx/);return n||(n=t.match(/(^.+?\/)appservices\/_invoke$/)),n?n[1]:""},resolveClientUrl:function(t){return n.resolveClientUrl(t,this.get_baseUrl())},get_hideExternalFilterFields:function(){return this._hideExternalFilterFields!=!1},set_hideExternalFilterFields:function(n){this._hideExternalFilterFields=n},get_backOnCancel:function(){return this._backOnCancel==!0},set_backOnCancel:function(n){this._backOnCancel=n},get_confirmContext:function(){return this._confirmContext},set_confirmContext:function(n){this._confirmContext=n},get_startPage:function(){return this._startPage},set_startPage:function(n){this._startPage=n},get_startCommandName:function(){return this._startCommandName},set_startCommandName:function(n){this._startCommandName=n},get_startCommandArgument:function(){return this._startCommandArgument},set_startCommandArgument:function(n){this._startCommandArgument=n},get_exitModalStateCommands:function(){return this._exitModalStateCommands},set_exitModalStateCommands:function(n){this._exitModalStateCommands=n},get_showActionBar:function(){var t=this.extension(),n;return t&&(n=t.options(),n.actionBar!=null)?n.actionBar==!0:this._showActionBar!=!1},set_showActionBar:function(n){this._showActionBar=n},get_showActionButtons:function(){var n=this._showActionButtons;return n||(n=t?"Auto":"TopAndBottom",this._showActionButtons=n),n},set_showActionButtons:function(n){this._showActionButtons=n},get_showSearchBar:function(){return this._showSearchBar==!0&&!(__tf!=4)},set_showSearchBar:function(n){this._showSearchBar=n},get_searchOnStart:function(){return oi()&&(this._searchOnStart=!1),this._searchOnStart===!0},set_searchOnStart:function(n){this._searchOnStart=n;n&&this.set_searchBarIsVisible(!0)},get_searchBarIsVisible:function(){return this._searchBarIsVisible==!0},set_searchBarIsVisible:function(n){this._searchBarIsVisible=n},get_showModalForms:function(){return!0},set_showModalForms:function(){},get_showDescription:function(){var n=this.extension(),t;return n?(t=n.options(),t.description==!0):this._showDescription!=!1},set_showDescription:function(n){this._showDescription=n},get_showFirstLetters:function(){return this._showFirstLetters==!0},set_showFirstLetters:function(n){this._showFirstLetters=n},get_autoSelectFirstRow:function(){return this._autoSelectFirstRow==!0},set_autoSelectFirstRow:function(n){this._autoSelectFirstRow=n},get_autoHighlightFirstRow:function(){return this._autoHighlightFirstRow==!0},set_autoHighlightFirstRow:function(n){this._autoHighlightFirstRow=n},get_refreshInterval:function(){return this._refreshInterval},set_refreshInterval:function(n){this._refreshInterval=n},get_showViewSelector:function(){return this._showViewSelector!=!1},set_showViewSelector:function(n){this._showViewSelector=n},get_showPager:function(){var n=this._showPager;return n==null||n==!0?(n="Bottom",this._showPager=n):n==!1&&(n="None"),n},set_showPager:function(n){this._showPager=n},get_showPageSize:function(){return this._showPageSize!=!1},set_showPageSize:function(n){this._showPageSize=n},get_selectionMode:function(){return this._selectionMode},set_selectionMode:function(n){this._selectionMode=n},multiSelect:function(n){var i=this,r=i._multiSelect,u;if(arguments.length)i._multiSelect=n,t&&i.pageProp("selectionMode",n?"Multiple":"Single");else return r==null&&(u=t&&i.pageProp("selectionMode"),r=i._multiSelect=(u||i._selectionMode)=="Multiple"),r},get_pagerButtonCount:function(n){if(!this._pagerButtonCount||n){var t=ai.PageButtonCount;this.get_pageCount()>t&&(t=t-3,t<5&&(t=5));this._pagerButtonCount=t}return this._pagerButtonCount},get_pageIndex:function(){return this._pageIndex},set_pageIndex:function(n){if(this._pageIndex=n,n>=0){var t=this.get_pagerButtonCount();n>=this._firstPageButtonIndex+t?this._firstPageButtonIndex=n:n<this._firstPageButtonIndex&&(this._firstPageButtonIndex-=t,n<this._firstPageButtonIndex&&(this._firstPageButtonIndex=n));this._firstPageButtonIndex<0&&(this._firstPageButtonIndex=0);this.get_pageCount()-this._firstPageButtonIndex<t&&(this._firstPageButtonIndex=this.get_pageCount()-t);this._firstPageButtonIndex<0&&(this._firstPageButtonIndex=0)}n===-2&&(this._pageOffset=0)},get_pageOffset:function(){return this.get_isDataSheet()?this._pageOffset==null?0:this._pageOffset:0},set_pageOffset:function(n){this._pageOffset=n},get_categoryTabIndex:function(){return this._categoryTabIndex},set_categoryTabIndex:function(){},get_enabled:function(){return this._enabled==null?!0:this._enabled},set_enabled:function(n){this._enabled=n},get_showInSummary:function(){return this._showInSummary},set_showInSummary:function(n){this._showInSummary=n},get_summaryFieldCount:function(){return this._summaryFieldCount},set_summaryFieldCount:function(n){this._summaryFieldCount=n},get_showLEVs:function(){return this._showLEVs},set_showLEVs:function(n){this._showLEVs=n},get_tags:function(){return this._tag},set_tags:function(n){this._tag=n},get_tag:function(){return this._tag},set_tag:function(n){this._tag=n;this._tagList=null},get_pageSize:function(){return this._pageSize},set_pageSize:function(n){this._pagerSize=n;this._pageSize=n;this._pageOffset=0;delete this._viewColumnSettings;Array.indexOf(this._pageSizes,n)===-1&&(this._pageSizes=Array.clone(this._pageSizes),Array.insert(this._pageSizes,0,n));this._fields!=null&&this.refreshData()},get_groupExpression:function(){return this._groupExpression},set_groupExpression:function(n){this._groupExpression=n;this._checkedSortGroup=!1},get_sortExpression:function(){var t=this._sortExpression,r,u=this._groupExpression,i=0,f,e;if(!this._checkedSortGroup&&u){for(t||(t=""),this._checkedSortGroup=!0,u=u.trim().split(n._simpleListRegex),r=t.trim().split(n._simpleListRegex);i<u.length;)f=u[i],i<r.length?(e=r[i].split(/\s+/),f!==e[0]&&r.splice(i,0,f)):r.splice(i,0,f),i++;t=r.join(",");t.match(/,$/)&&(t=t.substring(0,t.length-1));this._sortExpression=t}return t},set_sortExpression:function(n){if(this._checkedSortGroup=!1,n&&n.length){var t=n.match(/^(\w+)\s*((asc|desc)|$)/i);this._sortExpression=t&&!t[2].length?r(this._sortExpression)||this._sortExpression.match(/^(\w+)\s*/)[1]!==t[1]?n+" asc":this._sortExpression.endsWith(" asc")?n+" desc":n+" asc":n}else this._sortExpression=null},set_id:function(n){this._id||(this._id=n)},get_filterSource:function(){return this._filterSource},set_filterSource:function(n){this._filterSource||(this._filterSource=n)},get_filterFields:function(){return this._filterFields},set_filterFields:function(n){this._filterFields=n},get_visibleWhen:function(){return this._visibleWhen},set_visibleWhen:function(n){this._visibleWhen=n},get_showQuickFind:function(){return this._showQuickFind!=!1},get_quickFindText:function(){return r(this._quickFindText)?ti.QuickFindText:this._quickFindText},set_quickFindText:function(n){this._quickFindText=n},get_quickFindElement:function(){return $get(this.get_id()+"_QuickFind")},set_showQuickFind:function(n){this._showQuickFind=n},get_showRowNumber:function(){return this._showRowNumber===!0},set_showRowNumber:function(n){this._showRowNumber=n},get_filter:function(){var i=this,e,s,u,f,o,r;if(i.get_lookupField()==null&&(i.get_pageIndex()==-1&&!i._allFields||i._externalFilter.length>0&&!i._filter.length)){if(i.get_domFilterSource())for(i._externalFilter=[],e=i.get_filterFields().split(n._simpleListRegex),s=i.get_domFilterSource().value.split(n._simpleListRegex),u=0;u<e.length;u++)Array.add(i._externalFilter,{Name:e[u],Value:s[u]});else if(f=n._commandLine.match(/\?([\s\S]+)/),f&&i.get_filterSource()!="None"&&i.get_filterSource()==null&&!i.get_useCase())for(i._externalFilter=[],o=/(\w+)=([\S\s]*?)(&|$)/g,r=o.exec(f[1]);r;)r[1]!="ReturnUrl"&&Array.add(i._externalFilter,{Name:r[1],Value:r[2].length==0?String.jsNull:decodeURIComponent(r[2])}),r=o.exec(f[1]);i.applyExternalFilter(i.get_isModal()||(t||i.useCase("$app"))&&i._filter)}else i.get_filterSource()=="Context"&&i._externalFilter.length>0&&i.applyExternalFilter(!0);return i._startupFilter&&(i.readContext("disableStartFilter")!=!0&&(Array.addRange(i._filter,i._startupFilter),i.writeContext("disableStartFilter",!0)),i._startupFilter=null),i._filter},set_filter:function(n){this._filter=n},get_startupFilter:function(){return this._startupFilter},set_startupFilter:function(n){this._startupFilter=n},get_externalFilter:function(){return this._externalFilter},set_externalFilter:function(n){this._externalFilter=n?n:[]},get_ditto:function(){return this._ditto},set_ditto:function(n){this._ditto=n},get_modalAnchor:function(){return this._modalAnchor},set_modalAnchor:function(n){this._modalAnchor=n},get_description:function(){return this._description},set_description:function(n){this._description=n},get_isModal:function(){return this._modalPopup!=null||this._isModal},get_categories:function(){return this._categories},get_fields:function(){return this._fields},get_rows:function(){return this._rows},data:function(n){function e(t){var i={},r=0,u=n==="filter"?t._filter:n==="combined"?t.combinedFilter():t._combinedFilter([]);return u&&u.forEach(function(n){var o=n.match(/(.+?)\:(=|<>|>=|<=|>|<|(\$\w+\$))(.*?)\0?$/),u,s,f,e;o?(u=o[1],f=o[2],e=o[4],u==="_match_"||u==="_donotmatch_"?i["_Match"+(++r).toString()]=(u==="_match_"?"$match":"$donotmatch")+f.substring(1,4):(s=t.findField(u),f.match(/\$$/)&&(f=f.substring(0,f.length-1)),r>0&&(u="_Match"+r.toString()+"_"+u),f.match(/^\$(month|quarter)\d+$/i)?(i[u+"_op2"]=f,i[u+"_op"]="all-dates-in-period"):i[u+"_op"]=f,e&&(e=e.split(/\$and\$|\$or\$/g),e.forEach(function(n,i){e[i]=t.convertStringToFieldValue(s,n)}),i[u]=e[0],f==="$between"?i[u+"_v2"]=e[1]:e.length>1&&(i[u]=e)))):n.match(/^_quickfind_:~/)&&(i.QuickFind=JSON.parse(n.substring(17)))}),i}var i=this,t,u,f,r;return n==="master"?(u=i.get_master(),t=u?u.data():null):n==="context"?(f=i.get_parentDataView(),t=f?f.data():null):n&&n.match(/^(filter|search|combined)$/)?t=e(i):n==="parameters"?($(i._searchParamValues||[]).each(function(){var n=this;n.Modified&&(r||(r={}),r[n.Name.substring(11)]=n.NewValue)}),t=r):n==="survey"?(t=i._survey,t=t?t.context:{}):t=i.survey("data",n==="modified"),t},row:function(){return this.survey("row")},values:function(){return this.survey("values")},survey:function(n,t){var i=this,r=i._survey,e=i._pendingUploads;if(n==="row")r=i.editRow(),e&&e.forEach(function(n){r[i.findField(n.fieldName).Index]=n.files});else if(n==="data"){var s=i.row(),u=t?{_modified:{}}:{},o=i._allFields,f=i._originalRow;o.forEach(function(n){var i=n.Index,r=n.Name,e;r==="sys_pk_"||r==="Status"&&i===o.length-1||(e=u[r]=s[i],t&&f&&f[i]!==e&&(u._modified[r]=f[i]))});r=u}else n==="values"&&(r=i._collectFieldValues());return r},changed:function(){var n=this,t,r=n.odp,u=n._unchangedRow,e=n._editRow,f=n._pendingUploads,i;if(arguments.length>0&&arguments[0]==="ignore"){if(i=n.changed()||r&&r.root(n)&&r.is(":dirty"),arguments.length===1)return!i||n.tagged("discard-changes-prompt-none")||n._ignoreUnsavedChanges;n._ignoreUnsavedChanges=arguments[1]}else if(n.editing())if(f&&f.length)i=!0;else if(u&&n.editing())for(t=0;t<u.length;t++)if(e[t]!==u[t]){i=!0;break}return i},editRow:function(){var t=this,i,f,n=t._editRow,r,u;return n||(t.inserting()?(n=(t._newRow||[]).slice(0),$(t._externalFilter).each(function(){var i=this,r;i&&(r=t.findField(i.name||i.Name),!r||r.IsPrimaryKey&&r.ReadOnly||n[r.Index]!=null||(n[r.Index]=i.name?i.value:i.Value))}),i=t.get_master(),i&&(u=i.editRow(),f=t.get_externalFilter(),$(f).each(function(){var e=this,o=!0,r=t.findField(e.Name),f;r&&(r.ItemsDataValueField&&(f=i.findField(r.ItemsDataValueField),f&&(o=!1,n[r.Index]=u[f.Index])),r.Index!==r.AliasIndex&&r.ItemsDataTextField&&(f=i.findField(r.ItemsDataTextField),f&&(n[r.AliasIndex]=u[f.Index])),o&&(n[r.Index]=t.convertStringToFieldValue(r,e.Value)))})),r=[],$(n).each(function(i){r[i]=t._survey?n[i]:null})):(n=t.commandRow()||[],r=n.slice(0)),n=n.slice(0),t.get_isForm()&&(t._editRow=n),t._originalRow=r),n},headerField:function(){var n=this;return headerField=n._headerField,headerField||$(n._fields).each(function(){var n=this;if(!n.Hidden&&!n.OnDemand)return headerField=n,!1}),headerField&&(headerField=n._allFields[headerField.AliasIndex]),headerField},context:function(n){var i=this,t=i._filterSource?o(i._filterSource):i.get_parentDataView(i),r,u={};if(arguments.length){if(t.get_isForm()){if(t._survey)return t.survey(n);r=t.editRow()}else r=t.get_selectedRow();return n==="row"?r:($(t._allFields).each(function(){var n=this;u[n.Name]=r[n.Index]}),u)}return t},originalRow:function(){return this._originalRow},get_selectedRow:function(){var n=this,i=n.extension();return i?t?n.row():n._selectedRow:n._rows?n._rows[n._selectedRowIndex!=null?n._selectedRowIndex:0]:[]},get_pageCount:function(){return this._pageCount},get_aggregates:function(){return this._aggregates},get_views:function(){return this._views},actionGroups:function(n){var s=this,h=[],c=s._actionGroups,i,r,u,t,e,f,o;for(typeof n=="string"&&(n=[n]),u=0;u<n.length;u++)for(o=n[u],i=0;i<c.length;i++)if(t=c[i],f=null,t.Scope==o||t.Id==o)for(r=0;r<t.Actions.length;r++)e=t.Actions[r],s._isActionAvailable(e)&&(f||h.push(f={Scope:t.Scope,HeaderText:t.HeaderText,Flat:t.Flat,Id:t.Id,Actions:[]}),f.Actions.push(e));return h},actions:function(n){var t=this.actionGroups(n);return t.length?t[0].Actions:null},get_actionGroups:function(n,t){for(var r,u,f,e=[],i=0;i<this._actionGroups.length;i++)if(this._actionGroups[i].Scope==n){if(r=this._actionGroups[i],u=t?r:null,!t)for(f=0;f<r.Actions.length;f++)if(this._isActionAvailable(r.Actions[f])){u=this._actionGroups[i];break}u&&Array.add(e,u)}return e},get_actions:function(n,t){for(var r,u=[],i=0;i<this._actionGroups.length;i++)if(this._actionGroups[i].Scope==n)if(r=this._actionGroups[i],t)Array.addRange(u,r.Actions);else return r.Actions;return u},get_action:function(n){for(var t,i,u,f=n.split(/\//),r=0;r<this._actionGroups.length;r++)if(t=this._actionGroups[r],t.Id==f[0])for(i=0;i<t.Actions.length;i++)if(u=t.Actions[i],u.Id==f[1])return u;return null},get_selectedKey:function(){return this._selectedKey},set_selectedKey:function(n){this._selectedKey=n},get_selectedKeyFilter:function(){return this._selectedKeyFilter},set_selectedKeyFilter:function(n){this._selectedKeyFilter=n},_get_selectedValueElement:function(){var n=this._selectedValueElement;return n||(n=this._selectedValueElement=$(String.format("#{0}_{1}_SelectedValue",this.get_id(),this.get_controller()))),n.length?n[0]:null},get_selectedValue:function(){var t=this.readContext("SelectedValue"),n;return t?t:(n=this._get_selectedValueElement(),n?n.value:"")},set_selectedValue:function(n){if(!this._hasSearchAction){this.writeContext("SelectedValue",n.toString());var t=this._get_selectedValueElement();t&&(t.value=n!=null?n:"")}},get_keyRef:function(){var i=this.get_selectedKey(),t,n;if(!i)return null;for(t="",n=0;n<this._keyFields.length;n++)n>0&&(t+="&"),t=String.format("{0}{1}={2}",t,this._keyFields[n].Name,i[n]);return t},get_showIcons:function(){return this._icons!=null&&this._lookupField==null||this.get_showRowNumber()},get_showMultipleSelection:function(){return this.multiSelect()&&this._hasKey()},get_sysColCount:function(){var n=0;return this.get_showIcons()&&n++,this.get_showMultipleSelection()&&n++,this.get_isDataSheet()&&n++,n},_createRowKey:function(n){for(var f=typeof n=="number"?this._rows[n]:arguments[0],t="",u,r,i=0;i<this._keyFields.length;i++)u=this._keyFields[i],t.length>0&&(t+=","),r=f[u.Index],t+=r==null?"null":r.toString();return t},batchEdit:function(i,r){function w(t,i){var u=t.ContextFields,f,e=[],r;if(u){while(f=n._fieldMapRegex.exec(u))e.push(f);$(e).each(function(){var n=this;r=y[n[2]];r&&!r._depends&&(r._depends=!0,i.push(r),w(r,i))})}}var u=this,c=i||u._viewId,f,y,p,h,l;if(r){var a=[],v=[],o=[],s=[],k={text:u.get_view().Label,text2:ni.Grid.BatchEdit.HeaderText,parent:u._id,controller:u._id+"_"+c+"_BatchEdit",context:{controller:u._controller,view:c},topics:[{description:String.format(ut.ItemsSelectedMany,u._selectedKeyList.length)+". "+String.format(e.Views.DefaultCategoryDescriptions.$DefaultEditDescription,u.get_view().Label),questions:s}],options:{discardChangesPrompt:!1,materialIcon:"edit"},submit:"batcheditsubmit.dataview.app",submitText:nr.HeaderText};if($(r.fields).each(function(){var n=this,t=n.Tag;n.Hidden||_field_isReadOnly.call(n)||n.OnDemand||n.Type==="DataView"||(o.push(n),t&&(t.match(/\bbatch\-edit\-disabled\b/)?a.push(n):t.match(/\bbatch\-edit\b/)&&v.push(n)))}),v.length)o=v;else if(a.length)for(f=0;f<o.length;)a.indexOf(o[f])!==-1?o.splice(f,1):f++;if(o.length){for(y={},p={},$(o).each(function(){var n=this;y[n.Name]=n}),$(o.slice(0).reverse()).each(function(){var n=this,t;n.ContextFields&&!n._depends&&(t=p[n.Name]=[],w(n,t),t=t.reverse())}),$(o).each(function(){var i=this,w=i.AllowNulls===!0,h=i.Name,a="$row."+h+"_BatchEdit==true",l={name:h+"_BatchEdit",type:"bool",value:!1,required:!t,text:i.HeaderText||i.Label,items:{style:"CheckBox"},options:{lookup:{autoAdvance:!0}}},o={name:h,type:i.Type,len:i.Len,placeholder:w?rt.Optional:rt.Required,text:!1,columns:i.Columns,rows:i.Rows,visibleWhen:a,extended:{allowNulls:w},format:i.DataFormatString,context:i.ContextFields,options:{clearOnHide:!0}},v=i.ItemsStyle,e={},y=i.ItemsDataController,k=i.ItemsTargetController,d=i.ItemsDataTextField;if(v&&(e.style=v,y?(e.controller=y,e.view=i.ItemsDataView,e.dataValueField=i.ItemsDataValueField,e.dataTextField=d,e.newView=i.ItemsNewDataView,e.targetController=k):(e.list=[],$(i.Items).each(function(){var n=this;e.list.push({value:n[0],text:n[1]})})),o.items=e,i.AliasName&&$(r.fields).each(function(){var n=this;if(n.Name===i.AliasName)return l.text=n.Label||n.HeaderText,o.altText=l.text,!1})),(v||i.Type==="Boolean")&&(o.options.lookup={nullValue:!1}),i._depends?(o.placeholder=l.text,i._question=o):s.push(l,o),k)s.push({name:h+"_BatchKeep",type:"bool",value:!0,text:!1,required:!0,items:{style:"DropDownList",list:[{value:!0,text:b.KeepOriginalSel},{value:!1,text:b.DeleteOriginalSel}]},visibleWhen:a+" && $row."+h+"!=null",options:{lookup:{openOnTap:!0}}});else if(y){var f=u._allFields[i.AliasIndex],g=o.items.copy=[],p=i.Copy,c;if(f&&f!==i&&f.isReadOnly()&&(s.push({name:f.Name,type:f.Type,readOnly:!0,visibleWhen:!1,text:!1}),g.push({from:d,to:f.Name})),p)for(c=n._fieldMapRegex.exec(p);c;)f=u.findField(c[1]),f&&(s.push({name:f.Name,type:f.Type,readOnly:f.isReadOnly(),visibleWhen:a+" && $row."+h+"!=null"}),g.push({from:c[2],to:c[1]})),c=n._fieldMapRegex.exec(p)}}),f=1;f<s.length;)h=s[f],l=p[h.name],l&&(h.placeholder=s[f-1].text,h.text=!1,h.extended.dependency=l,$(l).each(function(){var n=this._question;n.visibleWhen=h.visibleWhen;n.text="";s.splice(f++,0,n)})),f+=2;n.survey(k)}}else n.execute({controller:u._controller,view:c,requiresMetadata:!0,requiresData:!1}).done(function(n){u.batchEdit(c,n)})},delayedRefresh:function(t,i){if(i||(i=1e3),t)delete this._delayedRefreshTimer,this._isBusy||n._navigated||ht._disposing||this.refresh(!0);else{this._delayedRefreshTimer&&clearTimeout(this._delayedRefreshTimer);var r=this;this._delayedRefreshTimer=setTimeout(function(){r.delayedRefresh(!0)},i)}},get_view:function(n){if(n||(n=this.get_viewId()),!this._view||this._view.Id!==n)for(var t=0;t<this._views.length;t++)if(this._views[t].Id===n){this._view=this._views[t];break}return this._view},get_viewType:function(n){var t=this.get_view(n),i;return this._viewTypes&&(i=this._viewTypes[t?t.Id:n],i!=null)?i:t?t.Type:null},get_isGrid:function(n){var t=this.get_viewType(n);return t==="Grid"||t==="DataSheet"},get_isForm:function(n){var t=this.get_viewType(n);return t==="Form"},get_isDataSheet:function(n){var i=this.get_viewType(n),t;return __tf!==4?!1:(this._viewTypes&&(t=this._viewTypes[this.get_viewId()],t!=null&&(i=t)),i==="DataSheet")},get_isChart:function(){return this.get_viewType()==="Chart"},get_lastViewId:function(){return this._lastViewId},set_lastViewId:function(n){this._lastViewId=n},get_lastCommandName:function(){return this._lastCommandName},set_lastCommandName:function(n){this._lastCommandName=n;this._lastCommandArgument=null;$closeHovers()},get_lastCommandArgument:function(){return this._lastCommandArgument},set_lastCommandArgument:function(n){this._lastCommandArgument=n},get_isEditing:function(){return this.editing()},editing:function(){var t=this,n=t._lastCommandName,i=t._editing;return i==null&&(n==="Edit"||n==="New"||n==="Duplicate")||i===!0},get_isInserting:function(){return this.inserting()},inserting:function(){var n=this._lastCommandName;return n==="New"||n==="Duplicate"},get_lookupField:function(){return this.get_mode()===Web.DataViewMode.View?this._lookupField:this._fields[0]},set_lookupField:function(n){this._lookupField=n},get_lookupContext:function(){var n=this,i=n._lookupContext,t=n._lookupInfo?n._lookupInfo.field:n.get_lookupField();return i?i:t?{FieldName:t.Name,Controller:t._dataView.get_controller(),View:t._dataView.get_viewId()}:null},get_mode:function(){return this._mode},set_mode:function(n){this._mode=n},get_lookupValue:function(){return this._lookupValue},set_lookupValue:function(n){this._lookupValue=n},get_lookupText:function(){return this._lookupText},set_lookupText:function(n){this._lookupText=n},get_lookupPostBackExpression:function(){return this._lookupPostBackExpression},set_lookupPostBackExpression:function(n){this._lookupPostBackExpression=n},get_domFilterSource:function(){return this._domFilterSource},set_domFilterSource:function(n){this._domFilterSource=n},get_showDetailsInListMode:function(){return this._showDetailsInListMode!=!1},set_showDetailsInListMode:function(n){this._showDetailsInListMode=n},get_autoHide:function(){return!r(this.get_visibleWhen())&&this._autoHide==Web.AutoHideMode.Nothing?Web.AutoHideMode.Self:this._autoHide==null?Web.AutoHideMode.Nothing:this._autoHide},set_autoHide:function(n){this._autoHide=n},initialize:function(){n.callBaseMethod(this,"initialize");this._filterSourceSelectedHandler=Function.createDelegate(this,this._filterSourceSelected)},dispose:function(){var i=this,u=i._survey,r=i.odp,f,e;if(i._disposePendingUploads(),t||ht._disposing||($(i._element).find("iframe").remove(),i._detachBehaviors()),(i._container||t)&&(f=this.extension(),f&&f.dispose&&f.dispose()),i._wsRequest=null,i._stopInputListener(),i._disposeModalPopup(),i._disposeFieldFilter(),t||i._api||(i._disposeSearchBarExtenders(),i._disposeImport()),i._disposeFields(),i._lookupField=null,i._parentDataView=null,i._bodyKeydownHandler=null,i._filterSourceSelectedHandler=null,i._restoreEmbeddedViews(),delete i._container,i._cancelCallback=null,i._doneCallback=null,u){for(e in u)typeof u[e]=="function"&&(u[e]=null);i._survey=null}clearTimeout(i._valueChangedTimeout);r&&r._dataView===i&&(r._data=null,r._log=null,r._dataLoadedKeys=null);n.callBaseMethod(i,"dispose")},get_master:function(){var t=this.get_filterSource();return t?n.findDataView(t):null},tag:function(n){n&&(this._tag=n+" "+(this._tag||"").replace(/,/g," ").trim(),this._tagList=null)},untag:function(n){var t=this,i,r;t._tag&&(t.get_isTagged(""),i=t._tagList,r=Array.indexOf(i,n),r>=0&&i.splice(r,1),t._tag=i.join(" "));t._tagList=null},get_isTagged:function(n){var i=this,t=i._tagList,r={};return t||(t=i._tag,t&&(t=i._tagList=t.split(/\s+|,/).filter(function(n){return n in r?!1:r[n]=!0}))),t&&t.indexOf(n)!==-1},tagged:function(n){var i=this,r=n.ignoreCase!=null,t;if(arguments.length===1)return r||n.match(/\-$/)?(i._tag||"").match(r?n:typeof new RegExp(n)):i.get_isTagged(n);for(t=0;t<n.length;t++)if(i.get_isTagged(n[t]))return!0;return!1},updated:function(){var e,h,o,i,v,u,f,s,l,a;(n.callBaseMethod(this,"updated"),this._controller)&&((this.get_servicePath().startsWith("http")&&this.set_baseUrl(this.get_siteUrl()),e=this.get_selectedValue(),e.length>0&&(t||(this.set_autoHighlightFirstRow(!1),this.set_autoSelectFirstRow(!1)),this.multiSelect()?this._selectedKeyList=e.split(";"):(this._selectedKey=e.split(","),this._pendingSelectedEvent=!0)),this._container||t||(this.get_element().innerHTML="",this._container=document.createElement("div"),this.get_element().appendChild(this._container),$(this._container).addClass("DataViewContainer"),h=this._element.id,o=h.split(/_/),c.UI.DomElement.addCssClass(this._container,o?o[o.length-1]:h),this.get_showActionBar()||$(this._container).addClass("ActionBarHidden"),this.get_showDescription()||$(this._container).addClass("DescriptionHidden")),this.get_filterSource()&&this.get_filterSource()!=="Context"?(i=this.get_master(),i?(this._hasParent=!0,i.add_selected(this._filterSourceSelectedHandler),i._pendingSelectedEvent&&!t?(this._source=i,v=this,this._afterUpdateTimerId=setInterval(function(){v._afterUpdate()},250)):this._forceVisible||(this._hidden=!0)):(i=$get(this.get_filterSource()),i&&$addHandler(i,"change",this._filterSourceSelectedHandler),this.set_domFilterSource(i)),this._externalFilter.length||this._createExternalFilter(),this._filter.length||this._source||this.applyExternalFilter()):(this._hidden=!this._evaluateVisibility(),this._hidden&&this._updateLayoutContainerVisibility(!1)),t||!this.get_modalAnchor()||this.get_isModal()||this._initializeModalPopup(),i!=null&&this.get_autoHide()!=Web.AutoHideMode.Nothing&&this._updateLayoutContainerVisibility(!1),u=(n.get_commandLine()||"").replace(/#.+?$/,""),f=u.match(/_commandName=(.+?)&_commandArgument=(.*?)(&|$)/),f||(f=u.match(/_command=(.+?)&_argument=(.*?)(&|$)/)),!f||!(r(this.get_startCommandName())||__designer())||this.get_filterSource()||this.get_isModal()||this.get_lookupField()||(s=u.match(/_controller=(\w+)/),l=u.match(/_view=(\w+)/),s&&s[1]!==this.get_controller()||l&&l[1]!==this.get_view()?this._filterSource||(this._visibleWhen="false",this._updateLayoutContainerVisibility(!1)):(this._trySecondCommand=!r(s),this.set_startCommandName(f[1]),this.set_startCommandArgument(f[2]),r(this._viewId)||(this._replaceTriggerViewId=this._viewId),this._skipTriggeredView=!0,a=u.match(/\b_sync=(.+?)(&|$)/),a&&(this._syncKey=a[1].split(",")))),this.useCase("$app"))||(this.get_startCommandName()?(this.set_searchOnStart(!1),this.set_lastCommandName(this.get_startCommandName()),this.set_lastCommandArgument(this.get_startCommandArgument()),this.get_startCommandName().match(/New|Edit|Select/)&&this.set_viewId(this.get_startCommandArgument()),this.set_startCommandName(null),this.set_startCommandArgument(null),this._rows=[],t||this._survey||this._loadPage()):this.loadPage(),t&&this.mobileUpdated()))},_afterUpdate:function(){if((!this._delayedLoading||!this._source._pendingSelectedEvent)&&!this._source._isBusy){clearInterval(this._afterUpdateTimerId);var n=this._source;this._source=null;this._filterSourceSelected(n,c.EventArgs.Empty,!0)}},_updateLayoutContainerVisibility:function(n){var t=this;t._hidden=!n;n&&t._hiddenEcho&&(t._hiddenEcho=!1,$('.app-echo[data-for="'+t._id+'"]').show())},loadPage:function(){},goToPage:function(n,t){this._isBusy||(t&&(this._pageOffset=0),this.set_pageIndex(n),this._loadPage())},sort:function(n){this._isBusy||(this._clearCache(),this.get_sortExpression()===n&&(n=""),this.set_sortExpression(n),this.get_selectedKey().length>0?(this._saveViewVitals(),this._sync()):(this.set_pageIndex(0),this._loadPage()))},groupExpression:function(){var t=this.get_groupExpression();return t?t.trim().split(n._simpleListRegex):null},groupBy:function(){var n=this;$(n.groupExpression()).each(function(){var t=n.findField(this);t&&(t.GroupBy=!0)})},applyFilterByIndex:function(n,t){if(t==-1)this.removeFromFilterByIndex(n);else{var i=this._allFields[n],r=this.findFieldUnderAlias(i);this.applyFilter(i,t>=0?"=":null,t>=0?r._listOfValues[t]:null)}},findFieldUnderAlias:function(n){return(typeof n=="string"&&(n=this.findField(n)),n.Hidden)?this._allFields[n.OriginalIndex]:n},removeFromFilterByIndex:function(n){n===-1?this.removeQuickFind():(field=this._allFields[n],this.removeFromFilter(field));this.sync()},removeQuickFind:function(){var n=this;$(n._filter).each(function(t){this.match(/^_quickfind_\:\~/)&&n._filter.splice(t,1)})},removeFromFilter:function(n){typeof n!="string"&&(n=n.Name);for(var t=0;t<this._filter.length;t++)if(this._filter[t].match(/^(\w+):/)[1]===n){Array.removeAt(this._filter,t);break}},clearFilter:function(n){for(var i,u,t=this,r=0;r<t._allFields.length;r++)i=t._allFields[r],t.filterOf(i)==null||t.filterIsExternal(i.Name)||t.removeFromFilter(i);n&&(u=t.get_quickFindElement(),u!=null?(u.value="",t.quickFind()):(t.set_quickFindText(null),t._executeQuickFind(null)));t._searchParamValues=null;t._searchParamFilterStatus=null},beginFilter:function(){this._filtering=!0},endFilter:function(){this._filtering=!1;this.refreshData()},applyFilter:function(n,t,i){var u,r;for(this._clearCache(),this.removeFromFilter(n),t==":"?i&&this._filter.push(n.Name+":"+i):t&&this._filter.push((t=="~"?"_quickfind_":n.Name)+":"+t+this.convertFieldValueToString(n,i)),u=this._filter.length==1&&this._filter[0].match(/(\w+):/)[1]==n.Name,n=this.findFieldUnderAlias(n),r=0;r<this._allFields.length;r++)u&&this._allFields[r].Name==n.Name||(this._allFields[r]._listOfValues=null);this._filtering!=!0&&this._sync()},applyExternalFilter:function(n){var i,r,t;for(n&&this._filter||(this._filter=[]),this._selectedRowIndex=null,i=0;i<this._externalFilter.length;i++){if(r=this._externalFilter[i],n)for(t=0;t<this._filter.length;t++)if(this._filter[t].startsWith(r.Name+":=")){Array.removeAt(this._filter,t);break}Array.add(this._filter,r.Name+":="+r.Value)}},applyFieldFilter:function(n,t,i,r){var u,f,e;if(n==null&&(n=this._filterFieldIndex),t||(t=this._filterFieldFunc),u=this._allFields[n],this.removeFromFilter(u),$(this._allFields).each(function(){this._listOfValues=null}),f=String.format("{0}:",u.Name,u.Type),i&&i[0]==gt.EmptyValue&&(i[0]=String.jsNull),i)if(t=="$between")f+="$between$"+this.convertFieldValueToString(u,i[0])+"$and$"+this.convertFieldValueToString(u,i[1])+'\0';else for(e=0;e<i.length;e++)f+=t+(t.startsWith("$")?"$":"")+this.convertFieldValueToString(u,i[e])+'\0';else f+=t+'$\0';f.indexOf('\0')>0&&Array.add(this._filter,f);r||this.refreshData();this._forgetSelectedRow(!0)},get_fieldFilter:function(n,t){for(var u,i,r=0;r<this._filter.length;r++)if(u=this._filter[r].match(/(\w+):(\*|\$\w+\$|=|~|>=?|<(=|>){0,1})([\s\S]*)/),u[1]==n.Name)return t?(i=u[2],i.startsWith("$")?i.substring(0,i.length-1):i):u[4];return null},convertFieldValueToString:function(t,i){return typeof i=="string"&&(i.match(n._listRegex)||i.startsWith("%js%"))?i:(t.Type!=="String"&&i!=null&&typeof i=="string"&&(i=this.convertStringToFieldValue2(t,i)),g(Date,i)&&(i=n.stringifyDate(i)),String.format("%js%{0}",h(i)))},convertFieldValueToString2:function(n,t){return n.Type.startsWith("DateTime")&&!r(n.DataFormatString)?t==null?null:String.localeFormat(n.DataFormatString,t):n.Type==="Boolean"?t==null?null:t.toString():t.toString()},convertStringToFieldValue:function(t,i){return typeof i!="string"?i:i!=null&&i.startsWith("%js%")?(i=kt.deserialize(i.substring(4)),n.isISO8601DateString(i)&&(i=new Date(i)),i):this.convertStringToFieldValue2(t,i)},convertStringToFieldValue2:function(n,t){var i,r;if(t==null)return t;switch(n.Type){case"DateTime":if(i=n.DataFormatString&&n.DataFormatString.length?Date.parseLocale(t,n.DataFormatString.match(/\{0:([\s\S]*?)\}/)[1]):Date.parse(t),!isNaN(i)&&i!=null)return i;break;case"SByte":case"Byte":case"Int16":case"Int32":case"UInt32":case"Int64":case"Single":case"Double":case"Decimal":case"Currency":if(r=Number.parseLocale(t),!isNaN(r))return r}return t},goToView:function(n){var h,c,f,i,e,o,s;if(!n&&this._doneCallback){this._doneCallback(this);return}if(!r(this._replaceTriggerViewId)&&this._replaceTriggerViewId==n){this._skipTriggeredView&&(this._skipTriggeredView=!1);location.replace(location.href);return}if(h=this._ditto&&this._ditto.slice(0),this._clearCache(!0),this._ditto=h,c=this.get_filter(),f=this.get_view().Group,n==="form")for(i=0;i<this.get_views().length;i++)if(this.get_views()[i].Type==="Form"){n=this.get_views()[i].Id;break}this._disposePendingUploads();this._detachBehaviors();this.get_isForm()||(this._lastViewId=this.get_viewId(),this._selectedRowIndex=0);var a=this.get_view().Id,u=a!=n,l,v=this.extension();u&&(this._focusedFieldName=null,l=this.get_isForm(),this.get_isGrid()||this.writeContext("vitals",null));this.set_viewId(n);e=this.get_view();e.Type!=="Form"&&(this._lastViewId=n,this._restorePosition(),u&&l&&t&&v._dispose(!0));this.set_pageIndex(-1);o=e.Type==="Form"?this.get_selectedKeyFilter():!r(f)&&this.get_view().Group===f||!u?c:[];this._requestedFilter&&(o=this._requestedFilter,this._requestedFilter=null);s=u?null:this.get_sortExpression();this._requestedSortExpression&&(s=this._requestedSortExpression,this._requestedSortExpression=null);this.set_filter(o);this.set_sortExpression(s);this._loadPage();this._raiseSelectedDelayed=!0;u&&(this._scrollIntoView=!0,this._focusedCell=null)},filterOf:function(n){for(var r,i=this,u=i._allFields[n.AliasIndex].Name+":",t=0;t<i._filter.length;t++)if(r=i._filter[t],r.startsWith(u)&&!r.match(":~"))return i._filter[t].substr(u.length);for(u=n.Name+":",t=0;t<i._filter.length;t++)if(r=i._filter[t],r.startsWith(u)&&!r.match(":~"))return i._filter[t].substr(u.length);return null},findField:function(n){return this._mapOfAllFields[n]},findCategory:function(n){for(var i,t=0;t<this._categories.length;t++)if(i=this._categories[t],i.Id===n)return i;return null},_isInInstantDetailsMode:function(){return location.href.match(n.DetailsRegex)},_closeInstantDetails:function(){return this._isInInstantDetailsMode()&&e.Lookup.ShowDetailsInPopup?(close(),!0):!1},_confirm:function(i,r){var u=this,g=/(_(\w+))\s*=\s*(.+?)(\s*\r|;|\n|$)/gi,nt=i.action,c=nt.Confirmation,h=!0,f,a=g.exec(c),e,s,l,k;if(!a||__tf!==4)c=u._parseText(c,u.get_currentRow()),r?r(c):confirm(c)||(h=!1);else{for(var p=null,b=null,tt="",it="New",rt="";a;)e=a[2],s=a[3],e==="survey"&&(p=s),e==="controller"&&(b=s),e==="view"&&(tt=s),e==="commandName"&&(it=s),e==="commandArgument"&&(rt=s),e==="width"&&(i.MaxWidth=s),e==="title"&&(i.WindowTitle=s),a=g.exec(c);if(l=u.get_isModal()?null:o(b,"Controller"),k=nt.CausesValidation!==!1,t&&n.input.cancel(!0),!t||n.input.valid())if(l&&!l.get_isModal())f=l._collectFieldValues(),h=l._validateFieldValues(f,k),h&&(u._convertValuesToParameters(f),u._paramValues=f);else{f=u._collectFieldValues();var ft=i.Values=[],et=u.get_servicePath(),y,v,d,ut=u._searchParamValues;if(h=u._validateFieldValues(f,k),h){for(y=0;y<f.length;y++)v=f[y],Array.add(ft,{Name:"Context_"+v.Name,Value:v.Modified?v.NewValue:v.OldValue});p?n.survey({controller:p,parent:u._id,confirmContext:i}):(ut&&(d=[],ut.forEach(function(n){d.push({name:n.Name.substring(11),value:n.NewValue})})),l=n.showModal(this,b,tt,it,rt,w,et,[],{confirmContext:i,showSearchBar:u.get_showSearchBar(),tag:"discard-changes-prompt-none",ditto:d}));h=!1}}}return h},executeAction:function(t,i,u,f,e,o){var c,s,h;if(!this._isBusy){if(n.hideMessage(),!o){if(c=this.get_lookupField()!=null,s=c&&this._lookupActionProcessing()?null:t==="ActionBar"?this.get_actionGroups(t)[f].Actions:this.get_actions(t),i<0&&s){for(h=0;h<s.length;h++)if(this._isActionAvailable(s[h],u)){i=h;break}if(i<0)return}o=s?s[i]:null}if(!o||r(o.Confirmation)||(!this.get_isGrid()||this.get_isDataSheet()||this.get_lastCommandName()==="BatchEdit"||c||this.executeRowCommand(u,"Select"),e||this._confirm({action:o,scope:t,actionIndex:i,rowIndex:u,groupIndex:f}))){var l=o?o.CommandName:"Select",a=o?o.CommandArgument:null,v=o?o.CausesValidation:!0,y=o?o.Path:null;this.executeRowCommand(u,l,a,v,y)}}},delegateCommand:function(n,i){var r=this,e=r.get_isForm(),u,f;return t&&(n.match(/New/)||n.match(/Select|Edit/)&&i&&r._viewId!==i||n==="Select"&&i&&r.editing())&&e&&(f=r._parentDataViewId,f?(u=o(f),u.get_isForm()&&(u=r)):u=r,u&&r._controller===u._controller?t.pageInfo(r).deleted=!0:u=null),u},executeRowCommand:function(i,u,f,e,o){function v(){u==="ClientScript"?s._raiseSelectedDelayed||setTimeout(function(){s.refresh(!0)},10):u!=="Select"||f!=null||s.get_isGrid()||s._render()}var s=this,c,h,l,a;c=s.delegateCommand(u,f);c&&c!==s?c.executeRowCommand(i,u,f,e,o):(h=s.extension(),i!=null&&i>=0&&(s._selectedRowIndex=i,s._raiseSelectedDelayed=!(u==="Select"&&r(f)),h&&(s._selectedRow=s._rows[i]),s._selectKeyByRowIndex(i)),a={commandName:u,commandArgument:f?f:"",path:o,causesValidation:e?!0:!1},!t&&s.get_isDataSheet()&&u.match(/Select|New|Edit|Duplicate/)&&s._rows.length>0&&(h==null||n.Extensions.active(h)?s._get_focusedCell()||s._startInputListenerOnCell(0,0):n.Extensions.active(h,!0)),l=s.executeCommand(a),l&&(l.then?$.when(l).then(v):v()))},rowCommand:function(t,i,u,f,e){var s,o,h;(this._raiseSelectedDelayed=!(i==="Select"&&r(u)),this._selectKeyByRow(t),s={commandName:i,commandArgument:u?u:"",path:e,causesValidation:f?!0:!1},this.get_isDataSheet()&&i.match(/Select|New|Edit|Duplicate/)&&(o=this.extension(),o==null||n.Extensions.active(o)||n.Extensions.active(o,!0)),this.executeCommand(s))&&(i==="ClientScript"?this._raiseSelectedDelayed||(h=this,setTimeout(function(){h.refresh(!0)},10)):i!=="Select"||u!=null||this.get_isGrid()||this._render())},_applySelectionFilter:function(n){this.multiSelect()&&this._selectedKeyList.length>0&&this._keyFields.length==1&&(n.Filter=Array.clone(n.Filter),Array.add(n.Filter,String.format("{0}:$in${1}",this._keyFields[0].Name,this._selectedKeyList.join("$or$"))))},get_appRootPath:function(){var n=this.get_servicePath();return typeof __cothost!="undefined"&&(__cothost==="DotNetNuke"&&n.match(/DesktopModules\//i)||__cothost==="SharePoint"&&n.match(/_layouts\//i))?n.replace(/Service\.asmx$/i,""):"~/"},executeReport:function(i){var f,u,o,c,s,h,a,l,e;if(this._cancelConfirmation(),f={target:"",action:this.resolveClientUrl(this.get_appRootPath()+"Report.ashx"),request:this._createParams(!0),command:i.commandName,argument:i.commandArgument},u=f.request,u.Controller=this.get_controller(),u.View=this.get_viewId(),o=i.commandArgument,r(o)||(o.startsWith("_")&&(f.f.target=o),c=o.split(n._simpleListRegex),o=c[0],c.length==3&&(u.Controller=c[1],u.View=c[2])),f.argument=o,u.Filter.length>0&&this.get_viewType()!="Form"){if(s=new et,this.useCase("$app"))s.append(this._filterDetailsText);else if(this._renderFilterDetails(s,u.Filter),h=this.get_master(),h)for(a=h.get_selectedRow(),l=0;l<h._allFields.length;l++)e=h._allFields[l],e.ShowInSummary&&!e.OnDemand&&(e=h._allFields[e.AliasIndex],s.isEmpty()||s.append(" "),s.appendFormat("{0} {1} {2}.",e.HeaderText,dt.Equals,e.format(a[e.Index])));u.FilterDetails=s.toString()}this._viewMessages&&(u.FilterDetails=String.format("{0} {1}",this._viewMessages[this.get_viewId()],u.FilterDetails));u.FilterDetails&&(u.FilterDetails=u.FilterDetails.replace(/(<b class=\"String\">([\s\S]*?)<\/b>)/g,'"$2"').replace(/(&amp;)/g,"&").replace(/(<.+?>)|&nbsp;/g,""));u.FilterDetails&&t&&(u.filterDetails=this.extension().filterStatus());this._applySelectionFilter(u);f.actionArgs=this._createArguments(i);this._validateFieldValues(f.actionArgs.Values,!0);f.actionArgs.ExternalFilter=u.ExternalFilter;this._showDownloadProgress();this._downloadFile(f)},_downloadFile:function(t){var i=this._get_dataRequestForm(),r=n.AccountManager.current();i.target=t.target;i.action=t.action;$get("c",i).value=t.command;$get("a",i).value=t.argument;$get("q",i).value=h(t.request);r&&r.access_token&&($get("t",i).value=r.access_token);t.actionArgs&&($get("aa",i).value=n.htmlEncode(h(t.actionArgs)));i.submit()},_get_dataRequestForm:function(){var n=$get("_dataRequest_form");return n||(n=document.createElement("form"),n.id="_dataRequest_form",n.method="post",n.innerHTML='<input type="hidden" name="q" id="q"/><input type="hidden" name="aa" id="aa"/><input type="hidden" name="c" id="c"/><input type="hidden" name="a" id="a"/><input type="hidden" name="t" id="t"/>',document.body.appendChild(n)),n},_showDownloadProgress:function(){var n=this;return n._busy(!0),n._onLoadComplete(n.get_id()).done(function(){n._stopWaiting=!1;n._busy(!1)})},_onLoadComplete:function(n){var i=$.Deferred(),u=this,t="APPFACTORYDOWNLOADTOKEN",f;return document.cookie=String.format("{0}={1}; path=/",t,encodeURIComponent(n)),f=setInterval(function(){var e,n,o,s;if(!r(document.cookie))for(e=document.cookie.split(";"),n=0;n<e.length;n++)o=e[n].trim(),o.startsWith(t)&&(s=o.substring(t.length+1).split(","),(s.length===2&&s[0]===u.get_id()||u._stopWaiting)&&(document.cookie=String.format("{0}=; expires={1}; path=/",t,new Date(0).toUTCString()),clearInterval(f),i.resolve()))},500),i.promise()},isDirty:function(){for(var n=this.odp;n;){if(n.is(":dirty"))return!0;n=n._master}return!1},executeExport:function(n){var t={target:n.commandName=="ExportRss"?"_blank":"",action:this.resolveClientUrl(this.get_appRootPath()+"Export.ashx"),command:n.commandName,argument:n.commandArgument,request:n},i=this._createParams(!0);this._applySelectionFilter(i);t.request.Controller=this.get_controller();t.request.View=this.get_viewId();t.request.Filter=i.Filter;t.request.SortExpression=i.SortExpression;this._downloadFile(t)},_clearDynamicItems:function(){for(var t,n=0;n<this._allFields.length;n++)t=this._allFields[n],t.DynamicItems&&(t.DynamicItems=null,t.ItemCache=null)},_copyLookupValues:function(t,i,r,u){var o=u||[],f,s,e;if(i.Copy)while(f=n._fieldMapRegex.exec(i.Copy))if(i._dataView.findField(f[1]))if(f[2]=="null")Array.add(o,{name:f[1],value:null});else if(t)s=this.findField(f[2]),s&&Array.add(o,{name:f[1],value:t[s.Index]});else if(r)for(e=0;e<r.length;e++)if(r[e].Name==f[2]){Array.add(o,{name:f[1],value:r[e].NewValue});break}u||(i._dataView._skipFocus=!0,i._dataView.refresh(!0,o),i._dataView._focus(),i._dataView._skipFocus=!1)},_copyExternalLookupValues:function(){var n,u,f,t,i;if(this.get_filterSource()&&this.get_filterSource()!="Context"&&(n=this.get_master(),n)){for(u=[],f=this.get_externalFilter(),t=0;t<f.length;t++)i=this.findField(f[t].Name),i&&!r(i.Copy)&&n._copyLookupValues(n.get_currentRow(),i,null,u);this._ditto=u}},_processSelectedLookupValues:function(){var i=[],u=[],f=this.get_lookupField(),o=this.findField(f.ItemsDataValueField),e=this.findField(f.ItemsDataTextField),r=this.get_selectedRow(),n,t;if(o)Array.add(i,r[o.Index]);else for(n=0;n<this._allFields.length;n++)this._allFields[n].IsPrimaryKey&&Array.add(i,r[this._allFields[n].Index]);if(e)Array.add(u,e.format(r[e.Index]));else{for(n=0;n<this.get_fields().length;n++)if(t=this.get_fields()[n],!t.Hidden&&t.Type==="String"){Array.add(u,t.format(r[t.AliasIndex]));break}if(!u.length)for(n=0;n<i.length;n++)if(t=this.get_fields()[n],!t.Hidden){Array.add(u,t.format(r[t.AliasIndex]));break}}this._copyLookupValues(r,f);f._dataView.changeLookupValue(f.Index,i.length===1?i[0]:i,u.join(";"))},_showModal:function(i){var r=this,e=r.get_tag(),s=r.get_lastViewId(),u=i.commandName,o=i.commandArgument,h=r._useCase==="seeAll",c=h?r._externalFilter:r.get_hasParent()||r._lookupInfo?r._externalFilter:null,l=h&&u==="New"?r._filter:r.get_selectedKeyFilter(),f;r.set_lastCommandName(null);r.set_lastCommandArgument(null);r._render();i.commandName==="Duplicate"&&(i.commandName="New");t&&r.get_isGrid()&&(u!=="Edit"&&u!=="New"||u&&o!==s||(e=(e||"")+" view-type-inline-editor"));f=n.showModal(this,r.get_controller(),o,u,o,r.get_baseUrl(),r.get_servicePath(),c,{filter:l,ditto:r.get_ditto(),lastViewId:s,filterSource:r.get_filterSource(),filterFields:r.get_filterFields(),showSearchBar:r.get_showSearchBar(),tag:e,showActionButtons:r.get_showActionButtons()});r.set_ditto(null);r._savePosition();f&&!f.inserting()&&(f._position=r._position);r._restorePosition()},_savePosition:function(){this.get_isForm()||this._selectedRowIndex==null||(this._position={index:this._pageSize*this._pageIndex+this._selectedRowIndex,count:this._totalRowCount,filter:this.get_filter(),sortExpression:this.get_sortExpression(),key:Array.clone(this._selectedKey),keyFilter:this._selectedKeyFilter,active:!1})},_restorePosition:function(){this._position&&(this._selectedKey=this._position.key,this._selectedKeyFilter=this._position.keyFilter,this._position=null)},_advance:function(n){this._isBusy||!this._position||n==-1&this._position.index==0||n==1&&this._position.index==this._position.count-1||(this._position.index+=n,this._position.changing=!0,this._position.changed=!0,this._loadPage(),this._position.changing=!1)},discard:function(){this.tag("discard-changes-prompt-none")},cancel:function(){var n=this;if(n._inlineEditor&&(n._inlineEditorCanceled=!0),n._cancelCallback)n._cancelCallback(this);else if(!n._closeInstantDetails()){if(n.endModalState("Cancel"))return;n.get_backOnCancel()||!r(n._replaceTriggerViewId)?(n.goBack(!1),setTimeout(function(){location.replace(location.href)},500)):(n.set_lastCommandName("Cancel"),n._pendingSelectedEvent=!0,n.get_isForm()||n.inserting()?t?location.replace(location.href):(n._forceSync(),n.goToView(n._lastViewId)):n._totalRowCount<0?n.goToPage(-1):(n._clearDynamicItems(),n._render(),_body_performResize()))}},_convertValuesToParameters:function(n){for(var i=0,t;i<n.length;)t=n[i],t.ReadOnly=!0,t.Name.match("PrimaryKey")?Array.removeAt(n,i):(t.Name="Parameters_"+t.Name,i++)},_actionConfirmed:function(t){var i=this,o=i._createArguments(t),e=o.Values,s=t.causesValidation,l=i._validateFieldValues(e,s==null||s),c;if(l){var r=i.get_confirmContext(),u=i.get_parentDataView(),h=t.commandArgument,f=[];h&&(f=h.split(n._simpleListRegex),f.forEach(function(t,i){var r=n.find(t);r&&r._controller===t&&(f[i]=r)}));f[0]&&f[0]._controller?($(e).each(function(){this.Name="Parameters_"+this.Name}),f.forEach(function(n){n._externalFilter=e;n.sync()})):r&&u?(c=u._paramValues=o.Values,i._convertValuesToParameters(c),u._confirmDataViewId=i.get_id(),u._lookupActionProcessing(!1),u.executeAction(r.scope,r.actionIndex,r.rowIndex,r.groupIndex,!0,r.action),u._lookupActionProcessing(!0)):i._survey&&i.cancel()}},executeCommand:function(u){function ot(){u._handled=!0;f.executeCommand(u)}function ht(n){tt.trigger($.Event("inlineeditingmode.dataview.app",{dataView:f,inlineEditing:!0,editor:!0,newRow:n}))}var f=this,y=!!f._skipInvoke,s,c,wt=u.path,o=u.commandName,e=u.commandArgument,p,rt,a,ut,ft,w,b,l,ct,yt,g,et,it;if(!f._isBusy){if(!y){if(u._handled)c=!1;else{if(c=pt(f,u,!0),c&&c.then)return $.when(c).then(ot),!1;if(!c)if(s=new v(f),s.before(u),s.canceled())s.dispose(),c=!0;else if(s._wait)return $.when(s._wait).then(ot),!1}if(c)return f._valid=o==="Calculate",f._valid}if(p=f._persist,p&&p.command===o&&(rt=f.values(),n.ensureJSONCompatibility(rt),(p.scope==="user"?n.userVar:n.sessionVar)("persist_"+f._controller+"_"+f._viewId,h(rt))),o&&o.match(/^(Report|Export)/)&&(f.isDirty()?a=at.Save:d.offline()&&d.offline("status")!=="synced"?a=at.SaveAndSync:n.online()||(a=at.OnlineRequired),a)){t.notify({text:at.UnableToExec+" "+a,duration:"long"});return}switch(o){case"Select":case"":f.set_lastCommandName(o);f.set_lastCommandArgument(e);f.get_lookupField()&&e===""?f._processSelectedLookupValues():(st(e)?f._render():(f._savePosition(),f.get_showModalForms()&&f.get_isForm(e)?f._showModal(u):f.goToView(e)),__designer()&&__designer_notifySelected(f));break;case"BatchEdit":f.batchEdit(e);break;case"Edit":case"New":case"Duplicate":if(t||(f._allowModalAutoSize(),f._fixHeightOfRow(!1),o==="Edit"?f._savePosition():f._restorePosition()),o==="Duplicate"&&(ut=f.get_selectedRow(),ut)){for(ft=[],i=0;i<f._allFields.length;i++)w=f._allFields[i],w.OnDemand||Array.add(ft,{name:w.Name,value:ut[w.Index],duplicated:!0});f._ditto=ft}if(t&&o==="Edit"&&f.get_isGrid()&&(!e||e===f.get_viewId()))f.inlineEditing()?t.edit.activate():ht();else{if(b=f._get_focusedCell(),l=f.extension(),o==="New"||o==="Duplicate"){if(l&&l.clearSelection?l.clearSelection(!0,o):f._forgetSelectedRow(!1,b),t&&f.get_isGrid()&&(!e||e===f.get_viewId())){ht(!0);return}r(e)&&(e=u.commandArgument=f.get_viewId());o==="New"&&f._copyExternalLookupValues()}ct=o==="Edit"&&e===f.get_viewId()&&!f.editing();f.set_lastCommandName(o);f.set_lastCommandArgument(e);f._clearDynamicItems();st(e)||ct?l&&l.stateChanged?l.stateChanged():(f.get_isModal()&&(f._container.style.height=""),f.get_isDataSheet()&&!f._pendingChars&&f._startInputListenerOnCell(f._selectedRowIndex,b==null?0:b.colIndex),f._render()):t||f.get_showModalForms()&&f.get_isForm(e)&&!f.get_isModal()?f._showModal(u):f.goToView(e);__designer()&&__designer_notifySelected(f)}break;case"Navigate":f.navigate(e);break;case"Cancel":f.cancel();break;case"Confirm":f._actionConfirmed(u);break;case"Back":history.go(r(e)?-1:nt(e));break;case"Report":case"ReportAsPdf":case"ReportAsImage":case"ReportAsExcel":case"ReportAsWord":f.executeReport(u);break;case"ExportCsv":case"ExportRowset":case"ExportRss":f.executeExport(u);break;case"_ViewDetails":f._viewDetails(e);break;case"ClientScript":ei();eval(e);break;case"SelectModal":case"EditModal":f.set_lastCommandName(null);f.set_lastCommandArgument(null);f._render();var bt=o.match(/^(\w+)Modal$/),k=e.split(","),kt=k.length===1?f.get_controller():k[0],lt=k.length===1?e:k[1],vt=[];for(i=0;i<f.get_selectedKey().length;i++)Array.add(vt,{Name:f._keyFields[i].Name,Value:f.get_selectedKey()[i]});yt=n.showModal(f,kt,lt,bt[1],lt,f.get_baseUrl(),f.get_servicePath(),vt);yt._parentDataViewId=f.get_id();break;case"Import":t?n.getScript("~/js/daf/daf-import",function(){n.import("upload",{dataView:f,view:e})}):f._showImport(e);break;case"DataSheet":f.writeContext("GridType","DataSheet");f._forceFocusDataSheet=!0;f.changeViewType("DataSheet");f.refreshAndResize();break;case"Grid":f.writeContext("GridType","Grid");f.changeViewType("Grid");f.refreshAndResize();break;case"Status":f._changeStatus(u);break;case"Search":f._executeSearch(wt);break;case"None":return!0;case"Upload":n.upload.multi.show(f,e);break;default:g=null;et=e.match(/^view:(.+)$/);o==="Insert"&&et&&(g=et[1],Array.clear(f._selectedKey),f.updateSummary(),f.set_lastCommandName("New"),f.set_lastCommandArgument(g));it=f._createArguments(u,g);f._valid=f._validateFieldValues(it.Values,u.causesValidation!==!1);f._valid&&(y?f._invokeArgs=f._valid?it:f._validationError:(f._execute(it),y=!0))}if(!y)return s.after(u),s.dispose(),!s.canceled()}},_forgetSelectedRow:function(n,t){t||(t=this._get_focusedCell());this.get_isDataSheet()&&t&&(t.colIndex=0);this._lastSelectedRowIndex=!this._ignoreSelectedKey&&this._selectedKey.length>0&&this._rowIsSelected(this._selectedRowIndex)?this._selectedRowIndex:-1;this._ignoreSelectedKey=!1;Array.clear(this._selectedKey);this.updateSummary();n&&this.raiseSelected()},_changeStatus:function(n){var u,r,i,f;(!n.causesValidation||(u=this._collectFieldValues(),n.values&&(u=Array.clone(n.values)),this._validateFieldValues(u,!0)))&&(r=this.findField("Status"),r)&&(this.editing()?(i=this._get("_Item",r.Index),i||(i=document.createElement("input"),i.type="hidden",i.id=String.format("{0}_Item{1}",this._id,r.Index),this._container.appendChild(i)),i.value=n.commandArgument):(f=this.get_selectedRow(),f[r.Index]=n.commandArgument),t||this._updateVisibility())},_notifyDesigner:function(n){if(__designer()&&n){var t=this._lastArgs;external.ExplorerNodeChanged(this.get_controller(),this.get_viewId(),t.CommandName,t.CommandArgument,h(t.Values))}},goBack:function(t){n._navigated=!0;this._notifyDesigner(t);var i=location;i.href.match(/_explorerNode=/)?i.replace(i.href):history.go(-1)},_viewDetails:function(t){var i=this.findField(t),o,u,s,f,e,h;if(i){if(o=i.Name,i.ItemsDataController==this.get_controller())for(u=0;u<this._allFields.length;u++)if(this._allFields[u].IsPrimaryKey){o=this._allFields[u].Name;break}if(s=this.get_contextFilter(i),__designer()){for(f=String.format("{0}&{1}={2}",i.ItemsDataController,r(i.ItemsDataValueField)?o:i.ItemsDataValueField,this.get_selectedRow()[i.Index]),u=0;u<s.length;u++)e=s[u],f=String.format("{0}&{1}={2}",f,e.Name,e.Value);f=this.resolveClientUrl(String.format("~/Details.{0}?l={1}",__designer()?"htm":"aspx",encodeURIComponent(f)));location.href=f;n._navigated=!1}else e=[{Name:r(i.ItemsDataValueField)?o:i.ItemsDataValueField,Value:this.fieldValue(i.Name)}],Array.addRange(e,s),h=n.showModal(this,i.ItemsDataController,"editForm1","Select","editForm1",this.get_baseUrl(),this.get_servicePath(),e,{useCase:"ObjectRef"}),h.set_showSearchBar(this.get_showSearchBar()),h._parentDataViewId=this.get_id(),h._closeViewDetails=!0}},changeViewType:function(n){this.cancelDataSheet();this._viewTypes||(this._viewTypes=[]);this._viewTypes[this.get_viewId()]=n;this._clearCache()},_parseLocation:function(n,t,i){var e,o,c,s;if(t||(t=this.get_selectedRow()),!n)return null;n=this.resolveClientUrl(n);for(var h=/([\s\S]*?)\{(\w+)?\}/g,u="",f=-1,r=h.exec(n);r;){if(u+=r[1],i&&this._lastArgs){for(e=0;e<i.length;e++)if(o=i[e],o.Name==r[2]){u+=this._lastArgs.CommandName.match(/Insert/i)?o.NewValue:o.OldValue;break}}else c=r[2].match(/^\d+$/)?this.get_fields()[nt(r[2])]:this.findField(r[2]),c&&(s=t[c.Index],s!=null&&(u+=r.index==0?s:encodeURIComponent(s)));f=h.lastIndex;r=h.exec(n)}return f!=-1&&(n=u+(f<n.length?n.substr(f):"")),n.startsWith("?")&&(n=location.pathname+n),n},_parseText:function(n,t){var i=this,u,f;if(t||(t=i.get_selectedRow()),!n)return null;var e=i.get_parentDataView(i),o=e._selectedKeyList,s=o?o.length:0;!s&&e._selectedKey&&e._selectedKey.length&&s++;o&&Array.indexOf(o,"null")!==-1&&s--;n=n.replace(/\{\$\s*count\}/gi,e._totalRowCount);n=n.replace(/\{\$\s*selected\}/gi,s);for(var c=/([\s\S]*?)\{(\w+)?\}/g,l="",h=-1,r=c.exec(n);r;)l+=r[1],u=r[2].match(/^\d+$/)?i.get_fields()[nt(r[2])]:i.findField(r[2]),u&&(u=i._allFields[u.AliasIndex],f=t[u.Index],f!=null&&(f=u.format(f),l+=f)),h=c.lastIndex,r=c.exec(n);return h!==-1&&(n=l+(h<n.length?n.substr(h):"")),n},_disposePendingUploads:function(){$(this._pendingUploads).each(function(){this.files=null;this.form=null});this._pendingUploads=null;$(this._container).find(".app-drop-box").each(function(){n.upload("destroy",{container:this})})},navigate:function(n,t){var r,i;for(this.set_selectedValue(this.get_selectedKey()),ei(),n=this._parseLocation(n,null,t),i=0;i<this.get_views().length;i++)if(this.get_views()[i].Id==n){r=this.get_views()[i];break}r?this.goToView(n):this._navigate(n)},_navigate:function(i,r){n._navigated=!0;var u=i.match(n.LocationRegex),f=u?u[2]:i;typeof __dauh!="undefined"?u?this.encodePermalink(u[2],u[1],r):this.encodePermalink(i):t&&f.indexOf("http")!=-1&&(!u||u[1]=="_internal")?(n._navigated=!1,t.openExternalUrl(f,!1)()):u?(n._navigated=!1,open(u[2],u[1],r?r:"")):s.location.href=i},get_contextFilter:function(n,t){var e=[],o,f,i,c,s,a;if(!r(n.ContextFields))for(var h=t?t:this._collectFieldValues(!0),l=/(\w+)(\s*=\s*(.+?)){0,1}\s*(,|$)/g,u=l.exec(n.ContextFields);u;){if(o=r(u[3])?u[1]:u[3],f=o.match(/^\'(.+)\'$/),f||(f=o.match(/^(\d+)$/)),f){for(i=0;i<e.length;i++)if(e[i].Name==u[1]){e[i].Value+='\0='+f[1];f=null;break}f&&Array.add(e,{Name:u[1],Value:f[1],Literal:!0})}else if(c=this.findField(o),c)for(i=0;i<h.length;i++)if(h[i].Name==c.Name){s=h[i];a=s.Modified?s.NewValue:s.OldValue;Array.add(e,{Name:u[1],Value:a});break}u=l.exec(n.ContextFields)}return e},htmlEncode:function(t,i){var r=this._allFields[t.AliasIndex];return r.HtmlEncode?r.Type=="String"?n.htmlEncode(i):i:i},filterIsExternal:function(n){var t,r,u,i;if(this._externalFilter.length==0)return!1;for(t=0;t<this._filter.length;t++){if(r=this._filter[t].match(/(\w+):/)[1],u=!1,!n||n==r)for(i=0;i<this._externalFilter.length;i++)if(this._externalFilter[i].Name==r){u=!0;break}if(!u)return!1}return!0},updateSummary:function(){},hasDetails:function(){var n=this,t=n._hasDetails;return t||$(n._allFields).each(function(){if(this.Type==="DataView")return t=!0,!1}),!n.odp&&!!t&&!n._doneCallback},get_hasDetails:function(){return!!this._hasDetails},get_hasParent:function(){return this._hasParent===!0},add_selected:function(n){var t=this;t._dataViewFieldName||(t._hasDetails=!0);t.get_events().addHandler("selected",n)},remove_selected:function(n){this.get_events().removeHandler("selected",n)},raiseSelected:function(){var i,r;n._navigated||(i=t?t.edit._pending:null,i&&i.direction!=="enter"&&i.direction)||(r=this.get_events().getHandler("selected"),r&&r(this,c.EventArgs.Empty),this.multiSelect()||this.set_selectedValue(this.get_selectedKey()))},add_executed:function(n){this.get_events().addHandler("executed",n)},remove_executed:function(n){this.get_events().removeHandler("executed",n)},raiseExecuted:function(n){var t=this.get_events().getHandler("executed");t&&t(this,n)},_collectFieldValues:function(){var t=this,i=[],n,r=t.extension();return r&&r.collect?i=r.collect():(n=t.get_selectedRow(),n&&n.length&&t._allFields.forEach(function(t,r){if(!t.OnDemand){var u=n[r],o=t.Name,e={Name:o},f;u===undefined&&(u=null);u!=null&&(e.OldValue=u,f=!0);t.ReadOnly&&(o!=="Status"||f)&&(e.ReadOnly=!0,f=!0);f&&i.push(e)}})),i},_enumerateExpressions:function(n,t,i){var f=[],u,r;if(this._expressions)for(u=0;u<this._expressions.length;u++)r=this._expressions[u],r.Scope==t&&(n==Web.DynamicExpressionType.Any||r.Type==Web.DynamicExpressionType.RegularExpression)&&r.Target==i&&Array.add(f,r);return f},_prepareJavaScriptExpression:function(n){var t,f,u,e;if(!n._variables){for(var i=[],o=/(\[(\w+)\])|(\$row\.(\w+))/gm,r=o.exec(n.Test);r;){for(t=r[2]||r[4],f=!1,u=0;u<i.length;u++)if(i[u].name==t){f=!0;break}f||(e=this.findField(t),e&&Array.add(i,{name:t,regex:new RegExp("(\\["+t+"\\])|(\\$row\\."+t+")","g"),replace:String.format("this._javaScriptRowValue({0})",e.Index)}));r=o.exec(n.Test)}n._variables=i;n.Test=n.Test.replace(/\[(\w+)\.(\w+)\]/gi,"this.fieldValue('$2','$1')")}},_javaScriptRowValue:function(n){var r=this,h=r._javaScriptRow[n],i,s,u,f,e,t;return i=r._allFields[n],i.Type==="DataView"?(t=r._javaScriptValues[i.Name],t||(s=i._dataViewId,s?(t={_ready:!0,_selected:!1},u=o(i._dataViewId),e=u._selectedKey,e.length&&(f=u.commandRow(),f&&f.length&&(u._allFields.forEach(function(n){t[n.Name]=f[n.Index]}),t._selected=e[0]!==undefined))):t={_ready:!1,_selected:!1},r._javaScriptValues[i.Name]=t)):t=h,t},_evaluateJavaScriptExpressions:function(i,r,u){for(var o=this,s=u?"":null,c,l,a,f,e,v,h=0;h<i.length;h++)if(f=i[h],f.Type===Web.DynamicExpressionType.ClientScript){o._prepareJavaScriptExpression(f);try{if(e=f._script,!e){for(e=f.Test,c=0;c<f._variables.length;c++)l=f._variables[c],e=e.replace(l.regex,l.replace);f._script=n.functions[e];f._script||(f._script=n.functions[e]=eval("(function(){return "+e+"})"));f._script==null?f._script=e:e=f._script}if(e)if(o._javaScriptValues={},o._javaScriptRow=r,o._javaScriptRowConvert=o.editing(),a=typeof e=="string"?eval(e):e.call(this),u)a&&(s==null?s=f.Result:s+=" "+f.Result);else return f.Result==null?a:f.Result}catch(y){v=o._controller+"."+o._viewId+"."+f.Target+':\n"'+y.message+'" in\n'+f.Test;t?t.notify({text:v,duration:"long"}):alert(v)}}return s},_validateFieldValueFormat:function(n,t){var u=null,f=n.DataFormatString,o=n.Type,i=t.NewValue,e=i;switch(o){case"SByte":case"Byte":case"Int16":case"Int32":case"UInt32":case"Int64":case"Single":case"Double":case"Decimal":case"Currency":typeof i!="number"&&(i=Number.tryParse(i));isNaN(i)||i==null?u=rt.NumberIsExpected:i!=null&&o.match(/int|byte/i)&&(i=Math.round(i));break;case"Boolean":try{i=g(String,i)?Boolean.parse(i):i}catch(s){u=rt.BooleanIsExpected}break;case"Date":case"DateTime":typeof i=="string"?(i=r(f)?Date.parse(i):Date.parseLocale(i,f.match(/\{0:([\s\S]*?)\}/)[1]),!i&&n.DateFmtStr&&n.TimeFmtStr&&(i=Date.tryParseFuzzyDateTime(e,f)),i||(i=Date.tryParseFuzzyDate(e,f)),!i&&n.TimeFmtStr&&(i=Date.tryParseFuzzyTime(e)),!i&&f&&(i=Date.parse(e),i=isNaN(i)?null:new Date(i)),i||(u=rt.DateIsExpected)):isNaN(i.getTime())&&(u=rt.DateIsExpected)}return t.NewValue=i,u},validate:function(n){for(var t=0;t<n.length;t++)if(n[t].Error)return!1;return!0},_validateFieldValues:function(i,r,u){for(var y=this,s=!0,v=new et,w,d,f,o,e,ut,g,b,l,nt,tt,it,h,a,k,p=0;p<i.length;p++)if(f=i[p],w=f.NewValue,d=f.OldValue,o=this.findField(f.Name),o&&(!u||o.ColIndex===u.colIndex)){if(e=null,o.ReadOnly&&o.IsPrimaryKey)w!=null||d==null||t||(f.NewValue=d);else if(f.Modified){if(o.AllowNulls||o.HasDefaultValue&&!rt.EnforceRequiredFieldsWithDefaultValue||!st(w)||o.Hidden||o.isReadOnly()||(e=rt.RequiredField),!e&&st(w)&&(f.NewValue=null),e||f.NewValue==null||o.IsMirror||o.Hidden&&!f.Modified||(ut=this._validateFieldValueFormat(o,f),o.isReadOnly()||(e=ut)),!e)for(g=this._enumerateExpressions(Web.DynamicExpressionType.RegularExpression,Web.DynamicExpressionScope.Field,f.Name),b=0;b<g.length;b++){l=g[b];nt=f.NewValue?f.NewValue:"";try{tt=new RegExp(l.Test);it=tt.exec(nt);l.Result.match(/\$(\d|\'\`)/)?it&&(f.NewValue=nt.replace(tt,l.Result)):it||(e=e?e+=l.Result:l.Result)}catch(ft){}}f.Modified=o.Type.startsWith("DateTime")?(f.NewValue==null?null:f.NewValue.toString())!=(f.OldValue==null?null:f.OldValue.toString()):f.NewValue!=f.OldValue}if(f.Error=e,t)e&&r&&s&&(!t||y._inlineEditor||n.input.visible(o)?(this._focus(o.Name,e),s=!1):t&&(e=null,f.Error=null));else{if(h=$get(this.get_id()+"_Item"+o.Index+"_Error"),h&&r)for(c.UI.DomElement.setVisible(h,!1),h.innerHTML=e,e!=null&&s&&this._showFieldError(o,e),a=h.parentNode;a&&a.tagName!="BODY";){if(!$common.getVisible(a)){h=null;break}a=a.parentNode}e&&r&&(s&&(k=this._lastFocusedCell,k&&(this._focusCell(-1,-1,!1),this._focusCell(k.rowIndex,k.colIndex,!0),this._lastFocusedCell=null),this._focus(o.Name)),s=!1,h||v.append(n.formatMessage("Attention",o.Label+": "+e)))}}return s&&n.upload()&&$(this._allFields).each(function(){var i=this,u;if(i.OnDemand&&(u=n.upload("validate",{container:pr(y,i),dataViewId:y._id,fieldName:i.Name}),!i.AllowNulls&&!u&&r))return s=!1,e=rt.Required,t?y._focus(i.Name,e):v.appendFormat("<b>{0}<\/b>: {1}",i.Label,e),!1}),r||(s=!0),s||(this._skipInvoke?this._validationError=v.toString():n.showMessage(v.toString())),v.clear(),s},_fieldIsInExternalFilter:function(n){return this._findExternalFilterItem(n)!=null},_findExternalFilterItem:function(n){for(var i,t=0;t<this._externalFilter.length;t++)if(i=this._externalFilter[t],n.Name.toLowerCase()===i.Name.toLowerCase())return i;return null},_focus:function(n,t){this._skipFocus||this.extension().focus(n,t)},_serverFocus:function(n,t){this._focus(n,t);this.get_isDataSheet()&&(this.refresh(!0),this._focus(n,t))},_saveTabIndexes:function(){},_restoreTabIndexes:function(){},_selectKeyByRowIndex:function(n){this._selectKeyByRow(this._rows[n])},_selectKeyByRow:function(n){var i,t,r;if(n){for(this._selectedRow=n,i=this._selectedKey,this._selectedKey=[],this._selectedKeyFilter=[],t=0;t<this._keyFields.length;t++)r=this._keyFields[t],Array.add(this._selectedKey,n[r.Index]),Array.add(this._selectedKeyFilter,r.Name+":="+this.convertFieldValueToString(r,n[r.Index])),i&&(i.length<t||i[t]!=this._selectedKey[t])&&(i=null);this.updateSummary();i||this._raiseSelectedDelayed||this.raiseSelected()}},_showWait:function(){},_hideWait:function(){},_raisePopulateDynamicLookups:function(){var t=this;t._hasDynamicLookups&&t.editing()&&t._skipPopulateDynamicLookups!==!0&&(t._survey?n.survey("populateItems",{dataView:t,callback:function(n){var i={Values:[]};$(t._allFields).each(function(){var t=this,r;$(n).each(function(){if(this.Name===t.Name)return r=!0,!1});t.ItemsAreDynamic&&r&&i.Values.push({Name:t.Name,NewValue:t.Items})});t._populateDynamicLookups(i)}}):t.executeCommand({commandName:"PopulateDynamicLookups",commandArgument:"",causesValidation:!1}));t._skipPopulateDynamicLookups=!1},_raiseCalculate:function(n,t){this.executeCommand({commandName:"Calculate",commandArgument:n.Name,causesValidation:!1,trigger:t.Name})},get_currentRow:function(){var n=this;return n.inserting()?t?n.editRow():n._newRow?n._newRow:[]:n.get_selectedRow()},updateFieldValue:function(t,i,r){var h={name:t,value:i},f,s,e,u;if(r==="master"&&(f=this._dataViewFieldOwnerId,s=this._parentDataViewId,!f&&s&&(f=o(s)._dataViewFieldOwnerId),f&&(e=$("#"+f),!e.is(".ui-page-active")))){u=e.data("inputExecute");u?u.every(function(n,i){var r=n.name===t;return r&&u.splice(i,1),!r}):(u=[],e.data("inputExecute",u));u.push(h);return}n.input.execute({values:h})},fieldValue:function(n,i){var f=this,r,e,u,o=null,s;return n==="_wizard"?(s=$("#"+f._id+" [data-layout]").data("wizard-config"),o=s?s.active:0):(r=!i||!i.length?f:i.match(/^master$/i)?f.get_master():$find(i),r&&r._allFields&&(e=r.findField(n),e&&(t?u=r.editRow():(u=r._clonedRow,u||(u=r._cloneChangedRow())),o=u?u[e.Index]:null))),o},_configure:function(n){var u,t,f,i,e,o;if(this._requiresConfiguration&&(n||(n=this.get_currentRow()),n))for(u=0;u<this._allFields.length;u++)if(t=this._allFields[u],!r(t.Configuration))for(f=/\s*(\w+)=(\w+)\s*?($|\n)/g,i=f.exec(t.Configuration);i;)e=this.findField(i[2]),e&&(o=n[e.Index],o&&(t[i[1]]=o)),i=f.exec(t.Configuration)},_focusQuickFind:function(n){if(!this._quickFindFocused||n===!0){this._lostFocus=!0;try{c.UI.DomElement.setFocus(this.get_quickFindElement())}catch(t){}this._quickFindFocused=!0}},_restoreEmbeddedViews:function(){var t,n;if(this._embeddedViews){for(t=0;t<this._embeddedViews.length;t++)n=this._embeddedViews[t],n.parent.appendChild(n.view._element),delete n.parent,n.view=null;Array.clear(this._embeddedViews)}},_incorporateEmbeddedViews:function(){var n;if(this._embeddedViews)for(n=0;n<this._embeddedViews.length;n++){var t=this._embeddedViews[n],r=$get("v_"+t.view.get_id()),i=t.view._element;t.parent=i.parentNode;r.appendChild(i)}},raiseSelectedDelayed:function(){var n=this;n._raiseSelectedDelayed&&(n._raiseSelectedDelayed=!1,t||n.raiseSelected(),n._forceChanged=!1)},refreshChildren:function(){this._fields.forEach(function(n){var t=n._dataViewId;n.Type==="DataView"&&$("#"+t+"_echo").is(":visible")&&o(t).sync()})},_render:function(n){var i=this;try{n&&i._refreshExtension();i.get_parentDataView(i).raiseSelectedDelayed()}catch(r){t.notify(r)}},_appendModalPanel:function(n){var t=this.get_element();t&&t.appendChild(n)},_syncKeyFilter:function(){var i=this.get_selectedKey(),n,t;if(i.length>0&&this._selectedKeyFilter.length==0)for(n=0;n<this._keyFields.length;n++)t=this._keyFields[n],Array.add(this._selectedKeyFilter,t.Name+":="+this.convertFieldValueToString(t,i[n]))},_mergeRowUpdates:function(n){var u,f,i,r,t;if(this._lastCommandName=="BatchEdit"&&(u=this._batchEdit=[],f=this._allFields,$(this._element).find(".BatchSelect input:checkbox:checked").each(function(){var n=this.id.match(/BatchSelect(\d+)$/),t;n&&(t=f[nt(n[1])],Array.add(u,t.Name))})),this._originalRow=null,this._useLEVs(n),this.editing()&&this._ditto){for(this._originalRow=Array.clone(n),i=0;i<this._ditto.length;i++)r=this._ditto[i],t=this.findField(r.name),!t||t.ReadOnly&&t.IsPrimaryKey||(n[t.Index]=r.value);delete this._ditto}this._configure(n);this._mergedRow=n},_removeRowUpdates:function(){var t=this._mergedRow,n;if(t){if(this._originalRow)for(n=0;n<this._originalRow.length;n++)t[n]=this._originalRow[n];this._mergedRow=null}},_refreshExtension:function(){var n=this.extension(),t=this._lastExtension;n!=t&&(t&&t.hide(),n&&n.show(),this._lastExtension=n);n&&n.refresh()},_isActionMatched:function(t,i){var r=t.WhenClientScript,u=r;return typeof r=="string"&&(r=r.trim(),r&&(r=n.functions[r],r||(r=n.functions[u]=t.WhenClientScript=eval("(function(){return "+this._prepareJavaScriptExpressionEx(u)+"})")))),(!t.WhenViewRegex||t.WhenViewRegex.exec(this.get_viewId())!=null===t.WhenViewRegexResult)&&(!t.WhenTagRegex||t.WhenTagRegex.exec(this.get_tag())!=null===t.WhenTagRegexResult)&&(!t.WhenHRefRegex||t.WhenHRefRegex.exec(location.pathname)!=null===t.WhenHRefRegexResult)&&(i||!r||!!r.call(this))},_isActionAvailable:function(n,t){var i=this,u=n.CommandName,r=n.WhenLastCommandName||"",s=n.WhenLastCommandArgument||"",h=i._selectedKey,c=n.WhenKeySelected,e,f,o;if(r==="Any"&&(r=i.get_lastCommandName()||""),e=!r.length||r===i.get_lastCommandName()&&(!s.length||s===i.get_lastCommandArgument()),e){if(f=i.editing(),u==="DataSheet")return!f&&i.get_isGrid()&&i.get_viewType()!=="DataSheet"&&i._isActionMatched(n);if(u==="Grid")return!f&&i.get_isGrid()&&i.get_viewType()!=="Grid"&&i._isActionMatched(n);if(u==="BatchEdit")return i.get_showMultipleSelection()&&i._selectedKeyList&&i._selectedKeyList.length>1&&i._isActionMatched(n);if(f)return o=i._rowIsSelected(t==null?i._selectedRowIndex:t),o?(r==="New"||r==="Edit"||r==="BatchEdit"||r==="Duplicate")&&i._isActionMatched(n):o||t!=null||r!=="New"&&r!=="Duplicate"?!r.length&&t!=null&&i._isActionMatched(n):i._isActionMatched(n)}return e&&(!c||c&&h&&h.length>0)&&i._isActionMatched(n)&&(u!=="New"||i._hasKey())},_hasKey:function(){return this._keyFields&&this._keyFields.length>0},_rowIsSelected:function(n){var t=this,i=t._rowIsSelectedCached,r;return i!=null?i:t._hasKey()?(r=t._rows[n],t.rowIsSelected(r)):t.get_isModal()&&t.get_isForm()},rowIsSelected:function(n){var f=this,e=f._keyFields,o=f._selectedKey,t;if(n&&e.length===o.length&&e.length){if(n===f._mergedRow)return!0;for(t=0;t<e.length;t++){var s=e[t],i=o[t],u=n[s.Index];if(s.Type.startsWith("DateTime")){if(!(i||u))return!1;i=i.toString();u=u.toString()}if(i!=u&&!(u==null&&r(i)))return!1}return!0}return f._inlineEditor?!0:!1},rowIsTemplate:function(n){var t,i,r,u;if(n||(n=this.commandRow()),t=this._keyFields,i=!0,n&&n.length&&t.length){for(r=0;r<t.length;r++)if(u=t[r],n[u.Index]!=null){i=!1;break}}else i=!1;return i},commandRow:function(){var n=this.extension();return n&&n.commandRow?n.commandRow():null},extension:function(){var i=null,t=this,f=n.Extensions,o;if(f){var r=t.get_viewType(),u=t._altViewType,e=t._extensions;e==null&&(e=t._extensions={});r&&u==null&&(u=t._altViewType=t.tagged("view-type-inline-editor")?"Form":"");u&&(r=u);i=e[r];i==null&&(o=f?f[r]:null,i=t._extensions[r]=o?new o(this):0,i&&i.initialize())}return i},_attachBehaviors:function(){},_detachBehaviors:function(){},_lookupActionProcessing:function(n){return n!=null&&(this._standardActionProcessing=!n),this._standardActionProcessing!==!0},search:function(n){function o(n){return g(Date,n)&&(n=new Date(n-n.getTimezoneOffset()*6e4)),String.format("%js%{0}",h(n))}var t=this,i=n.filter,r=[],u,f,e,s;if(n){if(n.sortExpression&&(t._sortExpression=n.sortExpression,u=t.readContext("vitals"),u&&(u.SortExpression=n.sortExpression)),n._filter&&(t._filter=n._filter.slice(0)),i){if(!g(Array,i)){for(f in i)e=i[f],r.push({name:f,operator:g(Array,e)?"in":"",value:e});i=r;r=[]}$(i).each(function(){var n=this,t=n.value==null?n.values:n.value,i=n.operator||"=",u;i.match(/\w/)&&(i="$"+i+"$");g(Array,t)?(u=[],$(t).each(function(n){n>0&&u.push(i==="$between$"?"$and$":"$or$");u.push(o(this))}),t=u.join("")):t=o(t);r.push(String.format("{0}:{1}{2}",n.name||n.field,i,t))});t._filter=r}n._init||t.sync()}else return t._lookupActionProcessing(!1),s=t._hasSearchAction&&t.executeActionInScope(["ActionBar","Form"],"Search",null,-1),t._lookupActionProcessing(!0),s},_executeSearch:function(i){var u=this,h=u.get_action(i),c,o,f,s,l;if(!h||h.Confirmation&&h.Confirmation.match(/_controller\s*=/)){if(t){var y=t.dataView(),p=y.data(),a,r,e,v=[];for(a in p)e=p[a],e!=null&&(r=y.findField(a),r&&r.AliasIndex===r.Index&&(!r.Hidden||r.OriginalIndex!==r.Index)&&(e=r.format(e),v.push(r.HeaderText+": "+e)));u._searchParamFilterStatus=v.join("; ")+(v.length?".":"")}u._clearSelectedKey();u._cancelConfirmation();t?u._syncKey=!0:u.refreshAndResize()}else for(c=ht.getComponents(),o=0;o<c.length;o++)f=c[o],g(n,f)&&f._hasSearchAction&&(s=f.get_action(f._hasSearchAction),s&&s.Confirmation&&(l=s.Confirmation.match(/_controller\s*=\s*(\w+)/),l&&l[1]===u._controller&&f.search()))},filterByFirstLetter:function(n){var t=this._firstLetters[0],i=this._firstLetters[n];this.applyFieldFilter(this.findField(t).Index,"$beginswith",[i])},_renderFilterDetails:function(i,r,u){function ht(n){for(var t=p+1;t<r.length;){if(r[t].match(/^(_match_|_donotmatch)/))break;t++}return t-p>2?ut[n+"PastTense"]:n.startsWith("DoNot")?ut.DidNotMatch:ut.Matched}function ot(n,t,i){return n.getHours&&(!n.getHours()&&!n.getMinutes()&&!n.getSeconds()||i&&n.getHours()===23&&n.getMinutes()===59&&n.getSeconds()===59)?String.format("{0:d}",n):t}for(var ft=!1,o=this,v,d,et=o.viewProp&&o.viewProp("deepSearchInfo"),w=0,g,y,l,s,a,rt,k,p=0;p<r.length;p++){var c=r[p].match(n._fieldFilterRegex),nt=c[1]==="_quickfind_",f=nt?o._fields[0]:o.findField(c[1]),b;if(!f&&c[1].match(/\,/)&&et){g++>0&&i.append("; ");i.append(et[c[1].replace(/\W/g,"_")+(w-1)]);continue}if(!f||o._fieldIsInExternalFilter(f)){c[1]==="_match_"?b="Match":c[1]==="_donotmatch_"&&(b="DoNotMatch");b&&(b+=c[2]==="$all$"?"All":"Any",w>0&&i.append(". "),i.append(ht(b)),i.append(": "),w++,g=0);continue}ft||(u!==!1&&i.appendFormat('<a href="javascript:" onclick="$find(\'{0}\').clearFilter(true);return false" class="Close" tabindex="{3}" title="{2}">&nbsp;<\/a><span class="Details"><span class="Information">&nbsp;<\/span>{1} ',o.get_id(),e.InfoBar.FilterApplied,kr.Close,$nextTabIndex()),ft=!0);var tt=f,h=n._filterIteratorRegex.exec(c[2]),it=!0;for(!f||t&&f.IsPrimaryKey&&oi()||(tt=o._allFields[f.AliasIndex]);h&&(h[1].startsWith("~")||!(f.Index===f.AliasIndex&&f.IsPrimaryKey&&f.Hidden));){if(it?i.appendFormat('<span class="FilterElement" onclick="$find(\'{0}\').removeFromFilterByIndex({1})" title="{2}">',o.get_id(),nt?-1:f.Index,nt?gr:n.htmlAttributeEncode(String.format(gt.ClearFilter,f.Label))):i.append(", "),h[1].startsWith("~"))i.appendFormat(String.format('{0} <b class="String">{1}<\/b>',e.InfoBar.QuickFind,o.convertStringToFieldValue(f,h[3]))),v=t&&o.viewProp("quickFindHint"),v&&(v=v.split(";"),i.append(" "+ut.In+" "),v[0]?i.append(o.get_view().Label):d=!0,$(t._pages).each(function(){var r=this,n=r.dataView,t;n&&o._id===n._filterSource&&(t=v.indexOf(n._controller+"."+n._viewId+"."+n._filterFields),t!==-1&&(d?d=!1:t===v.length-1?i.append(" "+gi+" "):i.append(", "),i.append(n.get_view()&&n.get_view().Label||r.text)))}));else if(g++>0&&i.append("; "),i.appendFormat('<span class="Highlight">{0}<\/span>',o._fieldNameHint&&o._fieldNameHint[tt.Name]||tt.HeaderText),y=n.filterDef(li[f.FilterType].List,f.FilterType==="Boolean"&&h[3].length>1?h[3]==="%js%true"?"$true":"$false":h[1]),y)if(y.Prompt){if(i.appendFormat(" {0} ",y.Text.toLowerCase()),s=h[3],a=s.split(n._listRegex),String.isJavaScriptNull(a[0])&&(a[0]=e.InfoBar.Empty),!String.isJavaScriptNull(h[2]))for(rt=a[0].match(/^([\s\S]+?)\0?$/),rt&&(a[0]=rt[1]),s=o.convertStringToFieldValue(f,a[0]),l=o._findItemByValue(f,s),i.appendFormat("<b>{0}<\/b>",String.htmlEncode(l?l[1]:ot(s,f.format(s)))),k=1;k<a.length;k++)if(i.appendFormat("{0} ",h[1]==="$between$"?" "+gi:", "),s=o.convertStringToFieldValue(f,a[k]),s==null?s=gt.EmptyValue:(l=o._findItemByValue(f,s),s=l?l[1]:ot(s,f.format(s),!0)),i.appendFormat('<b class="{1}">{0}<\/b>',String.htmlEncode(s)),k>5){i.append(", ..");break}}else i.appendFormat(" {0} <b>{1}<\/b>",dt.Equals,y.Function.match(n._keepCapitalization)?y.Text:y.Text.toLowerCase());else{switch(h[1]){case"=":i.append(String.isJavaScriptNull(h[2])?e.InfoBar.Empty:e.InfoBar.EqualTo);break;case"<":i.append(e.InfoBar.LessThan);break;case"<=":i.append(e.InfoBar.LessThanOrEqual);break;case">":i.append(e.InfoBar.GreaterThan);break;case">=":i.append(e.InfoBar.GreaterThanOrEqual);break;case"*":i.append(h[2].startsWith("%")?e.InfoBar.Like:e.InfoBar.StartsWith)}l=o._findItemByValue(f,o.convertStringToFieldValue(f,h[3]));s=l==null?h[3]:l[1];s=String.isJavaScriptNull(h[3])||st(s)?e.InfoBar.Empty:o.convertStringToFieldValue(f,s);i.appendFormat("<b>{0}<\/b>",String.htmlEncode(s))}h=n._filterIteratorRegex.exec(c[2]);it=!1}it||w||o._fieldNameHint||i.append(".");i.append("<\/span> ")}w&&i.append(". ");i.append("<\/span>")},_findItemByValue:function(n,i){var u=n.DynamicItems||n.Items,r=n.ItemCache;return u.length?(r||(r=n.ItemCache={},$(u).each(function(){var n=this;r[n[0]]=n})),n.ContextFields?[i,i]:r[i]||[null,this.get_isForm()||t?yi:nu]):null},refreshAndResize:function(){this.goToPage(-1)},refreshData:function(){var n=this;n._busy()||(n._clearCache(),n.set_pageIndex(-2),n._loadPage())},_dittoCollectedValues:function(n,t){var r,i,f,s;if(this.editing()){var e=t?new RegExp(String.format("^{0}(Length|ContentType|FileName|FullFileName)?$",t)):null,o=this._collectFieldValues(!0),u=[];for(r=0;r<o.length;r++)i=o[r],e&&i.Name.match(e)||Array.add(u,{name:i.Name,value:i.Modified?i.NewValue:i.OldValue});if(n)for(r=0;r<n.length;r++){for(i=n[r],f=0;f<u.length;f++)if(s=i.Name?i.Name:i.name,u[f].name===s){Array.removeAt(u,f);break}Array.add(u,i.Name?{name:i.Name,value:i.NewValue}:i)}this._ditto=u}},refresh:function(n,i,r){var u=this,f;u._dittoCollectedValues(i,r);u._lastSelectedCategoryTabIndex=u.get_categoryTabIndex();n?u._render():t?(f=u.get_parentDataView(this),f==u?u.sync():f._syncKey=f.get_selectedKey()):(u.goToView(u.get_viewId()),u._ditto=null)},session:function(n,t,i){var u=this,r=u._pageSession;if(r||(r=u._pageSession={}),n=(i||u._viewId||"grid1")+"_"+n,arguments.length===1)return r[n];t!=null?r[n]=t:delete r[n]},sessionRemove:function(n){var r=this,t=r._pageSession,u=[],i;if(t){n=r._viewId+"_"+n;for(i in t)i.indexOf(n)||u.push(i);u.forEach(function(n){delete t[n]})}},readContext:function(n){return this.session(n)},writeContext:function(n,t){this.session(n,t)},_saveViewVitals:function(){},_restoreViewVitals:function(){},paramValue:function(n,t){this._paramValues||(this._paramValues=[]);this._paramValues.push({Name:n,Value:t})},_useSearchParams:function(n){var t=this._paramValues,r,i,u;if(t?(this._searchParamValues=t,this._paramValues=null):t=this._searchParamValues,t){for(r=Array.clone(n.ExternalFilter),i=0;i<t.length;i++)u=t[i],Array.add(r,{Name:u.Name,Value:u.NewValue});n.ExternalFilter=r}},_forceSync:function(){var n=this,i;n._skipSync||t&&n.get_isForm()?n._skipSync=!1:(i=n.get_selectedKey(),i&&i.length&&(n._syncKey=i))},sync:function(n,t){var i=this,r,e,f,u;if(i._clearCache(),n){for(i._skipAutoSelect=!0,oi()&&(u=[]),g(Array,n)||(n=[n]),e=[],r=0;r<i._keyFields.length;r++)f=i._keyFields[r],e[f.Index]=n[r],u?u.push(f.Name+":=%js%"+JSON.stringify(n[r])):i._syncFilter||i.removeFromFilter(f);u&&i.set_filter(u);i._raiseSelectedDelayed=!0;i._pendingSelectedEvent=!0;i._selectKeyByRow(e);i.multiSelect()&&(i._selectedKeyList=[n.join(",").toString()]);t&&(i._requiresContextRefresh=!0)}clearTimeout(i._syncTimeout);i._forceSync();i.refreshAndResize();i._synced=!0},_sync:function(){var n=this,t=n._viewColumnSettings;n._viewColumnSettings=[];n.sync();n._viewColumnSettings=t},syncOnce:function(n,i){function e(i){var f=$("#"+(r._dataViewFieldOwnerId||r._id));clearTimeout(r._syncTimeout);!t.busy()&&!t.isInTransition()&&(!n||u)&&r._fields&&i&&f.is(".ui-page-active")?r.sync():r._syncTimeout=setTimeout(e,100,!0)}var f=this,u=f.findField(n),r=u?o(u._dataViewId):f,s=r._createParams().ExternalFilter;e(i)},combinedFilter:function(){return this._combinedFilter(this.get_filter())},dataSignature:function(){var n=this.combinedFilter();return h(n)},_combinedFilter:function(n){var r=this,i;return t&&r.asearch("active")&&(i=r.asearch("filter"),i&&i.length&&($(n).each(function(){if(this.startsWith("_quickfind_"))return n.splice(n.indexOf(this),1),!1}),n=(n||[]).concat(i))),n},_createParams:function(i){var u=this,e=u.get_lookupContext(),a=u.get_viewType(),y=u.extension(),p=u._lookupInfo,v,h=o(u._dataViewFieldOwnerId),c,w=u._syncKey;if(r(a)&&(a=u.readContext("GridType")),u.get_searchOnStart()&&p&&p.value!=null&&u.set_searchOnStart(!1),h&&(c=h.findField(u._dataViewFieldName),c&&c.ContextFields)){var l=u.get_externalFilter(),b={},k=h.values();$(l).each(function(){var n=this;b[n.Name]=n});h._fields.forEach(function(n){if(n._dataViewId&&n._dataViewId!==u._id){var i=o(n._dataViewId),r=i._keyFields,t=[],f;r&&(f=i.data(),r.forEach(function(n){t.push(f[n.Name])}));t=t.length<2?t.length?t[0]:null:t.join();k.push({Name:n.Name,OldValue:t})}});$(h.get_contextFilter(c,k)).each(function(){var n=this,t=n.Value==null,i=b[n.Name];i?t?l.splice(l.indexOf(i)):i.Value=n.Value:t||l.push(n);t&&u.removeFromFilter(n.Name)});u.applyExternalFilter(!0)}var d=u.get_confirmContext(),s=u._api,f={PageIndex:u.get_pageIndex(),PageSize:u.get_pageSize(),PageOffset:u.get_pageOffset(),SortExpression:u.get_sortExpression(),GroupExpression:u.get_groupExpression(),Filter:u._combinedFilter(u.get_filter()),ContextKey:u.get_id(),FilterIsExternal:u._externalFilter.length>0,LookupContextFieldName:e?e.FieldName:null,LookupContextController:e?e.Controller:null,LookupContextView:e?e.View:null,LookupContext:e,Inserting:u.inserting(),LastCommandName:u.get_lastCommandName(),LastCommandArgument:u.get_lastCommandArgument(),ExternalFilter:u.get_externalFilter(),DoesNotRequireData:u.get_searchOnStart(),LastView:u.get_lastViewId(),Tag:u.get_tag(),RequiresFirstLetters:u.get_showFirstLetters(),ViewType:a,SupportsCaching:ft.agent!=ft.InternetExplorer||ft.version>7||ot!=null||n.embedded,SystemFilter:y?y.systemFilter():null,RequiresRowCount:u._requiresRowCount==!0,QuickFindHint:t?u.viewProp("quickFindHint"):null,RequiresPivot:u._requiresPivot==!0,PivotDefinitions:u._pivotDefinitions?u._pivotDefinitions:null};return s&&(u._distinctValues&&(f.Distinct=!0),f.SupportsCaching=!1,s.DoesNotRequireData&&(f.DoesNotRequireData=!0),f.MetadataFilter=s.metadataFilter,f.FieldFilter=s.fieldFilter,s.requiresAggregates==!1&&(f.DoesNotRequireAggregates=!0),s.inserting&&(f.Inserting=!0)),u.tagged("inline-editing")&&(f.DoesNotRequireAggregates=!0),d&&(v=Array.clone(f.ExternalFilter),Array.addRange(v,d.Values),f.ExternalFilter=v),u._useSearchParams(f),u._position&&(u._position.changing&&(f.PageIndex=u._position.index,f.PageSize=1,f.Filter=u._position.filter,f.SortExpression=u._position.sortExpression,f.RequiresMetaData=!0),i&&(f.Filter=u._selectedKeyFilter)),typeof w!="boolean"&&(f.SyncKey=w),u.useCase("$app")&&(f.RequiresMetaData=!0),f},_createArguments:function(n,t,i){var r=this,s,h,u,f,e,c;if(i||(i=r._collectFieldValues()),t||(t=r.get_viewId()),n.values&&(i=Array.clone(n.values)),r._paramValues&&(i=Array.clone(i),Array.addRange(i,r._paramValues),delete r._paramVlaues),u=r._inlineEditor?o(r.session("targetDataView").id):r,f={CommandName:n.commandName,CommandArgument:n.commandArgument,Path:n.path,LastCommandName:r.get_lastCommandName(),Values:i,ContextKey:u.get_id(),Controller:r.get_controller(),View:t,LastView:u.get_lastViewId(),Tag:u.get_tag(),Trigger:n.trigger},f.Filter=u._combinedFilter(u.get_filter()),f.SortExpression=u.get_sortExpression(),f.GroupExpression=u.get_groupExpression(),f.SelectedValues=u.get_selectedValues(),h=f.ExternalFilter=Array.clone(u.get_externalFilter()),h.length||(s=u.get_parentDataView(u),r!==s&&s._externalFilter.forEach(function(n){h.push(n)})),n.commandName==="PopulateDynamicLookups")for(e=0;e<r._allFields.length;e++)c=r.get_contextFilter(r._allFields[e],i),c.length>0&&Array.addRange(f.ExternalFilter,c);return f},_loadPage:function(){var n=this,t=n._survey,f=n._skipInvoke,i,r,u;(n._isBusy&&n._cancelWSRequest(),n._delayedLoading=!1,n._source)||(n.get_mode()!=Web.DataViewMode.View?(n._allFields=[ar({Index:0,Label:"",DataFormatString:"",AliasIndex:0,ItemsDataController:n.get_controller(),ItemsNewDataView:n.get_newViewId(),ItemsDataView:n.get_viewId(),_dataView:n,Behaviors:[]})],n._fields=n._allFields,n._render()):(f||(n._busy(!0),n._detachBehaviors(),n._showWait()),i=n._createParams(),f?n._invokeArgs=i:(n._restoreViewVitals(i),r={controller:n.get_controller(),view:n.get_viewId(),request:i},u=new v(n),u.before({commandName:"Select",commandArgument:r.view}),u.dispose(),t&&t.result?(n._onGetPageComplete(t.result,null),t.result=null):n._startPage?(n._onGetPageComplete(n._startPage,null),n._startPage=null):n._invoke("GetPage",r,Function.createDelegate(n,n._onGetPageComplete)))))},_cancelWSRequest:function(){var n=this._wsRequest;n&&(this._wsRequest=null,n.get_executor&&!n.completed()&&(!ft.agent==ft.InternetExplorer||ft.version>9)&&n.get_executor().abort())},_invoke:function(i,r,u,f,e){function v(){n.logout(function(){n.alert(Web.MembershipResources.Bar.UserIdle,function(){location.reload()})})}function y(t,h,c){if(!n._navigated){var l=t.get_statusCode();l?l===401&&i!=="Login"?s&&s.refresh_token?n.refreshUserToken(s,function(){o._invoke(i,r,u,f,e)},v):v():l>0&&(o._onMethodFailed(t,h,c),e&&e()):n.confirm(b.ConnectionLost,function(){o._invoke(i,r,u,f,e)},function(){o._onMethodFailed(t,h,c)})}}var o=this,h=o.get_servicePath(),l=n.ensureJSONCompatibility,s=n.AccountManager.current(),a={};s&&s.access_token&&i!=="Login"&&(a.Authorization="Bearer "+s.access_token);o._autoRefresh(!0);r.args&&l(r.args.Values);r.request&&r.request.Filter&&l(r.request.Filter);r.request&&r.request.ExternalFilter&&l(r.request.ExternalFilter);h.match(/\.asmx/)?o._wsRequest=c.Net.WebServiceProxy.invoke(h,i,!1,r,function(n,t,r){n&&n.ExceptionType?o._onMethodFailed(pi(i,n),null,f):u(n,t,r)},y,f):d.invoke(o,{url:h+"/"+i,method:"POST",cache:!1,dataType:"text",headers:a,data:r}).done(function(r){var s=typeof r=="string",h,e;t&&i==="GetPage"&&s&&(o.tagged("system-replacegetpagetemplate")?(h=o.get_parentDataView(o),h.session("getPageTemplate",r)):o.session("getPageTemplate")||o.session("getPageTemplate",r));e=s?n.parseJSON(r,o._nativeDates):r;e&&e.RedirectUrl?location.href=e.RedirectUrl:e&&e.ExceptionType?o._onMethodFailed(pi(i,e),null,f):u(e,f)}).fail(function(n,t,r){y(pi(i,r,n,t),n,i)})},_disposeFields:function(){var n,t;if(this._allFields)for(n=0;n<this._allFields.length;n++)t=this._allFields[n],t._dataView=null,t._listOfValues&&Array.clear(t._listOfValues)},_formatViewText:function(n,t,i){var u=this._views.length>0?this._views[0].Label:this._view?this._view.Label:"";return r(n)?i:String.format(n,t==!0?u.toLowerCase():u)},_autoRefresh:function(n){var i=this,r=i._refreshInterval;r&&(i._riTimeout&&(clearTimeout(i._riTimeout),i._riTimeout=null),n||(i._riTimeout=setTimeout(function(){i.get_isForm()||(t?i.syncOnce():i.sync())},r*1e3)))},_clearCache:function(n){var t=this._cachedPages,r,f=$.Event("reset.dataview.app"),i,u;if(t){for(i=0;i<t.length;i++)u=t[i],Array.clear(u.rows),delete u.rows;Array.clear(t);delete this._cachedPages}r=this.extension();r&&r.reset(n==null||n===!0);f.dataView=this;tt.trigger(f)},_supportsCaching:function(n){return n==="DataSheet"||n==="Grid"&&t},_cacheResult:function(n){var s=n.PageSize,o=n.PageSize<n.Rows.length,l=this.get_viewType(),t,p,e,i,f,v,r,u,y;if(o||l||(l=this.readContext("GridType")),o||(o=this._supportsCaching(l)),!o&&!l&&n.Views)for(t=0;t<n.Views.length;t++)if(p=n.Views[t],p.Id===n.View){o=this._supportsCaching(p.Type);break}if(o&&n.SupportsCaching){e=n.Rows;n.Rows=[];i=this._cachedPages;i||(i=this._cachedPages=[]);var a=n.PageIndex,h=0,c=s-1;for(a>0&&(e.length<=s*2?(h=s,c=e.length-1):(h+=s,c+=s)),f={index:a,rows:[]},t=h;t<=c;t++)v=e[t],v&&(n.Rows.push(v.slice(0)),f.rows.push(v));if(r=null,h>0)for(r={index:a-1,rows:[]},t=0;t<h;t++)r.rows.push(e[t]);if(u=null,c<e.length-1)for(u={index:a+1,rows:[]},t=c+1;t<e.length;t++)u.rows.push(e[t]);for(t=0;t<i.length;)y=i[t],f!=null&&y.index==f.index?(i[t]=f,f=null):r!=null&&y.index==r.index?(i[t]=r,r=null):u!=null&&y.index==u.index?(i[t]=u,u=null):t++;(f||r||u)&&(i.length>100&&i.splice(0,3),f&&i.push(f),r&&i.push(r),u&&i.push(u))}},_onGetPageComplete:function(i){var f=this,ci=i.NewRow,nt=ci,a=i.Fields||[],o,wt,bu,bt,dt,nf,ai,u,ri,vi,ui,fi,tf,yi,tt,vr,pi,yr,rf,uf,pr,ei,wr,br,ft,l,ff,ki,kr,h,gr,di,ef,nu,gi,ct,tu,nr,tr,iu,ir,y,lt,uu,s,si,rr,p,ut,k,w,fu,eu,or,ou,su,cu,sr,lu,ht,au,vu,yu,hi,hr,cr,hf,cf,pu,lf,wu;if(f._syncKey&&(f._syncKey=null),f._busy(!1),f._completeCallback){bu=f._completeCallback;f._completeCallback=null;bu.call(this,i);f._completeConfig=null;return}if(bi(i,ru,[]),f._fields||(f._viewId=i.View),f._containerIsHidden&&(c.UI.DomElement.setVisible(f._container,!0),f._containerIsHidden=!1),f.set_tag(i.Tag),i.FirstLetters!==""&&(f._firstLetters=i.FirstLetters?i.FirstLetters.split(/,/):null),bt=f._position&&f._position.changed,f._cacheResult(i),f._pageIndex<0||bt){if(this._pageIndex===-1||bt){if(v.reset(f._controller),f._disposeFields(),wt=f._expressions=i.Expressions,f._detachBehaviors(),f._allFields=a,f._mapOfAllFields={},f._fields=[],dt=[],f._keyFields&&this._selectedKey.length>0){for(o=0;o<f._keyFields.length;o++)dt[o]={name:this._keyFields[o].Name,value:f._selectedKey[o]};f._selectedKey=[]}f._keyFields=[];var ku=!1,gt=!1,du=[],gu=0,lr;if($(i.Views).each(function(){var n=this;i.View===n.Id&&(n.HeaderText=i.ViewHeaderText,f.tagged("view-type-inline-editor")?(n.Type="Form",n.HeaderText=null,f._inlineEditor=!0,f.tag("modal-fit-content")):n.Layout=i.ViewLayout,lr=n.Type);n.ShowInSelector==null&&(n.ShowInSelector=!0)}),f._views=i.Views,lr==="Form"){for(o=0;o<a.length;o++)if(a[o].IsPrimaryKey){nf=!0;break}nf||a.push({Name:"sys_pk_",ReadOnly:!0,Type:"Int32",IsPrimaryKey:!0,Hidden:!0})}for(o=0,$(a).each(function(){var n=this;f._mapOfAllFields[n.Name]=n;n.OriginalIndex=n.Index=o++;wi(n);n.Name==="Status"&&(ku=!0)}),ku||(f._mapOfAllFields.Status=a[a.length]={Name:"Status",ReadOnly:!0,Type:"String",AllowNulls:!0,Hidden:!0,Index:a.length,_system:!0,HeaderText:at.Status}),ai=n._commandLine.match(/\W_display=(.+?)(&|$)/),o=0;o<a.length;o++){if(u=a[o],ri=u.Index,ui=u.Name,vi=u.DataViewFilterSource,u.tagged=_field_tagged,u.is=_field_is,u.tag=_field_tag,fi=r(u.AliasName)?null:this.findField(u.AliasName),u.AliasIndex=fi?fi.Index:o,fi&&(fi.OriginalIndex=ri),u.ItemsDataController&&!u.ItemsTargetController&&(u.AliasName||u._autoAlias||u.ItemsDataValueField===u.ItemsDataTextField||lr!=="Form"||(u._autoAlias=!0),u._autoAlias&&(tt={Name:ui+"_auto_alias_",ReadOnly:!0,Type:"String",Index:a.length,Label:u.Label,AllowNulls:!0,Items:[],htmlEncode:!0,Hidden:!0,OriginalIndex:ri},wi(tt),tt.AliasIndex=tt.Index,u.AliasIndex=tt.Index,a.push(tt),f._mapOfAllFields[tt.Name]=tt,u.Items&&nt&&(vr=nt[ri],vr&&$(u.Items).each(function(n,t){t[0]==vr&&(nt[tt.Index]=t[1])})))),oi()&&f._lookupInfo&&(pi=f._lookupInfo.field,yr=pi.Copy,pi.ItemsStyle!=="Lookup"&&(u.Name===pi.ItemsDataTextField||yr&&yr.match(new RegExp("="+u.Name+"\\b"))||(u.Hidden=!0))),(!u.Hidden||ai)&&f._fieldIsInExternalFilter(u)&&f.get_hideExternalFilterFields()){if(rf=u.Hidden,u.Hidden=!0,u.Copy)while(tf=n._fieldMapRegex.exec(u.Copy))yi=this.findField(tf[1]),yi&&yi.ReadOnly&&(yi.Hidden=!0);ai&&Array.indexOfCaseInsensitive(ai[1].split(","),ui)!=-1&&(rf||(u.Hidden=!1),this.inserting()&&(uf=new RegExp(String.format("\\W{0}=(.*?)(&|$)",ui)),pr=n._commandLine.match(uf),pr&&(nt||(nt=[]),nt[o]=decodeURIComponent(pr[1]))))}vi&&u.Type==="DataView"&&(wr=i.View,br="!$row."+vi+"._ready||$row."+vi+"._selected",wt||(wt=this._expressions=[]),$(wt).each(function(){var n=this;return n.Scope===3&&n.Target===u.Name&&n.ViewId===wr&&(ei=n),!!ei}),ei?ei.Test=br+"&&("+ei.Test+")":wt.push({Type:1,Scope:3,Target:ui,ViewId:wr,Test:br}));u.Behaviors=[];ft=u.is("persist");ft&&(u._persist=ft,ri!==u.AliasIndex&&(a[u.AliasIndex]._persist=ft))}if(n.newValues&&(this._ditto||(this._ditto=[]),this._ditto=this._ditto.concat(n.newValues),n.newValues=null),nt&&this._ditto)for(o=0;o<a.length;o++)if(u=a[o],nt[o]!=null)for(l=0;l<this._ditto.length;l++)if(this._ditto[l].name===u.Name&&!this._ditto[l].duplicated){Array.removeAt(this._ditto,l);break}for(this._ignoreNewRow=!0,this._hasDynamicLookups=!1,this._requiresConfiguration=!1,ff=0,o=0;o<a.length;o++){if(u=a[o],u._dataView=this,u.Hidden||Array.add(this._fields,u),u.IsPrimaryKey)for(Array.add(this._keyFields,u),l=0;l<dt.length;l++)if(dt[l].name===u.Name){Array.add(this._selectedKey,dt[l].value);break}u.FilterType="Number";switch(u.Type){case"Time":case"String":u.FilterType="Text";break;case"Date":case"DateTime":case"DateTimeOffset":u.FilterType="Date";break;case"Boolean":u.FilterType="Boolean"}if(u.OnDemand&&(ki=u.Name,kr=f.findField(ki+"Length")||f.findField(ki+"LENGTH")||f.findField(ki+"length")||f.findField("Length")||f.findField("LENGTH")||f.findField("length"),kr&&(kr._smartSize=!0),u.OnDemandStyle||this.inserting()||(f._headerImageField||(f._headerImageField=u),u.tagged("header-image")&&(f._headerImageField=u))),h=u.SearchOptions,h&&(h=h.replace(/\$quickfind(\w+)?\s*/gi,"")),st(h)||__tf!=4)u.SearchOptions=null;else{for(h=h.replace(/\s+/g,",").split(/,/),u.AllowAutoComplete=!Array.contains(h,"$disableautocomplete"),u.AllowAutoComplete||Array.remove(h,"$disableautocomplete"),u.AllowSamples=!Array.contains(h,"$disablesamples"),u.AllowSamples||Array.remove(h,"$disablesamples"),u.AllowMultipleValues=!Array.contains(h,"$disablemultiplevalues"),u.AllowMultipleValues||Array.remove(h,"$disablemultiplevalues"),u.AutoCompleteAnywhere=Array.contains(h,"$autocompleteanywhere"),u.AutoCompleteAnywhere&&(Array.remove(h,"$autocompleteanywhere"),a[u.AliasIndex].AutoCompleteAnywhere=!0),l=0,gr=!1;l<h.length;)di=h[l]=h[l].trim(),di==="*"&&(gr=!0),di.length>0&&di!=="*"?l++:Array.removeAt(h,l);gr&&h.length>0&&(ef=li[u.FilterType],this._enumerateMissingSearchOptions(h,ef.List));Array.contains(h,"$in")&&!Array.contains(h,"$notin")&&Array.add(h,"$notin");u.SearchOptions=h.length?h:null;u.SearchOptions&&t&&u.OriginalIndex!==u.Index&&(a[u.OriginalIndex].SearchOptions=u.SearchOptions)}ar(u);_field_prepareDataFormatString(this,u);var g=u.ItemsStyle,it=u.Items,of=u.ItemsDataController;u.Type==="Boolean"&&(it.length?$(it).each(function(){var n=this[0];typeof n=="string"&&(this[0]=n.length?n==="true":null)}):(it=u.Items=Array.clone(u.AllowNulls?b.BooleanOptionalDefaultItems:b.BooleanDefaultItems),g||(g=u.ItemsStyle=b.BooleanDefaultStyle)));it&&it.length>0&&(u.AllowNulls&&!u.ItemsTargetController||g==="DropDownList"&&!of)&&!r(it[0][0])&&g!="CheckBoxList"&&!u.tagged("lookup-null-value-none")&&er(u,it);g&&(g==="Actions"&&(g=u.ItemsStyle="ListBox",u._actionGroup=!0),u.ContextFields&&g!=="Lookup"&&g!=="AutoComplete"&&of?(this._hasDynamicLookups=!0,u.ItemsAreDynamic=!0):g==="UserNameLookup"?(u.ItemsStyle="Lookup",u.ItemsDataController="aspnet_Membership",u.ItemsDataTextField="UserUserName",u.ItemsDataValueField="UserUserName",u.ItemsValueSyncDisabled=!0,fr()?u.ItemsNewDataView="createForm1":(u.ItemsDataView="lookup",u.ItemsDataTextField="UserName",u.ItemsDataValueField="UserName",u.Tag="lookup-details-hidden")):g==="UserIdLookup"&&(u.ItemsStyle="Lookup",u.ItemsDataController="aspnet_Membership",u.ItemsDataTextField="UserUserName",u.ItemsDataValueField="UserId",fr()?u.ItemsNewDataView="createForm1":(u.ItemsDataView="lookup",u.ItemsDataTextField="UserName",u.Tag="lookup-details-hidden")),f._inlineEditor&&t.pointer("mouse")&&(g==="RadioButtonList"||g==="ListBox")&&(u.OriginalItemsStyle=g,u.ItemsStyle="DropDownList"));r(u.ToolTip)||(u.ToolTip=n.htmlAttributeEncode(u.ToolTip));u.Watermark||u.AllowNulls||it&&it.length||(u.Watermark=rt.Required);r(u.Configuration)||(this._requiresConfiguration=!0);u.AllowLEV&&(this._allowLEVs=!0);u.TextMode===2&&r(u.Editor)&&(t||(c.Extended.UI.HtmlEditorExtenderBehavior||typeof CKEDITOR!="undefined"?u.ClientEditor="Web$DataView$RichText":u.Editor="RichEditor"),u.HtmlEncode=!1);!t&&u.Editor&&(this._executeClientEditorFactories(u)?(u.ClientEditor=u.Editor,u.Editor=null):u.EditorId=String.format("{0}_Item{1}",this.get_id(),u.Index));u.ColIndex=u.Hidden?-1:ff++;nu=n.Geo;u.tagged("header-text")&&(f._headerField=u);u.tagged("modified-","created-")&&u.tagged("modified-latitude","modified-longitude","modified-coords","created-latitude","created-longitude","created-coords")&&(u._geocode=!0,gi=n.GeoQueue,ii=ot?ot.geolocation:navigator.geolocation,ii&&(gi||(gi=n.GeoQueue=[]),(!u.tagged("created-")||f.inserting())&&(f._geoCookie||(f._geoCookie=(new Date).getTime()),gi.push({dv:f._id,field:u.Name,cookie:f._geoCookie})),u.TextMode=4,vt==null&&(vt=ii.watchPosition(hu,function(n){nu.error=n;nu.acquired=!1}))));gt||(u.tagged("map-")&&!u.tagged("map-none")?gt=!0:(ct=u.Name.match(/\b(address|city|state|region|postal(.*?)code|zip(.*?)code|zip|country)\b/i),ct&&!u.tagged("map-none")&&(ct=ct[1].toLowerCase(),du.push({field:u,tag:ct}),ct.match(/address|city/)&&gu++)))}for(f._fields.length||(f._fields.push(a[0]),a[0].Hidden=!1),this.untag("supports-view-style-map"),gt||gu!==2||(gt=!0,$(du).each(function(){this.field.tag("map-"+this.tag);this.tag==="address"&&this.field.tag("action-location")})),gt&&this.tag("supports-view-style-map"),i.LEVs&&this._recordLEVs(i.LEVs),tu=f.get_view().Tags,tu&&f.tag(tu),f.tagged("header-image-none")&&(f._headerImageField=null),nr=f.tagged(/\bpersist\-(session|user)-(\w+)\b/),f._persist=nr?{scope:nr[1],command:nr[2]}:null,f._view=null,this._lastViewId||this.get_isForm()||(this._lastViewId=i.View),f._actionGroups=i.ActionGroups?i.ActionGroups:[],f._statusBar=i.StatusBar,tr=/^(true|false)\:(.+)$/,iu=0,f._actionColumn=null,ir=f._dynamicActions={},o=0;o<this._actionGroups.length;o++)for(y=this._actionGroups[o],y.maxTextLength=0,y.groupText=[],lt=ni[y.Scope],lt&&lt._Self&&(uu=lt._Self[y.HeaderText],uu&&(y.HeaderText=uu.HeaderText)),y.Scope==="ActionColumn"&&(this._actionColumn=r(y.HeaderText)?ti.ActionColumnHeaderText:y.HeaderText),y.Id||(y.Id="auto"+iu++),y.CssClassEx=String.format("Actions-g-{0} ",y.Id),l=0;l<y.Actions.length;l++)s=y.Actions[l],si=s.CommandName||"",s.Id||(s.Id="auto"+iu++),s.CausesValidation==null&&(s.CausesValidation=!0),s.Path=String.format("{0}/{1}",y.Id,s.Id),rr=s.Confirmation,si==="Search"&&(this._hasSearchAction=s.Path,this._hasSearchShortcut=rr&&rr.match(/_shortcut\s*=\s*true/)),s.CssClassEx=String.format("Actions-g-{0}-a-{1} ",y.Id,s.Id),lt&&r(s.HeaderText)&&(p=lt[si],p?(p.CommandArgument&&(ut=p.CommandArgument[s.CommandArgument],ut&&(p=ut)),p.WhenLastCommandName&&(ut=p.WhenLastCommandName[s.WhenLastCommandName],ut&&(p=ut)),p.Controller&&(ut=p.Controller[this._controller],ut&&(p=ut)),si==="Confirm"&&f._confirmContext&&f._confirmContext.action.CommandName==="Search"?(s.HeaderText=dr,s.Key="Enter"):s.HeaderText=p.HeaderText,s._autoHeaderText=!0,!r(p.HeaderText)&&p.HeaderText.indexOf("{")>=0&&(s.HeaderText=p.VarMaxLen!=null&&i.Views[0].Label.length>p.VarMaxLen?p.HeaderText2:this._formatViewText(p.HeaderText)),r(s.Description)&&(s.Description=this._formatViewText(p.Description)),r(rr)&&(s.Confirmation=p.Confirmation),s.Notify||(s.Notify=p.Notify)):s.HeaderText=si),r(s.WhenView)?s.WhenViewRegex=null:(k=tr.exec(s.WhenView),s.WhenViewRegex=new RegExp(k?k[2]:s.WhenView),s.WhenViewRegexResult=k?k[1]!=="false":!0),r(s.WhenTag)?s.WhenTagRegex=null:(k=tr.exec(s.WhenTag),s.WhenTagRegex=new RegExp(k?k[2]:s.WhenTag),s.WhenTagRegexResult=k?k[1]!=="false":!0),r(s.WhenHRef)?s.WhenHRefRegex=null:(k=tr.exec(s.WhenHRef),s.WhenHRefRegex=new RegExp(k?k[2]:s.WhenHRef),s.WhenHRefRegexResult=k?k[1]!=="false":!0),s.HeaderText&&(y.maxTextLength=Math.max(s.HeaderText.length,y.maxTextLength),y.groupText.push(s.HeaderText)),s.WhenClientScript&&(ir[y.Scope]=1,ir[y.Id]=1,ir[s.Path]=1);var ur=1,sf=!1,yt=this._categories=i.Categories;for(this._tabs=[],o=0;o<yt.length;o++)if(w=yt[o],w.Index=o,w.Tab==null&&(w.Tab=""),r(w.Tab)||Array.contains(this._tabs,w.Tab)||Array.add(this._tabs,w.Tab),w.Flow==="NewColumn"&&(o>0&&ur++,sf=!0),w.ColumnIndex=ur-1,w.Id&&(fu=$get(String.format("{0}_{1}_{2}",i.Controller,i.View,w.Id)),fu&&(w.Template=fu.innerHTML)),w.Floating&&r(w.Template)){for(eu=new et('<div class="FloatingCategoryHeader"><\/div>'),l=0;l<this._allFields.length;l++)or=this._allFields[l],or.Hidden||o!==or.CategoryIndex||eu.appendFormat('<div class="FieldPlaceholder">{{{0}}}<\/div>',or.Name);w.Template=eu.toString()}if(this._tabs.length>0){for(o=0;o<yt.length;o++)w=yt[o],r(w.Tab)&&(r(yt[0].Tab)?(w.Tab=e.Form.GeneralTabText,this._tabs[0]!==e.Form.GeneralTabText&&Array.insert(this._tabs,0,e.Form.GeneralTabText)):w.Tab=yt[0].Tab),w.ColumnIndex=0;this._lastSelectedCategoryTabIndex!=null?(ou=this._focusedFieldName,this.set_categoryTabIndex(!(this._lastSelectedCategoryTabIndex>=0)||ou&&ou.startsWith("_Annotation_")?this._tabs.length-1:0),delete this._lastSelectedCategoryTabIndex):this.set_categoryTabIndex(0);su=this.get_parentDataView(this);su._lastClickedIcon==="Attachment"&&this.set_categoryTabIndex(this._tabs.length-1);su._lastClickedIcon=null;ur=1}else this.set_categoryTabIndex(-1);t||(this._numberOfColumns=sf&&!this._get_template()?ur:0)}this._filter=i.Filter;this._sortExpression=i.SortExpression;this._groupExpression=i.GroupExpression;this._updatePageCount(i,bt);cu=this.get_pagerButtonCount(!0);this._firstPageButtonIndex=Math.floor(i.PageIndex/cu)*cu;d&&d.verify(f)}else this._requiresRowCount&&(this._requiresRowCount=!1,this._updatePageCount(i,!1));for(o=0;o<a.length;o++)u=a[o],sr=a[u.AliasIndex],u.AllowAutoComplete===!1&&(sr.AllowAutoComplete=!1),u.AllowSamples===!1&&(sr.AllowSamples=!1),u.AllowMultipleValues===!1&&(sr.AllowMultipleValues=!1);if(f._icons=i.Icons,!f.inserting()){if(lu=!1,f._rows){for(f._rows.length&&i.Rows.length||delete f._viewColumnSettings,o=0;o<f._rows.length;o++)Array.clear(f._rows[o]);Array.clear(f._rows);lu=f.get_isGrid()}if(f._rows=i.Rows,lu)for(f._selectedRowIndex=null,o=0;o<f._rows.length;o++)if(f._rowIsSelected(o)){f._selectedRowIndex=o;break}}if(f._newRow=nt=nt?nt:[],i.Aggregates&&(f._aggregates=i.Aggregates),f.get_isForm()&&f._selectedRowIndex==null&&f._totalRowCount>0&&(f._selectedRowIndex=0,f._selectKeyByRowIndex(0)),bt&&(f._position.changed=!0,f._selectKeyByRowIndex(0)),t){if(vu=f._allFields,yu=f._persist,f.inserting()?ht=nt:f.editing()&&(ht=f._rows[0]),ht)for(o=0;o<vu.length;o++)u=vu[o],ft=u._persist,ft&&ht[o]==null&&(au||(au=(ft==="user"?n.userVar:n.sessionVar)("persistVars")||{}),hr=ht[o]=au[u.Name],hr!=null&&(f._showClearAll=!0));yu&&(hi=(yu.scope==="user"?n.userVar:n.sessionVar)("persist_"+f._controller+"_"+f._viewId),hi&&(hi=kt.deserialize(hi),$(hi).each(function(){var n=this,t=f.findField(n.Name);t&&n.Modified&&ht[t.Index]==null&&(hr=ht[t.Index]=n.NewValue,hr!=null&&(f._showClearAll=!0))})));f.get_isGrid()&&(cr=n.syncMap[f._controller],cr||(cr=n.syncMap[f._controller]={}),cr[f._id+"_"+f._viewId]=!1,f._autoSelect())}ci&&f.odp&&f.set_selectedKey(f.odp.key(f));f._render(!0);t||(f.get_lookupField()&&f._adjustLookupSize(),f._isInInstantDetailsMode()&&(hf=$common.getClientBounds(),cf=$common.getContentSize(document.body),resizeBy(0,cf.height-hf.height)),f._saveViewVitals(),f._pendingSelectedEvent&&(f._pendingSelectedEvent=!1,f.updateSummary()),f._registerFieldHeaderItems(),_body_resize());f._executeSecondCommand();f._autoRefresh();t||f._autoSelect();r(i.ClientScript)||eval(i.ClientScript);lf=ci?"New":"Select";wu={commandName:lf,commandArgument:i.View,view:i.View};pt(f,wu)||(pu=new v(f),pu.after(wu),pu.dispose());ci&&f.odp&&f.raiseSelected()},_updatePageCount:function(n,t){this._totalRowCount=n.TotalRowCount;this._position&&this._position.count===-1&&(this._position.count=n.TotalRowCount);this._pageIndex=n.PageIndex;t||(this._pageSize=n.PageSize,this._pageCount=Math.floor(n.TotalRowCount/n.PageSize),n.TotalRowCount%n.PageSize!=0&&this._pageCount++)},_autoSelect:function(n){var i=this,u=null,h=null,c,y=!1,f=i.tagged(/\bauto\-(highlight|select)\-first\-row(-(\w+))?/),l=f&&f[1],a=f&&f[3]==="always",e,o,s,v;if(i._skipAutoSelect&&(i._skipAutoSelect=!1,l=null),(i.get_autoHighlightFirstRow()||l==="highlight")&&(a||i.set_autoHighlightFirstRow(!1),u="Select",c="highlight"),(i.get_autoSelectFirstRow()||l==="select")&&(a||i.set_autoSelectFirstRow(!1),c="select",e=i.get_actionGroups("Grid"),e.length>0))for(o=0;o<e[0].Actions.length;o++)if(s=e[0].Actions[o],s.CommandName){u=s.CommandName;h=s.CommandArgument;y=!r(h)&!i.get_showModalForms()&&n==null;break}a&&(i._checkedAutoSelect=!1);u&&i.get_viewType()!="Form"&&i._rows.length>0&&(y&&i._hideContainer(),v=i.extension(),v?v._autoSelect={row:i._rows[n||0],action:c}:i.executeRowCommand(n||0,u,h));(!i._tryFocusDataSheet||i._forceFocusDataSheet)&&(i._tryFocusDataSheet=!0,i.get_isDataSheet()&&!i.get_lookupField()&(!i.get_filterSource()||i._forceFocusDataSheet)&&i._rows.length>0&&!t&&i.executeRowCommand(i.get_selectedKey().length>0?null:0,"Select"),i._forceFocusDataSheet=!1)},_hideContainer:function(){this._containerIsHidden=!0;this._container.style.display="none"},_enumerateMissingSearchOptions:function(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i&&!i.Hidden&&(i.List?this._enumerateExpressions(n,t):Array.contains(n,i.Function)||Array.add(n,i.Function))},_executeSecondCommand:function(t){var i,r;t?(i=n._commandLine.match(/_commandName2=(\w+)(.*?_commandArgument2=(.*?)(&|$))?/),i&&this.executeActionInScope([this.get_viewType(),"ActionBar"],i[1],i[3])):this._trySecondCommand&&(this._trySecondCommand=!1,(this.get_viewType()!="Form"||this._totalRowCount>0)&&(r=this,setTimeout(function(){r._executeSecondCommand(!0)},50)))},isDynamicAction:function(n){return!!this._dynamicActions[n]},findAction:function(n){if(n){n=n.split(/\s*\\|\/\s*/g);for(var o=this,e=o._actionGroups,r,u,f,s=n[0],h=n[1],i,t=0;t<e.length;t++)if(r=e[t],r.Id==s)for(u=r.Actions,i=0;i<u.length;i++)if(f=u[i],f.Id==h)return f}return null},_disposeFieldFilter:function(){},_stopInputListener:function(){},cancelDataSheet:function(){},_get_focusedCell:function(){},executeActionInScope:function(n,t,i,u,f){var s,a,h,e,c,o,l;for(u==null&&(u=this._selectedRowIndex),s=0;s<n.length;s++)if(a=n[s],h=this.get_actionGroups(a),h)for(e=0;e<h.length;e++)if(c=h[e].Actions,c)for(o=0;o<c.length;o++)if(l=c[o],l.CommandName==t&&(r(i)||l.CommandArgument==i)&&this._isActionAvailable(l,u))return f!=!0&&this.executeAction(a,o,u,e),!0;return!1},_allowModalAutoSize:function(){this._modalWidthFixed=!1;this._modalAutoSized=!1},_disposeModalPopup:function(){},endModalState:function(n){var i=this.get_parentDataView(),r,u;if(this.get_isModal()&&(r=this.get_exitModalStateCommands(),r))for(u=0;u<r.length;u++)if(n===r[u])return i&&(i._lookupIsActive=!1,i._skipClickEvent=!0),t?t.endModalState(i,this):this.dispose(),!0;return i&&!this.get_confirmContext()&&(t||i.refresh()),ei(),!1},_onMethodFailed:function(t){var r=this,i,u=r._viewId,f=t.get_exceptionType(),e=t.get_statusCode(),o=t.get_stackTrace(),s="///";(r._busy(!1),n._navigated)||(i=[String.format('<pre style="word-wrap:break-word;white-space:pre-wrap;margin:0px">{0}\n{1}\ncomponent: {2}; controller: {3}',t.get_message(),s,r._id,r._controller)],u&&i.push("; view: "+u),e&&i.push("; status: "+e),f&&i.push("; exception: "+f),o&&i.push("\n"+s,o),i.push("<\/pre>"),n.showMessage(i.join("")),$(this.get_element()).css("border","1px red solid"))},_createArgsForListOfValues:function(n){var i=this.get_lookupContext(),r=this._searchBarVisibleIndex==null?this.get_filter():this._createSearchBarFilter(!0),u={FieldName:n,Controller:this.get_controller(),View:this.get_viewId(),Filter:this._combinedFilter(r.length===1&&r[0].match(/(\w+):/)[1]===n?null:r),ExternalFilter:this.get_externalFilter(),LookupContextFieldName:i?i.FieldName:null,LookupContextController:i?i.Controller:null,LookupContextView:i?i.View:null,Tag:this.get_tag(),QuickFindHint:t?this.viewProp("quickFindHint"):null};return this._useSearchParams(u),{controller:this.get_controller(),view:this.get_viewId(),request:u}},_loadListOfValues:function(n,t,i,r){this._busy(!0);this._invoke("GetListOfValues",this._createArgsForListOfValues(i),Function.createDelegate(this,this._onGetListOfValuesComplete),{family:n,fieldName:t,callback:r})},_onGetListOfValuesComplete:function(t,i){this._busy(!1);var r=this.findField(i.fieldName);r._listOfValues=t;t[t.length-1]==null&&(Array.insert(t,0,t[t.length-1]),Array.removeAt(t,t.length-1));i.callback?i.callback():(this.get_isChart()?(this.get_showViewSelector()?this._registerViewSelectorItems():this._registerActionBarItems(),it.HoverMonitor._instance._tempOpenDelay=100):this._registerFieldHeaderItems(Array.indexOf(this.get_fields(),r)),$refreshHoverMenu(i.family),n._resized=!0)},clipboard:function(i,r){var u=this,s,y,e,h,c,o,b,k,l,d,w,a,v;if(p.data(),i==="menu"){h=[];c=r.items;r.existingRow&&(u.clipboard("copy")&&h.push({text:vi.Copy,icon:"material-icon-content_copy",sidebar:!1,context:u,callback:n.clipboard.copy}),u.clipboard("cut")&&h.push({text:vi.Cut,icon:"material-icon-content_cut",sidebar:!1,context:u,callback:n.clipboard.cut}));(u.clipboard("paste")||!c.isRow&&u.clipboard("viewpaste"))&&(y=f.text+" "+ut.From+" "+f.source,h.push({text:vi.Paste,desc:y,tooltip:y,icon:"material-icon-content_paste",sidebar:!1,context:u,callback:p.paste}));h.forEach(function(n,t){t||c.push({});c.push(n)});return}if(i==="paste"||i==="drop")return p.data(),o=(i==="drop"||!f.drag)&&u.tagged(new RegExp("\\bitem\\-"+i+"\\-(.+?)(\\s|$)")),o&&f.controller===o[1];if(i==="viewpaste"||i==="viewdrop")return p.data(),i=i==="viewdrop"?"drop":"paste",o=(i==="drop"||!f.drag)&&u.tagged(new RegExp("\\bview\\-"+i+"\\-(.+?)(\\s|$)")),o&&f.controller===o[1];if(i==="copy"&&(s="item-copy"),i==="cut"&&(s="item-cut"),i==="drag"&&(s="item-drag"),s)return!!u.tagged(s);if(i==="map")return b=u._controller,w=u._keyFields,r?(e=r.map,e&&(l=r.link,l?(k=l.data("data-context").row,d=l.parent(),a=[],(e._cut||e._drag)&&w.forEach(function(n){a.push(k[n.Index])}),d.toggleClass("app-clipboard-cut",!!a.length&&e[a.join()]!=null)):(v=t.summary(u._id),v.length||(v=t.activePage()),v.find(".dv-item").each(function(){u.clipboard("map",{map:e,link:$(this).find("> .ui-btn")})})))):f.controller===b&&(e={_cut:f.cut,_drag:f.drag},f.objects.forEach(function(n){var t=[];w.forEach(function(i){t.push(n[i.Name])});e[t.join()]=n})),e;i==="clear"&&(e={},p.clear(),i="changed");i==="changed"?(e=e||u.clipboard("map"),u.clipboard("map",{map:e}),bt.trigger("throttledresize")):p.paste(i||u)},get_parentDataView:function(n){var t=n;return this._parentDataViewId&&(t=o(this._parentDataViewId)),t},get_selectedValues:function(){var t=this,i=t._useCase==="seeAll"?t:t.get_parentDataView(t),n=i?i.get_selectedValue():[];return n=n.length?i.multiSelect()?n.split(";"):[n]:[],Array.isArray(n)&&!n.length&&(n=i.get_selectedKey().toString(),n=r(n)?null:[n]),n},_execute:function(n){var t=this;t._busy(!0);t._showWait();t._lastArgs=n;t._invoke("Execute",{controller:n.Controller,view:n.View,args:n},Function.createDelegate(t,t._onExecuteComplete))},_populateDynamicLookups:function(i){for(var u=this,o,e,r,f=0;f<i.Values.length;f++)e=i.Values[f],r=u.findField(e.Name),r&&(o=r.DynamicItems=e.NewValue,r.requiresDynamicNullItem&&r.ItemsStyle.match(/^(ListBox|RadioButtonList|DropDownList)$/)&&!r.ItemsTargetController&&er(r,o),r.Items=[],r.ItemCache=null);t?n.input.execute({dataView:u,values:i.Values,populateDynamicLookups:!1}):(u._skipPopulateDynamicLookups=!0,u.refresh(!0),u._focus())},_updateCalculatedFields:function(n){var i,t,r;for(this._displayActionErrors(n),i=[],t=0;t<n.Values.length;t++)r=n.Values[t],Array.add(i,{name:r.Name,value:r.NewValue});this.refresh(!0,i);this._focus()},_recordLEVs:function(){},_applyLEV:function(){},_useLEVs:function(){},_notifyMaster:function(){var u=this,n,r,i,f;if(u.get_hasParent())if(t){if(n=u,i=n._dataViewFieldName,!(n._filterSource&&i))while(n&&!i)n=n.get_parentDataView(),n&&(i=n._dataViewFieldName);n&&i&&(n=o(n._filterSource),r=n.findField(i),r&&r.CausesCalculate&&(n==t.dataView()?n._raiseCalculate(r,r):t.pageInfo(n).calculate=i))}else f=o(u.get_filterSource()),f&&f._updateDynamicValues("controller:"+u.get_controller())},_clearSelectedKey:function(n){var t=this._lookupInfo?this:this.get_parentDataView(this),i=t._selectedKey,r;i&&i.length&&(r=t._selectedKeyList.indexOf(i.join(",")),r!==-1&&t._selectedKeyList.splice(r,1));t._selectedKey=[];t._selectedKeyFilter=[];t._selectedRowIndex=null;t._position=null;n!==!1&&(t._raiseSelectedDelayed=!0);t._selectedRow=null},_refreshSelectedKey:function(n){var i=this,r,f=[],h=[],e,o,u,s;for(!n.length&&i._lastArgs&&(n=i._lastArgs.Values),o=0;o<i._keyFields.length;o++)for(e=i._keyFields[o],u=0;u<n.length;u++)if(n[u].Name===e.Name){if(s=n[u],s.NewValue==null){i._clearSelectedKey();return}Array.add(f,s.NewValue);Array.add(h,e.Name+":="+i.convertFieldValueToString(e,s.NewValue));break}r=t?i.get_parentDataView(i):i;r.editing()&&t||(f.length>0?(r._selectedKey=f,r._selectedKeyFilter=h,r._selectedKeyList=[f.join(",")],r._raiseSelectedDelayed=!0):r._selectedKeyList=[])},_cancelConfirmation:function(){var t=this,i=t._confirmDataViewId,n;i&&(n=o(i),n&&(t._confirmDataViewId=null,n.cancel()))},_findKeyValue:function(n){for(var t,r=this._keyFields[0],i=0;i<n.length;i++)if(t=n[i],r.Name===t.Name)return t.Modified?t.NewValue:t.OldValue;return null},uploadNextBlob:function(i,r,u,f){function a(n){u&&(t?t.busy(n):e._busy(n))}function v(){e._stopWaiting=!0;a(!1)}var e=this,l,s=e._pendingUploads,h,o,c,y;return s&&s.length>0&&(h=s[0],c="1",Array.removeAt(s,0),key=e._findKeyValue(r),key==null&&(key=e._findKeyValue(i)),h.files&&(o=e.findField(h.fieldName),y="name:"+o.Name,e._allFields.forEach(function(n){n._blobField===y&&(c="2")}),o.Name.match(/_Annotation_Attachment/)&&(key=o._dataView._controller+","+o.Name+"|"+key),a(!0),l=n.upload("execute",{container:pr(e,o),files:h.files,field:o,key:key,apiVer:c}).done(function(){v();u&&e._onExecuteComplete(u,f)}).fail(v))),l},_onExecuteComplete:function(i,u){function vt(u){var a,s,h,c,l,v,y;if(u.dispose(),f._continueAfterScript){if(i.NavigateUrl&&(i.NavigateUrl=f.resolveClientUrl(i.NavigateUrl),lt=!nt,f.navigate(i.NavigateUrl,ft?d:o)),!lt&&!f._closeInstantDetails()&&!f.endModalState(e))if(f.get_backOnCancel()||!r(f._replaceTriggerViewId))f.goBack(!0);else{for(f._notifyDesigner(!0),p!=null&&t.notify(typeof p=="string"?{text:p,force:!0}:p),a=f.get_actions(f._get_lastActionScope(),!0),c=0;c<a.length;c++)if(s=a[c],s.WhenLastCommandName===e&&(!s.WhenLastCommandArgument||s.WhenLastCommandArgument===g)&&f._isActionMatched(s)){l=s.CommandName;v=s.CommandArgument;t&&(h=f.delegateCommand(l,v));h||(h=f);(!s.WhenKeySelected||(h.get_selectedKey()||[]).length)&&(h.set_lastCommandName(e),h.set_lastCommandArgument(g),h.executeCommand({commandName:l,commandArgument:v,path:s.Path,causesValidation:s.CausesValidation,values:e.match(/Insert|Custom/)?d:null}),h._pendingSelectedEvent=l.match(/^(Edit|Select)/)!=null,h._notifyMaster());return}tt||(t&&e==="Update"&&g==="SaveAndContinue"?(y={},f._keyFields.forEach(function(n,t){y[n.Name]=f._selectedKey[t]}),n.execute({controller:f._controller,view:f._viewId,filter:y,includeRawResponse:!0}).then(function(t){var u=f.editRow(),i=t.rawResponse.Rows[0],r={};i&&(f._allFields.forEach(function(n,t){u[t]!==i[t]&&(r[n.Name]=i[t])}),f._originalRow=i.slice(),f._unchangedRow=i.slice(),n.input.execute({values:r}),f.refreshChildren())})):(f._pendingSelectedEvent=e.match(/Update|Custom|SQL/),f.set_lastCommandName(null),f.get_isModal()&&(!f.get_isForm(f._lastViewId)||f._inlineEditor||f._closeViewDetails)?f.endModalState("Cancel"):(t&&f._viewId===f._lastViewId&&t.syncWithOdp(t.dataView()),t&&ht?f._doneCallback?f._doneCallback(f):location.replace(location.href):f.goToView(f._lastViewId))))}f._notifyMaster()}else t&&t.edit.sync({reset:!0})}function yt(){l=new v(f);l.after(a);(l.canceled()||i.Canceled&&!nt&&!e.match(/Update|Insert|Delete/))&&(f._continueAfterScript=!1);l._wait?$.when(l._wait).done(function(){vt(l)}):vt(l)}var f=this,ht=f.get_isForm(),b=f.extension(),a=f._lastArgs,d=a.Values,e=a.CommandName,g=a.CommandArgument,o=i.Values,ct=i.Errors,c=!ct.length,s,nt,lt,tt=!1,it,h,y,l,rt=f._lastFocusedCell,p,ut,ft,et,ot,k,at,st,w;if(f._busy(!1),f._hideWait(),c)for(h=o.length-1;h>=0;)y=o[h],y.Scope&&(o.splice(h,1),f.updateFieldValue(y.Name,y.NewValue,y.Scope)),h--;if(!c||!e.match(/^(Insert|Update)$/)||!f.uploadNextBlob(d,o,i,u)){if(t&&(p=t.notify(f)),e==="PopulateDynamicLookups"){f._populateDynamicLookups(i);return}if(e==="Calculate"){t?c?n.input.execute({dataView:f,values:o,raiseCalculate:!1}):t.notify(ct):f._updateCalculatedFields(i);i.ClientScript&&eval(i.ClientScript);f._pendingPopulate&&(f._pendingPopulate=!1,f._raisePopulateDynamicLookups());return}if(it=e==="Custom",f._confirmDataViewId&&t){t.pageShown(function(){f._onExecuteComplete(i,u)});f._syncKey=null;f._cancelConfirmation();return}if(f._cancelConfirmation(),c&&t&&(n.syncMap.notify(f._controller),n.syncMap.notify(f._syncWith)),ut={result:i,context:u,handled:!1},f.raiseExecuted(ut),!ut.handled){if(i.ClearSelection&&(f._clearSelectedKey(),f._selectedKeyList=[]),ft=!e.match(/Insert/),e.match(/Delete/i)&&i.RowsAffected>0)b=f.get_parentDataView(f).extension(),b&&b.clearSelection?b.clearSelection(!0):f._clearSelectedKey();else if(e.match(/Custom|SQL|Email/))tt=!it&&f.editing(),o.length>0?(t?n.input.execute({dataView:f,values:o}):f.refresh(!0,o),it&&!i.ClientScript&&(i.ClientScript="void(0)"),f._refreshSelectedKey(o,c)):tt||e!=="SQL"||(f._raiseSelectedDelayed=!0,f._forceChanged=!0);else if(ft)for(h=0;h<o.length;h++)et=o[h],ot=f.findField(et.Name),ot&&(f.get_currentRow()[ot.Index]=et.NewValue);else t&&(n.input.execute({dataView:f,values:o}),ht&&(s=f.get_parentDataView(null),s&&s!==f&&(k=[],at=f.editRow(),$(f._allFields).each(function(){var n=this,t=s.findField(n.Name),i=at[n.Index];t&&(k[t.Index]=i)}),st=s.extension(),st._commandRow=k,s.get_isGrid()&&st.headerText(k)))),f._refreshSelectedKey(o,c);c?(f._forceSync(),s=f.get_parentDataView(),s&&s._forceSync(),f.tag(i.Tag),f._requestedFilter=i.Filter,f._requestedSortExpression=i.SortExpression,f._autoRefresh(),f.multiSelect()&&(i.KeepSelection?f._keepKeyList=!0:(f._selectedKeyList=[],f.set_selectedValue(""))),f._recordLEVs(),f.updateSummary(),f._continueAfterScript=!0,i.ClientScript&&(f._continueAfterScript=!1,i.ClientScript=f.resolveClientUrl(i.ClientScript),eval(i.ClientScript),nt=f._continueAfterScript),f._lastFocusedCell=null,w=pt(f,a),w!==!1&&(w&&w.then?$.when(w).then(yt):yt())):(rt&&(f._focusCell(-1,-1,!1),f._focusCell(rt.rowIndex,rt.colIndex,!0),f._lastFocusedCell=null,f._saveAndNew=!1),i.ClientScript&&(i.ClientScript=f.resolveClientUrl(i.ClientScript),eval(i.ClientScript)),f._displayActionErrors(i))}}},_get_lastActionScope:function(){var f=this._lastArgs?this._lastArgs.Path:null,i,r,n,u,t;if(f&&(i=f.match(/^(\w+)\//),i))for(r=this._actionGroups,n=0;n<r.length;n++)if(u=r[n],u.Id===i[1])return u.Scope;return t=this.get_viewType(),t.match(/DataSheet|Tree/)&&(t="Grid"),t},_displayActionErrors:function(i){if(i.Errors.length){for(var u=new et,r=0;r<i.Errors.length;r++)u.append((r?"\n":"")+n.formatMessage("Attention",i.Errors[r]));t&&t.edit.sync({reset:!0});n.showMessage(u.toString());u.clear()}},_busy:function(i){var u=this,f=u._api,r;if(i==null)return u._isBusy;if(!f||!f.background){if(u._isBusy=i,t.toolbar().is(":visible")){arguments.length&&t.busy(i);clearTimeout(n._busyIndicatorTimeout);r=n._busyIndicator;r||(r=t.indicator(),n._busyCount=0);i?(n._busyCount||(n._busyTime=+new Date,r.removeClass("dataview-busy-indicator-done").css({"animation-duration":Math.max(1e3,t.screen().width)*3+"ms"}),r.addClass("dataview-busy-indicator-animate")),n._busyCount++):n._busyCount&&(n._busyCount===1&&(+new Date-n._busyTime>500?(r.toggleClass("dataview-busy-indicator-animate dataview-busy-indicator-done"),setTimeout(function(){r.removeClass("dataview-busy-indicator-done")},1550)):r.removeClass("dataview-busy-indicator-animate dataview-busy-indicator-done")),n._busyCount--);return}t.wait(i)}},_prepareJavaScriptExpressionEx:function(n){return n.replace(/\[((\w+)\.)?(\w+)\]/g,'this.fieldValue("$3","$2")').replace(/\$row\.(\w+)/gm,'this.fieldValue("$1")').replace(/\$master\.(\w+)/gm,'this.fieldValue("$1","master")')},_evaluateVisibility:function(){var n=this.get_visibleWhen();return r(n)?!0:(n=this._prepareJavaScriptExpressionEx(n),eval(n)!=!1)},_filterSourceSelected:function(i,r,u){var o,f,s,c,l,a,v,y,p,e,h;if(this._hidden=!this._evaluateVisibility(),o=this.readContext("vitals"),o){for(f=0;f<o.Filter.length;){var w=o.Filter[f],k=w.substring(0,w.indexOf(":")),b=!1;if(this._keyFields)for(s=0;s<this._keyFields.length;s++)if(this._keyFields[s].Name===k){b=!0;break}b?Array.removeAt(o.Filter,f):f++}this.writeContext("vitals",o)}for(c=[],f=0;f<this._externalFilter.length;f++)Array.add(c,this._externalFilter[f].Value),this._externalFilter[f].Value=null;for(l=!1,a=!1,g(n,i)?(this._populateExternalViewFilter(i),l=!i.get_showDetailsInListMode()&&i.get_isGrid(),i._forceChanged&&(a=!0)):this._externalFilter.length>0&&(this._externalFilter[0].Value=i.target.value),this.applyExternalFilter(t),v=!0,y=!1,f=0;f<this._externalFilter.length;f++)p=this._externalFilter[f].Value,p!=null&&(v=!1),p!=c[f]&&(y=!0);this.get_autoHide()!=Web.AutoHideMode.Nothing&&this._updateLayoutContainerVisibility(!v&&!l&&!this._hidden);(y||a)&&(u||(h=this.extension(),this.set_pageIndex(-1),h&&h.currentPageIndex&&h.currentPageIndex(null)),e=this._position,e&&(e.index=0,e.count=-1,e.key=[],e.keyFilter=[],e.filter=this.get_filter()),u||(this._selectedKey=[],this._selectedKeyFilter=[],this._selectedKeyList=[]),this._clearCache(),this.loadPage());this.raiseSelected();this.updateSummary()},_createExternalFilter:function(){var i=this,r=i.get_filterFields(),t;if(i._externalFilter=[],r)for(fieldNames=r.split(n._simpleListRegex),t=0;t<fieldNames.length;t++)i._externalFilter.push({Name:fieldNames[t],Value:null})},_populateExternalViewFilter:function(n){var i,r,f,t,u,e;if(n._selectedKey&&n._keyFields&&n._selectedKey.length==n._keyFields.length)for(i=0;i<this._externalFilter.length;i++){for(r=this._externalFilter[i],f=!1,t=0;t<n._keyFields.length;t++)if(u=n._keyFields[t],r.Name==u.Name){r.Value=n.convertFieldValueToString(u,n._selectedKey[t]);f=!0;break}if(!f&&this.get_controller()!=n.get_controller()&&(e=n.get_selectedRow(),e&&e.length))for(t=0;t<n._allFields.length;t++)if(u=n._allFields[t],r.Name==u.Name){r.Value=n.convertFieldValueToString(u,e[n._allFields[t].Index]);f=!0;break}!f&&n._selectedKey.length>=i&&(r.Value=n._selectedKey[i])}},_cloneChangedRow:function(){var t,n,i;if(this.editing()){var r=this._collectFieldValues(),u=this.get_currentRow(),f=u?Array.clone(u):null;for(t=0;t<r.length;t++)n=r[t],i=this.findField(n.Name),i&&(f[i.Index]=n.Modified&&"NewValue"in n?n.NewValue:n.OldValue);return f}return this.get_selectedRow()},get_statusBar:function(){var n=this,t=n._statusBar||n._statusBarAuto;return t||!n._isWizard||n.tagged("status-bar-disabled")||(t=n._statusBarAuto=n._controller+"."+n._viewId+"._wizard: 0\n"+gt.Loading+">\n"),t},statusBar:function(){var v=this.get_statusBar(),o,f,t,s,u,e,h,c,i;if(!r(v))for(f=/((\w+)\.)?((\w+)\.)?(\w+):\s*(.+?)\s*\n\s*(((.+?)\s*>\s*)+)/g,t=f.exec(v);t;){if(s=this.fieldValue(t[5]),s==null&&(s="null"),(t[6]==s||t[6]=="*")&&(r(t[2])||t[2]==this.get_controller())&&(r(t[3])||t[4]==this.get_viewId())){for(f=/(\[)?\s*(.+?)\s*(\])?\s*>\s*/g,u=[],e=f.exec(t[7]);e;)Array.add(u,{Text:e[2],Current:e[1]=="["&&e[3]=="]"}),e=f.exec(t[7]);if(u.length>0&&!(__tf!=4)){for(o=new et('<ul class="StatusBar">'),h=!1,c=!0,i=0;i<u.length;i++)if(u[i].Current){h=!0;c=!1;break}for(i=0;i<u.length;i++){var l=u[i],a=l.Current?"Current":h?"Past":c?"Future":"",y=i<u.length-1?u[i+1]:null,p="";y&&(y.Current?p=a+"ToCurrent":l.Current&&(p=y.Current?a+"ToCurrent":a+"ToFuture"));l.Current&&(h=!1,c=!0);o.appendFormat('<li class="Segment {1}{2}{3} {4}"><span class="Outer"><span class="Inner"><span class="Self">{0}<\/span><\/span><\/span><\/li>',n.htmlEncode(l.Text),a,i==0?" First":"",i==u.length-1?" Last":"",p)}o.append("<\/ul>")}break}t=f.exec(v)}return o?o.toString():null},_updateDynamicValues:function(n){var i=this,e=!1,h=i._allFields,c=n&&n.Name?n.Name:n,o,u,l,s,f;if(n&&n.CausesCalculate){if(!i.editing())return i.refresh(),!0;i._raiseCalculate(n,n);e=!0}else for(o=0;o<h.length;o++)if(u=h[o],l=!r(u.ContextFields),l){for(s=/\s*([\w\:]+)\s*(=\s*(\w+)\s*)?(,|$)/g,f=s.exec(u.ContextFields);f;){if(u.ItemsAreDynamic&&(n==null||f[3]==c)){if(!i.editing())return i.refresh(),!0;i._raisePopulateDynamicLookups();e=!0}else if((u.Calculated||u.CausesCalculate)&&f[1]==c||f[1]==n||"controller:"+f[1]==n){if(t){i.extension().notify(n);return}if(!i.editing())return i.refresh(),!0;i._raiseCalculate(u,n);e=!0}if(e)break;f=s.exec(u.ContextFields)}if(e)break}return e},_enumerateContextFieldValues:function(t,i,r,u){for(var b=this,d=t.Name,h,e,k=t.ItemsDataController,a=b._allFields,f,c,v,y,l,s,p,w,o=0;o<a.length;o++)if(f=a[o],c=f.ContextFields,c&&!r[o]&&(f.ItemsStyle||f.Type=="DataView"))for(v=/\s*(\w+)\s*(=\s*(\w+)\s*)?(,|$)/g,h=v.exec(c);h;){if(h[3]==d){if(y=f.ItemsDataController,l=!(k&&y)||k!=y,r[o]=!0,e||(e={},$(i).each(function(){e[this.name||this.Name]=!0})),e[f.Name]||i.push({name:f.Name,value:!l&&u?u[f.Index]:null}),s=a[f.AliasIndex],s==f||e[s.Name]||i.push({name:s.Name,value:!l&&u?u[s.Index]:null}),p=f.Copy,p&&l)while(w=n._fieldMapRegex.exec(p))e[w[1]]||i.push({name:w[1],value:null});f.skipPopulate||(f.DynamicItems=null,f.ItemCache=null);b._enumerateContextFieldValues(f,i,r,u)}h=v.exec(c)}},_executeQuickFind:function(n){var t,i;for(this._forceSync(),t=0;t<this._allFields.length;t++)this._allFields[t]._listOfValues=null;for(this.removeQuickFind(),t=0;t<this._allFields.length;t++)if(i=this._allFields[t],!i.Hidden){i=this._allFields[i.AliasIndex];r(n)?this.refreshData():this.applyFilter(i,"~",n);break}},quickFind:function(n){var t=(r(n)?this.get_quickFindElement().value:n).match(/^\s*(.*?)\s*$/),i=t[1]===ti.QuickFindText?"":t[1];this.set_quickFindText(i);this._executeQuickFind(i);this._lostFocus=!1},encodePermalink:function(n,t,i){c.Net.WebServiceProxy.invoke(this.get_servicePath(),"EncodePermalink",!1,{link:n,rooted:!1},Function.createDelegate(this,this._encodePermalink_Success),Function.createDelegate(this,this._onMethodFailed),{target:t,features:i})},_encodePermalink_Success:function(n,t){t.target||t.features?open(n,t.target,t.features):location.href=n},showViewMessage:function(n){t.notify({text:n,force:!0})},hideViewMessage:function(){var i=this._get("$HeaderText"),t,n;if(i!=null){if(t=this.get_view(),n=t.OriginalHeaderText,!n)return;t.HeaderText=n;i.innerHTML=this._formatViewText(e.Views.DefaultDescriptions[n],!0,n);this._viewMessages[t.Id]=null}}};n.registerClass("Web.DataView",c.UI.Behavior);n.hideMessage=function(){n.showMessage()};n.formatMessage=function(n,t){return String.format('<table cellpadding="0" cellspacing="0" ><tr><td class="{0}" valign="top">&nbsp;<\/td><td class="Message">{1}<\/td><\/tr><\/table>',n,t)};n.showMessage=function(n){t.notify({text:n,force:!0,duration:"medium"})};n.unanchor=function(n){var t=n.match(/^(.+?)#.*$/);return t?t[1]:n};n.ensureJSONProperties=["OldValue","NewValue","Value"];n.ensureJSONCompatibility=function(t){$(t).each(function(){var t=this;$(n.ensureJSONProperties).each(function(){var i=this;t[i]&&t[i].getTimezoneOffset&&(t[i]=n.stringifyDate(t[i]))})})};n.stringifyDate=function(n){var i,t;return lu(n)?(i=u.Calendar.convert,i&&(t=i.toGregorian(n.getFullYear(),n.getMonth(),n.getDate()),t&&(t.setHours(n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()),n=t)),Date._localTimeEnabled())?n.toISOString():String.format("{0}-{1:d2}-{2:d2}T{3:d2}:{4:d2}:{5:d2}.{6:d3}",n.getFullYear(),n.getMonth()+1,n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()):n};n.isISO8601DateString=function(n){return typeof n=="string"&&n.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)};n.csv={delimiter:",",toString:function(n){return n.forEach(function(t,i){if(t==null)t="";else{t=t.toString();var r;t.match(/\"/)?(r=!0,t=t.replace(/\"/g,'""')):t.match(/(\r|\n|,)/)&&(r=!0);r&&(t='"'+t+'"')}n[i]=t}),n.join(",")},toArray:function(t){return n.csv.toData(t)[0]},toData:function(t){var u=n.csv.delimiter,r=[[]],i=null,f,e,o=new RegExp("(\\"+u+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+u+"\\r\\n]*))","gi");if(t!=null&&t.length)while(i=o.exec(t))f=i[1],f.length&&f!==u&&r.push([]),e=i[2]?i[2].replace(new RegExp('""',"g"),'"'):i[3],r[r.length-1].push(e);return r}};n.addon=function(n,t,i){return $.ajax({url:k+"/Addon",data:h({type:n,method:t,args:i}),processData:!1,method:"POST",cache:!1})};n.resolveClientUrl=function(n,t){return t||(t=this._baseUrl||(typeof w=="string"?w:"")),n?n.replace(/~\x2f/g,t):null};n.jsExt=function(){var n="min.js";return $("script").each(function(){var t=($(this).attr("src")||"").match(/\/(combined-(\d+\.\d+\.\d+\.\d+).+?|daf)\.js\?(.+)/);if(t)return t[1]==="daf"?n="js?"+t[3]:n+="?"+t[2],!1}),n};n.execute=function(i){function s(){r.dispose();rt.remove()}function c(){a||r._busy(!1)}function ft(n){i.success?i.success(n):tt.resolve(n)}function et(){i.command==="Select"?r._loadPage():(r.odp&&u&&(r.get_isForm=function(){return!0},r._parentDataViewId=u._id,d.verify(r)),r.executeCommand({commandName:i.command,commandArgument:i.argument||"",causesValidation:!1,trigger:i.trigger}))}var h,a,u,g,p,l,b;if(i||(i={}),h=!!i.batch,a=i.response,!h&&(u=i.from||i.in||(t&&!i.controller?t.dataView():null),u||i.controller||(u=t.dataView()),u)){if(typeof u=="string"&&(i.as=u,g=t.dataView().findField(u),g&&(u=g)),u=u._dataViewId||u,typeof u=="string"&&(u=o(u)),!u)throw new Error("Invalid arguments.");i.controller=u._controller;i.view=u._viewId;i.externalFilter=u._externalFilter;i.sort||(i.sort=u.get_sortExpression());i.odp=u.odp;u.get_isForm()&&(i._filter=u._filter,i.requiresNewRow=u.inserting())}i.done&&(i.success=i.done);i.fail&&(i.error=i.fail);var rt=$("<p>"),nt=i.externalFilter,r=$create(Web.DataView,{controller:i.controller,viewId:i.view||"grid1",servicePath:i.url||(typeof k=="string"?k:""),baseUrl:typeof w=="string"?w:"",useCase:"$app",tags:i.tags,externalFilter:nt,filterSource:i.filterSource||(nt&&nt.length?"External":null)},null,null,rt.get(0)),v=i.sync,e={},y,ut=i.requiresNewRow,tt=$.Deferred(),f=i.values,it=i.odp;if(r._nativeDates=i.nativeDates,r._api=e,r.odp=it===!1?!1:it===!0?d.get():it,v&&(r._syncKey=Array.isArray(v)?v:[v]),i.requiresData===!1&&(e.DoesNotRequireData=!0),i.background&&(e.background=!0),e.requiresAggregates=i.requiresAggregates===!0,e.metadataFilter=i.metadataFilter||["fields"],i.fieldFilter&&(e.fieldFilter=i.fieldFilter),r._onMethodFailed=function(n,t){c();i.error?i.error(n,t):tt.reject(n,t);s()},r._onGetPageComplete=function(n){h||c();var t={totalRowCount:n.TotalRowCount,pageIndex:n.PageIndex,pageSize:n.PageSize},o=t[i.as||n.Controller]=[],l=i.format,e=[],f={},u=n.FirstLetters;if($(n.Fields).each(function(n){var t=this;t.IsPrimaryKey&&e.push(t);wi(t);t.OriginalIndex=t.AliasIndex=t.Index=n;f[t.Name]=t}),$(n.Fields).each(function(){var n=this,t;n.AliasName&&(t=f[n.AliasName],t&&(n.AliasIndex=t.Index,t.OriginalIndex=n.Index))}),$(n.Fields).each(function(){var n=this;_field_prepareDataFormatString(r,n);n.format=_field_format}),t.primaryKey=e,t.fields=n.Fields,t.map=f,ut&&(n.Rows=[n.NewRow]),$(n.Rows).each(function(){var i=this,t={};o.push(t);$(n.Fields).each(function(n){var u=this,r=i[n];l&&u.DataFormatString&&u.FormatOnClient&&(u.Type.match(/^Date/)&&typeof r=="string"&&(r=Date.fromUTCString(r)),r=u.format(r));t[u.Name]=r})}),u&&(u=u.split(","),t.letters={list:u.slice(1),field:u[0]}),this._requiresPivot&&(t.Pivots={},$(n.Pivots).each(function(){t.Pivots[this.Name]=this})),(i.includeRawResponse||h)&&(t.rawResponse=n),h)return t;ft(t);s()},a){r._onGetPageComplete(a);return}if(r._onExecuteComplete=function(n){var h=!!i.batch,u,e,o;if(t&&r.odp&&t.syncWithOdp(t.dataView()),h||c(),u=n?{rowsAffected:n.RowsAffected,canceled:n.Canceled,clientScript:n.ClientScript,navigateUrl:n.NavigateUrl,errors:n.Errors}:{},e=u[i.as||i.controller]={},f)if(Array.isArray(f))$(f).each(function(){var n=this;e[n.name||n.field]="newValue"in n?n.newValue:"oldValue"in n?n.oldValue:n.value});else for(o in f)e[o]=f[o];if(n&&$(n.Values).each(function(){var n=this;e[this.Name]="NewValue"in n?n.NewValue:n.Value}),u.rawResponse=n,h)return u;ft(u);s()},i.batch){r._busy(!0);p=[];l=[];$(i.batch).each(function(){var t=this,i,r=!t.command||t.command==="Select";t.skipInvoke=!0;r&&(t.pageIndex==null&&(t.pageIndex=0),t.pageSize==null&&(t.pageSize=100));i=n.execute(t);r?(i.Controller=t.controller,i.View=t.view,p.push(i)):l.push(i)});p.length&&r._invoke("GetPageList",{requests:p},function(n){c();i.success&&($(n).each(function(t){var i=this;n[t]=r._onGetPageComplete(i)}),i.success(n));s()},null);l.length&&r._invoke("ExecuteList",{requests:l},function(n){c();i.success&&($(n).each(function(t){var u=this;i.controller=l[t].Controller;n[t]=r._onExecuteComplete(u)}),i.success(n));s()},null);return}if(r._collectFieldValues=function(){var t=[],r,i;if(Array.isArray(f))$(f).each(function(){var i=this,r,u;"Name"in i?t.push(i):(r=n.stringifyDate("oldValue"in i?i.oldValue:i.value),u=n.stringifyDate("newValue"in i?i.newValue:r),t.push({Name:i.name||i.field,NewValue:u,OldValue:r,Modified:typeof i.modified!="undefined"?i.modified===!0:r!=u,ReadOnly:i.readOnly===!0}))});else for(i in f)t.push({Name:i,NewValue:f[i],OldValue:null,Modified:!0,ReadOnly:!1});return u&&(r=u.row(),u._keyFields.forEach(function(n){var i;t.every(function(t){return i=t.Name===n.Name,!i});i||t.push({Name:n.Name,OldValue:r[n.Index]})})),t},r._validateFieldValues=function(){return!0},i.pageIndex!=null&&(r._pageIndex=i.pageIndex),i.pageSize==null&&(i.pageSize=100),i.sort&&(i.sortExpression=i.sort),r._pageSize=i.pageSize,i.selectedValues&&(r.SelectedValues=i.selectedValues),i.selectedKeys&&(r.multiSelect(!0),r.set_selectedValue(i.selectedKeys.join(";"))),i.lastCommand&&r.set_lastCommandName(i.lastCommand),i.lastCommandArgument&&r.set_lastCommandArgument(i.lastCommandArgument),ut&&(e.inserting=!0),i._init=!0,r.search(i),i._filter&&(r._filter=i._filter),r._filterDetailsText=i.filterDetails,i.command||(i.command="Select"),i.command==="Pivot"&&(i.command="Select",r._requiresPivot=!0,i.pivotDefinitions))for(y in i.pivotDefinitions)i.pivotDefinitions[y].length>0&&(r._pivotDefinitions+=";"+y+"="+i.pivotDefinitions[y].join());return(i.requiresRowCount&&(r._requiresRowCount=!0),i.letters&&(r._showFirstLetters=!0),r._lookupContext=i.lookupContext,i.distinct&&(r._distinctValues=!0),b=i.skipInvoke,b&&(r._skipInvoke=!0),!b&&r.odp?setTimeout(et,48):et(),b)?(s(),r._invokeArgs):tt.promise()};n.ifThisThenThat=function(){var r=n._ifttt,t=arguments,u=t.length,f,i,e;if(u===1&&typeof t[0]=="number")e=t[0];else if(u&&typeof t[0]=="boolean")e=t[0]?5e3:0;else if(u&&typeof t[0]=="string")tt.trigger("ifttt.app",t[0]);else{for(r||(r=n._ifttt=[]),f=0;f<u;f++)i=t[f],typeof i=="function"&&(i={execute:i,background:!0}),i.id||(i.id="activity"+r.length),r.push(i);return r}e!=null&&(n.ifThisThenThat._interval=e)};n.data=function(t){var i=t.d.Controller,r=t.id;n.execute({format:t.format,response:t.d,controller:i,success:function(t){var u=t[i],f;delete t[i];t.controller=i;u._metadata=t;u._metadata.id=r;n.data[r]=u;f=n.data.objects;f||(f=n.data.objects=[]);f.push(u)}})};n.dataBind=function(t,i){n.data.objects&&t.find("[data-control]").addBack("[data-control]").each(function(){var t=$(this),a=t.data("processed"),c,l,u,s,h;if(!a){t.data("processed",!0);var f=t.data("control"),e=t.data("source"),o=t.data("field"),r=i[i.length-1];if(f==="form")c=i.concat([n.data[e]]),t.children().each(function(){n.dataBind($(this),c)});else if(f==="repeater")e&&(r=n.data[e]),t.removeAttr("data-control data-source"),l=t[0].innerHTML,t.empty(),$(r).each(function(){var r=i.slice(0),u=$(l).appendTo(t);r.push(this);n.dataBind(u,r)});else if(o)switch(f){case"label":for(u=i.length;u--;u>=0)if(s=i[u],s._metadata){$(s._metadata.fields).each(function(){if(this.Name===o)return t.text(this.Label),!1});break}break;case"field":$.isArray(r)&&(r=r[0]);h=r&&r[o];h==null?t.text(""):t.text(h)}}})};o=n.findDataView=function(t){return t&&t._controller?t:n.find(t,"Id")};p=n.clipboard={_options:function(n){return n||(n=t.dataView()),n._controller&&(n={dataView:n}),n},data:function(t){var i;return t?(i=f,f=t,bt.trigger("throttledresize")):(f==null&&(f=n.userVar("clipboard"),f==null&&(f={})),i=f),i},cut:function(t){return t=p._options(t),t.cut=!0,n.clipboard.copy(t)},copy:function(i){i=p._options(i);var r=i.dataView,e=[],u=[],s=r._keyFields,o=r.get_selectedValues().slice(),h=$.Deferred(),c;return r.get_isForm()?(e.push(r.data()),u.push($("#"+r._id+" .app-page-header h1").first().text())):(c=r._editRow,r._cachedPages.every(function(n){return n.rows.every(function(n){return o.every(function(t,i){t=t.split(",");var f=0;return s.forEach(function(i,r){n[i.Index].toString()===t[r]&&f++}),f=f===s.length,f&&(r._editRow=n,e.push(r.data()),o.splice(i,1),u.length<3&&u.push(r.extension().headerText(n,!1))),!f}),o.length}),o.length}),r._editRow=c),e.length>3&&u.push("+"+(e.length-3)),u=u.join(", "),f={controller:r._controller,view:r._viewId,id:r._id,objects:e,cut:i.cut,drag:i.drag,text:u,source:r.get_view().Label},i.drag||t.settings("clipboard.scope")==="local"||n.userVar("clipboard",f),i.drag||t.notify({text:u,force:!0}),r.clipboard("changed"),h.resolve(f),h.promise()},paste:function(i){function a(){c=r.get_master();r._editRow=nt?[]:i.row||y;l=r.data();r._editRow=y;(!r.get_selectedValues()||nt)&&c&&r._filterFields&&(b=c.row(),r._filterFields.split(n._simpleListRegex).forEach(function(n,t){var i=c._keyFields[t];i&&(l[n]=b[i.Index])}));f.objects.forEach(function(n){var t,u=[];for(var i in l)u.push({Name:i,OldValue:l[i]});for(i in n)u.push({Name:s+"_"+i,OldValue:n[i]});t=r._createArguments({commandName:g,commandArgument:s},null,u);t.Sequence=0;k.push({controller:t.Controller,view:t.View,args:t})});f.drag||t.notify({text:f.text,force:!0});$.ajax({url:__servicePath+"/commit",method:"POST",authorize:!0,cache:!1,data:h({log:k})}).done(function(n){n=n.d;var s=o(f.id),h=s&&s.get_isGrid()&&s._controller===f.controller&&s._viewId===f.view;i.result=n;u=pt(r,i);u||(e=new v(r),e.after(i),e.canceled()&&(e.dispose(),u=!0));u||(n.Success?(r.sync(),h&&s.sync()):t.notify({text:n.Errors.join("\n"),force:!0}));w&&w()})}p.data();i=p._options(i);var s=f.controller,r=i.dataView,y=r._editRow,w=i.callback,c,l,b,k=[],d=f.drag,g=d?"DragDrop":f.cut?"CutPaste":"CopyPaste",nt=r.clipboard(d?"viewdrop":"viewpaste"),e,u;if(s){if(r._busy()||t.busy()){setTimeout(p.paste(i),100);return}if(i.commandName=g,i.commandArgument=s,!u)if(i._handled)u=!1;else{if(u=pt(r,i,!0),u&&u.then)return $.when(u).then(a),!1;if(!u)if(e=new v(r),e.before(i),e.canceled())e.dispose(),u=!0;else if(e._wait)return $.when(e._wait).then(a),!1}if(u)return!1;a()}},clear:function(){f.drag||n.userVar("clipboard",null);f={}}};n.parseMap=function(t,i){if(typeof t!="string"&&t!=null&&(t=t.items?t.items.copy:t.copy||t.Copy),t)for(var u=n._fieldMapRegex,r=u.exec(t);r;)i(r[1],r[2]),r=u.exec(t)};n.intersect=function(n,t){n=sr(n);t=sr(t);var i=n.right<t.left,r=n.left>t.right,u=n.top>t.bottom,f=n.bottom<t.top;return!(i||r||u||f)};n.find=function(t,i){var e,u,r,o=arguments.length===1||i==="Id",s=ht,f;if(!t)return null;if(o&&(r=s._components[t],i==="Id"))return r;if(!r){for(f=s.getComponents(),e="_"+t,u=0;u<f.length;u++)if(r=f[u],i){if(g(n,r)&&(i==="Controller"&&r._controller===t||i==="Tag"&&r.get_isTagged(t)))return r}else if(g(n,r)&&r._id.endsWith(e))return r;o&&(r=n.find(t,"Controller"))}return r};n.confirm=function(n,t,i){var r=$.Deferred();return s.confirm(n)?t?t():r.resolve():i?i():r.reject(),r};n.alert=function(n,t){var i=$.Deferred();return s.alert(n),t?t():i.resolve(),i};n.eval=function(n){if(n)for(var t=n.match(ki);t;)n=n.substring(0,t.index)+eval(t[1])+n.substring(t.index+t[0].length),t=n.match(ki);return n};n.showModal=function(i,r,u,f,e,o,s,h,c){var k=g(n,i),tt=c?c.survey:null,p=i,d,w,l,a,v,rt,y,ut,nt,ft;if(!t){if(k&&i._container&&(p=i._container.getElementsByTagName("a")[0]),!p)for(d=document.getElementsByTagName("a","input","button"),w=d.length-1;w>=0;w--)if(d[w].tabIndex>=0){p=d[w];break}if(p==null){alert("Cannot find an anchor for a modal popup.");return}ei()}if(t){if(t.busy())return;t.modalDataView()}o||(o=n._baseUrl);s||(s=n._servicePath);for(var b=this._placeholder=document.createElement("div"),et=tt&&tt.id||r.toLowerCase().replace(/\_+/g,"-"),it=et,ot=1;ht._components[it];)it=et+ot++;return b.id=String.format("{0}_{1}_Placeholder{2}",r,u,ht.getComponents().length),k?i._appendModalPanel(b):document.body.appendChild(b),b.className="ModalPlaceholder FixedDialog EmptyModalDialog",a={id:it,baseUrl:o,servicePath:s,controller:r,viewId:u,showActionBar:!1,modalAnchor:p,startCommandName:f,startCommandArgument:e,exitModalStateCommands:["Cancel"],externalFilter:h},c&&(c.useCase||(c.useCase=n._defaultUseCase,n._defaultUseCase=null),a.filter=c.filter,a.ditto=c.ditto,a.lastViewId=c.lastViewId,a.filterSource=c.filterSource,a.filterFields=c.filterFields,a.confirmContext=c.confirmContext,a.showSearchBar=c.showSearchBar,a.useCase=c.useCase,a.tag=c.tag,a.showActionButtons=c.showActionButtons,l=a.survey=tt),v=$create(Web.DataView,a,null,null,b),rt=k?i._dataText:null,k&&(ut=i._id,nt=i._externalFilter,t&&t.pageInfo(i._id).deleted&&(ut=i._parentDataViewId,nt&&nt.length&&(v._externalFilter=nt)),v._parentDataViewId=ut,v._hasDetails=i._hasDetails),t&&rt&&(ft=t.pageInfo(v._id),ft.headerText=rt,ft.headerTextLocked=!0),t&&(t._dataText=null),l?(y=l.text2,y&&typeof y=="function"&&(y=l.text2=y.call(v)),l.text&&typeof l.text=="function"&&(l.text=l.text.call(v)),!l.text&&y&&(l.text=y,y=l.text2=null),y&&(t?l.text=[l.text,y]:l.text+=" - "+y),l.description&&(v.set_showDescription(!0),v.set_description(l.description)),l.compiled=function(n){t?(l.result=n,l.show!==!1&&t.modalDataView(a.id,!0)):v._onGetPageComplete(n)},n.survey("compile",l)):t&&t.modalDataView(a.id,!0),v};n.alert=function(n,t){alert(n);t&&t()};n._resizeInterval=null;n._resizing=!1;n._resized=!1;n._customInputElements=[];n.contentFrameworks={bootstrap:{hasSelectors:[{name:"navbar-fixed-top",selector:".navbar-fixed-top"},{name:"navbar-fixed-bottom",selector:".navbar-fixed-bottom"},{name:"navbar-static-top",selector:".navbar-static-top"},{name:"footer",selector:"footer"}],footer:{selector:"footer,.footer",content:{html:'<footer><div class="container"><\/div><\/footer>',selector:".container"}},fixedTop:{selector:".navbar-fixed-top"},fixedBottom:{selector:".navbar-fixed-bottom"}}};n.filterDef=function(t,i){var u,r,f;for(i.endsWith("$")&&(i=i.substring(0,i.length-1)),u=0;u<t.length;u++)if(r=t[u],r)if(r.List){if(f=n.filterDef(r.List,i),f)return f}else if(r.Function==i)return r;return null};n._invoke=function(n,t,i,r){var f=$("<p>"),u=$create(Web.DataView,{servicePath:k,baseUrl:w,useCase:"$app"},null,null,f.get(0));u._busy(!0);u._invoke(n,t,function(n){u._busy(!1);i&&i(n);u.dispose();f.remove()},null,r)};n.callWithFeedback=function(n,i){t?t.callWithFeedback(n,i):i()};n.sizeToText=wr;n.cms={contentTypes:{"sys/api":{survey:"cms/api/api-wizard",text:"API Registration"},"sys/rules/":{survey:"cms/rules/rule-wizard",text:"Business Rule"},"sys/saas":{survey:"cms/oauth/oauth-wizard",text:"Open Authentication Registration"}},edit:function(i){var r,u;if(t){r=i.Path;for(u in lt)if(r&&r.startsWith(u))return n.survey({controller:lt[u].survey,context:i}),!0}},"new":function(){t&&n.survey({controller:"cms/new",context:{}})},items:function(){var n=[{value:"$custom",text:"(custom)"}];for(var t in lt)n.push({value:lt[t].survey,text:lt[t].text});return n}};lt=n.cms.contentTypes;n.userName=function(){return __settings.appInfo.split("|")[1]};n.userId=function(){return __settings.appInfo.split("|")[2]};n.loggedIn=function(){return!!n.userName()};tt.on("otpauth.app",function(t){var i=t.args;n.getScript("~/js/daf/daf-otpauth",function(){n.otpauth[i.otpauth].login(i)})});n.login=function(i,r,u,f,e){if(r==null&&t&&t.settings("membership.disableLoginPassword")&&(r="password"),t&&t.settings("ui.state.clear")==="always"){n.storage.clearUIState();try{sessionStorage&&(sessionStorage._clearUIState=!0)}catch(o){}}n._invoke("Login",{username:i,password:r,createPersistentCookie:n.AccountManager.enabled()?!1:u},function(i){i&&i!="false"?(i!="true"&&(r&&!r.match(/(.+?:.+?;){2,}/)&&(i.callback={success:f,error:e},i.password=r,i.createPersistentCookie=u),i.event?(tt.trigger($.Event(i.event,{args:i})),f=!1):i.alert?(n.alert(i.alert),f=!1):i.notify?(t.notify({text:i.notify,force:!0}),f=!1):(u||(i.session=!0),n.AccountManager.set(i))),f&&f(i)):e&&e(i)})};n.switchUser=function(t,i,r){n._invoke("Login",{username:t.name,password:"token:"+t.refresh_token,createPersistentCookie:!1},function(u){u?(u!="true"&&n.AccountManager.set(hr(t,u)),i&&i(u)):r&&r()})};n.refreshUserToken=function(t,i,r){n._invoke("Login",{username:t.name,password:"token:"+t.refresh_token,createPersistentCookie:!1},function(u){u?(typeof u=="object"&&n.AccountManager.set(hr(t,u)),i&&i(u)):r&&r()})};n.logout=function(t){n.AccountManager.remove(n.userName());n._invoke("Logout",{},function(){t&&t()})};n.roles=function(t){n._invoke("Roles",{},function(n){t&&t(n)})};n.configureFramework=function(t,i,r){$(n.contentFrameworks[t]).each(function(){var n=this;$(n.hasSelectors).each(function(){i.find(this.selector).length&&i.addClass("has-"+this.name)});n.footer&&!i.find(n.footer.container).find(n.footer.selector).length&&$(n.footer.content.html).appendTo(i).find(n.footer.content.selector).append($("#PageFooterBar,footer small").html());r&&r(n)})};n._contentFactories={"site-map":function(n){var r=n.attr("data-start-from-current-node")==="true",t=Web.Menu,i=t.Nodes[t.MainMenuId],u=cr(i),f=$('<ul class="SiteMapPlaceholder"/>').appendTo(n);lr(f,r?u.children:i)}};n.get_commandLine=function(){var t=n._commandLine;return t||(typeof __dacl!="undefined"&&(t=__dacl),t||(t=typeof Web.Membership!="undefined"&&Web.Membership._instance?Web.Membership._instance.get_commandLine():null,t=t?location.pathname+"?"+t:location.href),n._commandLine=n.unanchor(t)),t};n._parse=function(){(t=n.touch,ot=n.host,d=n.odp,w=s.__baseUrl,k=s.__servicePath,this._parsed)||(this._parsed=!0,$("div[data-controller]").each(function(){var n=$(this),i=n.attr("data-controller"),t,r,u;i&&(t=n.attr("id"),t||(t=i),r={id:t,controller:i,baseUrl:w,servicePath:k,showSearchBar:!0},u=[{name:"autoHide",aliases:["nothing","self","container"],values:[0,1,2]},{name:"autoSelectFirstRow",type:"bool"},{name:"autoHighlightFirstRow",type:"bool"},{name:"filterSource"},{name:"filterFields"},{name:"pageSize",type:"int"},{name:"refreshInterval",type:"int"},{name:"searchByFirstLetter",type:"bool",propName:"showFirstLetters"},{name:"searchOnStart",type:"bool"},{name:"selectionMode",aliases:["single","multiple"],values:["Single","Multiple"]},{name:"showActionBar",type:"bool"},{name:"showActionButtons",aliases:["","none","top","bottom","top-and-bottom"],values:["Auto","None","Top","Bottom","TopAndBottom"]},{name:"showDetailsInListMode",type:"bool"},{name:"showDescription",type:"bool"},{name:"showInSummary",type:"bool"},{name:"showModalForms",type:"bool"},{name:"showQuickFind",type:"bool"},{name:"showPageSize",type:"bool"},{name:"showPager",aliases:["none","top","bottom","top-and-bottom"],values:["None","Top","Bottom","TopAndBottom"]},{name:"showRowNumber",type:"bool"},{name:"showSearchBar",type:"bool"},{name:"showViewSelector",type:"bool"},{name:"startCommandName"},{name:"startCommandArgument"},{name:"summaryFieldCount",type:"int"},{name:"tag"},{name:"tags"},{name:"view",propName:"viewId"},{name:"visibleWhen"}],$(u).each(function(){var t=this,i=n.attr("data-"+t.name.replace(/([A-Z])/g,"-$1"));i&&(t.aliases&&(i=t.values[Array.indexOf(t.aliases,i.toString().toLowerCase())]),t.type==="bool"&&(i=i==="true"),t.type==="int"&&(i=nt(i)),r[t.propName||t.name]=i)}),n.attr("id",null),$create(Web.DataView,r,null,null,this))}))};n.DetailsRegex=/\/Details\.aspx\?/i;n.LocationRegex=/^(_.+?):(.+)$/;n.LEVs=[];n.Editors=[];n.EditorFactories={};n.dateFormatStrings={"{0:g}":u.ShortDatePattern+" "+u.ShortTimePattern,"{0:G}":u.ShortDatePattern+" "+u.LongTimePattern,"{0:f}":u.LongDatePattern+" "+u.ShortTimePattern,"{0:u}":u.SortableDateTimePattern,"{0:U}":u.UniversalSortableDateTimePattern};_field_prepareDataFormatString=function(t,i){if(i.DataFormatString&&i.DataFormatString.indexOf("{")===-1&&(i.DataFormatString="{0:"+i.DataFormatString+"}"),i.DataFormatString&&(i.DataFormatString=t.resolveClientUrl(i.DataFormatString)),i.Type.startsWith("Date"))if(i.DataFormatString){var f=i.DataFormatString.match(/{0:(g)}/i),r;f&&(i.DateFmtStr="{0:"+u.ShortDatePattern+"}",i.TimeFmtStr="{0:"+(f[1]==="g"?u.ShortTimePattern:u.LongTimePattern)+"}");r=n.dateFormatStrings[i.DataFormatString];r&&(i.DataFormatString="{0:"+r+"}");i.DateFmtStr&&(i.DataFmtStr=i.DataFormatString)}else i.DataFormatString="{0:d}"};n._tagTests={};_isTagged=n.is=function(t,i){var r,f,e=!1,u;return t&&(r=n._tagTests[i],r||(r=new RegExp("(^|\\s|,)"+RegExp.escape(i)+"(-(\\w+))?\\b"),n._tagTests[i]=r),f=t.match(r),f&&(u=f[3],u==null?e=!0:u!="none"&&(e=u))),e};_field_is=function(n){return _isTagged(this.Tag,n)};_field_tagged=function(t){var r=this.Tag,u,f,o="",e=arguments,i,s;if(r){if(e.length===1&&t.ignoreCase!=null)return(r||"").match(t);for(i=0;i<e.length;i++)if(f=e[i],u=r.indexOf(f),u>=0){for(i=u+f.length;i<r.length;)if(s=r[i].match(/\d/),s)o+=r[i++];else break;return n.tagSuffix=o,!0}}return!1};_field_tag=function(n){this.Tag=(this.Tag||"")+","+n};_field_lov=function(n){var t=this,i=t.ItemsDataController;return n==="dynamic"?!!i:n==="static"?!i&&!!t.ItemsStyle:t.Items};_field_toColumns=function(){var t=this,n=t.Columns;return n===0&&t.Type==="String"&&(n=Math.floor(t.Len)),t.ItemsTargetController&&!n?n=80:n>80?n=80:n||(t.Type==="String"?(n=t.Rows>1?80:30,t.Len>0&&t.Len<n&&(n=t.Len)):n=7),t.Type.match(/^Date/)&&n<20?n=t.DataFormatString==="d"||t.DataFormatString==="{0:d}"?10:n:t.Type==="Guid"&&n<36&&(n=36),n};_field_format=function(n){var t=this,u=t.FormatOnClient,i=t.DataFormatString;try{return n!=null&&t.Type==="TimeSpan"&&i&&u&&typeof n=="string"&&(n=Date.tryParseFuzzyTime(n,!1)),n==null?"null":u&&!r(i)?String.localeFormat(i,n):n.toString()}catch(f){throw new Error(String.format("\nField: {0}\nData Format String: {1}\n{2}",t.Name,i,f.message));}};_field_isReadOnly=function(){return this.TextMode===4||this.ReadOnly};_field_isNumber=function(){return this.Type.match(n.numericTypeRegex)};_field_htmlEncode=function(){return this.HtmlEncode&&this.TextMode!==2};_field_trim=function(n){var t=this;return t.Type==="String"&&n!=null&&n.length>b.MaxReadOnlyStringLen&&!(t.TextMode===3||t.TextMode===2||!t.HtmlEncode&&n.match(/<\/?\w+>/))&&(n=n.substring(0,b.MaxReadOnlyStringLen)+"..."),n};_field_text=function(t,i){var u=this,r,s,h=u.ItemsStyle==="CheckBoxList",f=u._dataView,e,o=yi,c=u.DynamicItems||u.Items;return c.length?u.ItemsDataController?(r=[],t&&typeof t!="string"&&(t=t.toString()),u.ItemsTargetController||h?(s=(t||"").split(","),$(c).each(function(){var n=this;s.indexOf((n[0]||"").toString())!==-1&&r.push(n[1])})):$((t||"").split(",")).each(function(){var n=f._findItemByValue(u,this);n&&r.push(n[1])}),r=r.length?r.join(", "):o):t==null?r=o:h?(r=[],$(t.toString().split(/,/g)).each(function(){var n=f._findItemByValue(u,this);n&&r.push(n[1])}),r=r.join(", ")):(e=f._findItemByValue(u,t),r=e?e[1]:t.toString()):r=st(t)?o:u.Type!=="Byte[]"||u.OnDemand?u.format(t):n.toHexString(t),u.TextMode===1&&(r="**********"),i!==!1&&(r=u.trim(r)),r};Array.indexOfCaseInsensitive=function(n,t){t=t.toLowerCase();for(var i=0;i<n.length;i++)if(n[i].toLowerCase()==t)return i;return-1};Number.tryParse=function(n){var t,i,u;return typeof n!="string"?null:r(n)?null:(t=Number.parseLocale(n),isNaN(t)&&(i=di.numberFormat,i._simplifyRegex||(i._simplifyRegex=new RegExp(String.format("({0}|\\{1})",i.CurrencySymbol.replace(/(\W)/g,"\\$1"),i.CurrencyGroupSeparator),"gi")),u=n.match(/\(/)!=null,n=n.replace(i._simplifyRegex,"").replace(/\(|\)/g,""),n=n.replace(i.CurrencyDecimalSeparator,i.NumberDecimalSeparator),t=Number.parseLocale(n),isNaN(t)&&(t=Number.parseLocale(n.replace(i.PercentSymbol,"")),isNaN(t)||(t/=100))),!isNaN(t))?(u&&(t*=-1),t):null};Date.tryParseFuzzyDate=function(n,t){var i,y,f,e,c,h,l,a,o,s,v;if(r(n))return null;if(n=n.trim(),i=Date.parseLocale(n,u.ShortDatePattern),i==null&&(i=Date.parseLocale(n,u.LongDatePattern)),i!=null||r(t)||(y=t.match(/\{0:([\s\S]*?)\}/),y&&(i=Date.parseLocale(n,y[1]))),i)return i;if(i=new Date,f=n.match(/^(\w+)$/),f&&(e=Array.indexOfCaseInsensitive(u.DayNames,f[1]),e===-1&&(e=Array.indexOfCaseInsensitive(u.AbbreviatedDayNames,f[1])),e===-1&&(e=Array.indexOfCaseInsensitive(u.ShortestDayNames,f[1])),e>=0)){while(i.getDay()!=e)i.setDate(i.getDate()+1);return i}if(f=n.match(/^(\w+|\d+)[^\w\d]*(\w+|\d+)$/),f&&(c=f[1],h=f[2],c.match(/\d+/)&&(c=h,h=f[1]),f=h.match(/\d+/),h=f?f[0]:1,e=Array.indexOfCaseInsensitive(u.MonthNames,c),e==-1&&(e=Array.indexOfCaseInsensitive(u.AbbreviatedMonthNames,c)),e>=0)){for(i.setDate(1);i.getMonth()!=e;)i.setMonth(i.getMonth()+1);return i.setDate(h),i}if(f=n.match(/^(\d\d?)(\D*(\d\d?))?(\D*(\d\d\d?\d?))?$/),!f)return null;try{if(u.LogicalYearPosition||(l=u.ShortDatePattern.indexOf("m"),l<0&&(l=u.ShortDatePattern.indexOf("M")),a=u.ShortDatePattern.indexOf("d"),a<0&&(a=u.ShortDatePattern.indexOf("D")),u.LogicalYearPosition=5,u.LogicalMonthPosition=l<a?1:3,u.LogicalDayPosition=l<a?3:1),o=f[u.LogicalYearPosition],o=r(o)?i.getFullYear():Number.parseLocale(o),!isNaN(o)&&o<50&&(o+=u.Calendar.convert?1400:2e3),s=f[u.LogicalMonthPosition],r(s)?s=i.getMonth():(s=Number.parseLocale(s),s--),v=f[u.LogicalDayPosition],v=r(v)?i.getDate():Number.parseLocale(v),i=new Date(o,s,v),isNaN(i.getTime()))return null}catch(p){return null}return i};Date.tryParseFuzzyTime=function(n,t){var e,i;if(r(n))return null;if(n=n.trim(),e=null,i=n.match(/^(\d\d?)(\D*(\d\d?))?(\s*(\w+))?$/),i||(i=n.match(/^(\d\d?)(\D*(\d\d?))?(\D*(\d\d?))?(\D*(\d+))?(\s*([\S\s]+))?$/)),i){e=new Date;var f=i[1],o=i[3]||"0",s=i.length===10?i[5]:"0",h=i.length===10?i[7]:"0",c=i[i.length-1];r(f)||(f=Number.parseLocale(f),r(c)?t!==!1&&!r(u.PMDesignator)&&u.ShortTimePattern.indexOf("tt")>0&&(new Date).getHours()>=12&&(f+=12):c.toLowerCase()===u.PMDesignator.toLowerCase()?f!==12&&(f+=12):f===12&&(f=0),e.setHours(f));r(o)||e.setMinutes(Number.parseLocale(o));e.setSeconds(r(s)?0:Number.parseLocale(s));e.setMilliseconds(r(h)?0:Number.parseLocale(h))}return e};Date.tryParseFuzzyDateTime=function(n,t){var e,i,f;return(n=n.trim(),e=n.match(/([^\s]+)\s+(.+)/),e)?!r(u.AMDesignator)&&(e[2].toLowerCase()==u.AMDesignator.toLowerCase()||e[2].toLowerCase()==u.PMDesignator.toLowerCase())?Date.tryParseFuzzyTime(n):(i=Date.tryParseFuzzyDate(e[1],t),f=Date.tryParseFuzzyTime(e[2],!0),i||f?i&&!f?i:!i&&f?f:(f.setFullYear(i.getFullYear(),i.getMonth(),i.getDate()),f):null):null};Date._localTimeEnabled=function(){var i=this,n=i._lte;return typeof n!="boolean"&&(n=i._lte=t?t.settings("dates.localTime.enabled")===!0:!1),n===!0};Date._jsonRegex=new RegExp(/(\d{4})\-(\d{2})\-(\d{2})T(\d{2})\:(\d{2})\:(\d{2})\.(\d{3})(Z)?/);Date.fromUTCString=function(n){if(Date._localTimeEnabled())return new Date(n.match(/z$/i)?n:n+"Z");var t=Date._jsonRegex.exec(n),i;return t&&(i=new Date(nt(t[1]),nt(t[2])-1,nt(t[3]),nt(t[4]),nt(t[5]),nt(t[6]),nt(t[7]))),i};n._dateRegex=/\"(\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}\.\d{3})Z?\"/g;n.parseJSON=function(t,i){return t?i===!1||!t.match(n._dateRegex)?JSON.parse(t).d:eval("("+vr(t,i)+")").d:null};n.serializer=kt={serialize:h,deserialize:function(t){try{return t==null?null:t.match(n._dateRegex)?eval("("+vr(t)+")"):JSON.parse(t)}catch(i){throw Error.argument("data",c.Res.cannotDeserializeInvalidJson);}}};c.Serialization&&(c.Serialization.JavaScriptSerializer.deserialize=kt.deserialize);Date.$addDays=function(n,t){return n?new Date(n.setDate(n.getDate()+t)):n};Date.$now=function(){return new Date};Date.$today=function(){var n=new Date;return new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0)};Date.$endOfDay=function(){var n=new Date;return new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59)};Date.$within=function(n,t){return n?n<Date.$addDays(Date.$today(),t)&&n>=Date.$today():!1};Date.$pastDue=function(n,t){return t==null&&(t=new Date),t.getHours()||(t=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59)),n==null&&(n=new Date),n>t};Date.prototype.getFullYearText=function(){return u.Calendar.convert?(u.Calendar.convert.fromGregorian(this)||[this.getFullYear()])[0]:this.getFullYear()};s.__designer=function(){return typeof __designerMode!="undefined"};s.__evalEvent=function(n){var t=this.getAttribute("on"+n+"2"),i;return r(t)?!0:(i=!0,t=t.replace(/(^|;)return /g,";returnResult="),eval(t),i)};v=it.BusinessRules=function(n){this._dataView=n;this.result=new Web.BusinessRules.Result(this)};v.reset=function(n){typeof n!="string"&&(n=n._controller);var t=wt[n];t&&(t.forEach(function(n){delete v[n]}),t.splice(0))};wt=v._controllers={};v.prototype={canceled:function(){return this._canceled===!0},trigger:function(){return this._args.trigger},dispose:function(){this.reset(null);this._wait=null;this._dataView=null;this.result._rules=null},reset:function(n){this._actionArgs=null;this._args=n},_initialize:function(){if(!this._actionArgs){var n=this._dataView;this._actionArgs=n._createArguments(this._args,null);n.editing()&&(n._validateFieldValues(this._actionArgs.Values,this._args.causesValidation,!1),this._valid=n.validate(this._actionArgs.Values))}},process:function(i){var u=this,o=u._dataView,y=u._args,l=y.commandName||y.CommandName,d=y.commandArgument||y.CommandArgument,c,a,g,f,s,ft,nt,tt,p,w,et,k,e,h,b,ut;if(l==="Calculate"&&o._lookupIsActive){u.preventDefault();return}if(c=n.Geo,c&&c.acquired&&(l.match(/New|Edit/)||l.match(/Update|Insert/)&&i==="Before")){for(g=this._dataView._fields,f=0;f<g.length;f++)s=g[f],s._geocode&&!s.readOnly&&(s.tagged("modified-latitude")||s.tagged("created-latitude")&&l.match(/New|Insert/)?u.updateFieldValue(s.Name,c.latitude===-1?null:c.latitude):s.tagged("modified-longitude")||s.tagged("created-longitude")&&l.match(/New|Insert/)?u.updateFieldValue(s.Name,c.longitude===-1?null:c.longitude):(s.tagged("modified-coords")||s.tagged("created-coords")&&l.match(/New|Insert/))&&u.updateFieldValue(s.Name,c.latitude===-1?null:String.format("{0},{1}",c.latitude,c.longitude)));if(a=u._newValues,a)if(t){for(ft=o.editRow(),f=0;f<a.length;)tt=a[f],nt=o.findField(tt.Name),nt&&ft[nt.Index]===tt.NewValue?a.splice(f,1):f++;a.length&&n.input.execute({dataView:o,values:a})}else o._updateCalculatedFields({Errors:[],Values:a});u._newValues=null}if(p=o._expressions,w=o._controller,p&&p.length){if(!u._rules)for(u._rules=[],et=0,f=0;f<p.length;f++)if(k=p[f],k.Type===Web.DynamicExpressionType.ClientScript&&k.Scope===Web.DynamicExpressionScope.Rule&&(e=k.Result.match(/^<id>(.+?)<\/id><command>(.+?)<\/command><argument>(.*?)<\/argument><view>(.*?)<\/view><phase>(.*?)<\/phase><js>([\s\S]+?)<\/js>$/),e)){var it=String.format("{0}_Rule_{1}",w,e[1]?e[1]:et),ot="Web.BusinessRules."+it,rt=v[it];if(!rt)try{rt=eval(u._parseRule(ot,e[6]));wt[w]||(wt[w]=[]);wt[w].push(it)}catch(st){n.alert(String.format('{0}\n\ncommand: "{1}"\nargument: "{1}"\nview: "{3}"\nphase: "{4}"\n\n{5}',st.message,e[2],e[3]||"n/a",e[4]||"n/a",e[5],(e[6]||"").trim()))}Array.add(u._rules,{commandName:e[2],commandArgument:e[3],view:e[4],phase:e[5],script:rt})}for(f=0;f<u._rules.length;f++)if((h=u._rules[f],h.phase===i)&&(b=!1,r(h.view)||(ut=o.get_viewId(),h.view===ut||ut.match(new RegExp(h.view))||(b=!0)),r(h.commandName)||h.commandName===l||l.match(new RegExp(h.commandName))||(b=!0),r(h.commandArgument)||h.commandArgument===d||d&&d.match(new RegExp(h.commandArgument))||(b=!0),!b)){if(y.causesValidation&&(u._initialize(),!u._valid)){u.preventDefault();break}if(h.script.call(u),u.canceled())break}u._newValues?(t?n.input.execute({dataView:o,values:u._newValues,raiseCalculate:l!=="Calculate"}):o._updateCalculatedFields({Errors:[],Values:u._newValues}),u._newValues=null,u._pendingFocus()):u.canceled()&&o.get_isDataSheet()&&(o._updateCalculatedFields({Errors:[],Values:[]}),u._pendingFocus())}},_pendingFocus:function(){var n=this;n._focusFieldName&&(n._dataView._focus(n._focusFieldName,n._focusMessage),n._focusFieldName=null)},before:function(n){var t=this;t.reset(n);t.process("Before");t.canceled()||t.process("Execute")},after:function(n){this._dataView._isBusy||(this.reset(n),this.process("After"))},_parseRule:function(n,t){var i,r;return t=yr(t),i=new et,i.appendFormat("{0}=function(){{\nvar _this=this;\n",n),r=/([\s\S]*?)(\[(\w+)(\.(\w+))?\](\s*=([^=][\s\S]+?);)?)/g,this._parseScript(i,r,t),t=i.toString(),i.clear(),this._parseScript(i,r,t),i.append("\n}"),i.toString()},_parseScript:function(n,t,i){for(var e=-1,u,f,o,s;u=t.exec(i);)n.append(u[1]),f=u[3],o=u[5],u[1].match(/\w$/)?n.append(u[2]):f.match(/^master$/i)?n.appendFormat("_this.fieldValue('{0}','Master')",o):(s=this._dataView.findField(f),r(u[7])?n.appendFormat("_this.fieldValue('{0}','{1}')",f,o):n.appendFormat("_this.updateFieldValue('{0}',{1})",f,u[7])),e=t.lastIndex;e!==-1?n.append(e<i.length?i.substr(e):""):n.append(i)},preventDefault:function(){this._canceled=!0;this._dataView._raiseSelectedDelayed=!1;this._dataView._pendingSelectedEvent=!1},validateInput:function(){return this._initialize(),this._valid==!0},dataView:function(){return this._dataView},odp:function(n){var t=this._dataView.odp,i=t;return n&&(i=!1,t&&(i=t.is(n))),i},busy:function(){return this._dataView._busy()},arguments:function(){return this._initialize(),this._actionArgs},selectFieldValueObject:function(n){var i,t,r;for(this._initialize(),i=this._actionArgs.Values,t=0;t<i.length;t++)if(r=i[t],n===r.Name)return r;return this._dataView.findField(n)?{Name:n,Value:null}:null},selectFieldValue:function(n){var t=this.selectFieldValueObject(n);return t?t.Modified?t.NewValue:t.OldValue:null},fieldValue:function(n,t){var r,u,i;if(t==="Master"||t==="master")return r=this._dataView.get_master(),r?r.fieldValue(n):null;if(t==="context")return u=this._dataView.get_parentDataView(),u?u.fieldValue(n):null;if(!t||t==="Value")return this.selectFieldValue(n);i=this.selectFieldValueObject(n);i||this._unknownField(n);switch(t){case"NewValue":return i.NewValue;case"OldValue":return i.OldValue;case"Modified":return i.Modified;case"ReadOnly":return i.ReadOnly;case"Error":return i.Error;default:return i.OldValue}},updateFieldValue:function(n,t,i){var u=this,f,r,e;if(i==="master")u._dataView.updateFieldValue(n,t,i);else if(f=u.selectFieldValueObject(n),f){for(f.NewValue=t,f.Modified=!0,r=u._newValues,r||(r=u._newValues=[]),e=0;e<r.length;e++)if(r[e].Name===n){Array.removeAt(r,e);break}Array.add(r,f)}else u._unknownField(n)},property:function(n,t){if(n="Rules$"+n,arguments.length===1)return this._dataView.readContext(n);this._dataView.writeContext(n,t)},_unknownField:function(n){throw new Error(String.format('Unknown field "{0}" is not defined in  /controllers/{1}/views/{2}.',n,this._dataView._controller,this._dataView._viewId));},wait:function(n){return this._wait=n,n}};v.Result=function(n){this._rules=n};v.Result.prototype={focus:function(n){var r=null,u,i,f;arguments.length>1&&(u=Array.clone(arguments),Array.removeAt(u,0),r=String._toFormattedString(!0,u));i=this._rules;f=i._dataView;t||(i._focusFieldName=n,i._focusMessage=r);setTimeout(function(){f._focus(n,r)})},showMessage:function(){n.showMessage(String._toFormattedString(!0,arguments))},showViewMessage:function(){this._rules._dataView.showViewMessage(String._toFormattedString(!0,arguments))},showAlert:function(){alert(String._toFormattedString(!0,arguments))},confirm:function(){return confirm(String._toFormattedString(!0,arguments))},refresh:function(n){this._rules._dataView(n==!0)},refreshChildren:function(){this._rules._dataView.refreshChildren()}};si={fileReader:typeof FileReader!="undefined",formData:!!window.FormData,progress:"upload"in new XMLHttpRequest,dragAndDrop:"draggable"in document.createElement("span")};n.filterOpValueRequired=function(n){return!!n.match(/^(=|<>|<|>|<=|>=|(\$(between|in|notin|beginswith|doesnotbeginwith|contains|doesnotcontain|endswith|doesnotendwith)))$/)};n.saveFile=function(t,i,r){var u=new Blob(["",i],{type:r||(n.agent.ie?"data:attachment/text":"text/plain")});u.name=t;n.saveBlob(u)};n.saveBlob=function(t){var i,r,u;typeof t=="string"?(i=new XMLHttpRequest,i.open("GET",n.resolveClientUrl(t),!0),i.responseType="blob",i.onload=function(t){var i=t.currentTarget,r=i.response,u=i.getResponseHeader("Content-Disposition"),f=u&&u.match(/filename=(.+?)(;|$)/);f&&(r.name=f[1]);n.saveBlob(r)},i.send()):navigator.msSaveBlob?navigator.msSaveBlob(t,t.name):(r=URL.createObjectURL(t),u=fi(""),u.attr({download:t.name||"file."+(t.type||"/dat").split(/\//)[1],href:r})[0].click(),URL.revokeObjectURL(r))};n.dataUrlToBlob=function(n){var i,u,r,t;for(i=n.split(",")[0].indexOf("base64")>=0?atob(n.split(",")[1]):unescape(n.split(",")[1]),u=n.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(i.length),t=0;t<i.length;t++)r[t]=i.charCodeAt(t);return new Blob([r],{type:u})};n.blobFields={name:["FileName","FILENAME","FILE_NAME","filename","file_name"],type:["ContentType","CONTENTTYPE","CONTENT_TYPE","contenttype","content_type"],size:["Length","LENGTH","length"]};n.upload=function(i,r){function b(){var i=s.devicePixelRatio||1,n=u.find("canvas"),r,t;n.length&&(r=n.width(),n.height(Math.ceil(r*.5)),n=n[0],n.width=n.offsetWidth*i,n.height=n.offsetHeight*i,t=n.getContext("2d"),t.scale(i,i),u.data("signature").clear(),u.addClass("app-empty"),t.fillStyle="#ccc",t.font="20pt Arial",t.textAlign="center",t.fillText(l.Sign,r/2,n.height/2+10))}function rt(){var r=o(h),a=r.findField(f),s=u.data("signature"),c=t?r.commandRow():r.get_currentRow(),l=c&&c[a.Index],i=l!=null&&!l.toString().match(/^null\|/),e;return u.is(".app-signature")?(e=!s.isEmpty(),i=i||e,hi(r,f,e?n.dataUrlToBlob(s.toDataURL("image/png",1)):null)):i=i||u.find("div").length>0,i}function k(){var n=r.multiple;return t&&!t.desktop()?n?l.TapMany:l.Tap:n?l.ClickMany:l.Click}function g(n,t){yt("app-drop-text").appendTo(n).text(t)}function tt(){g(u.empty().addClass("app-drop-box app-empty").attr("title",k()),k())}function nt(i,r){if(u.is(".app-had-blob")&&u.addClass("app-had-file"),u.is(".app-clearing"))g(u.empty(),l.Cleared),u.parent().find("img").css("opacity",.3);else if(i){var f;t?t.icon("material-icon-delete",f=yt("app-clear ui-btn ui-btn-icon-notext")):f=fi("app-clear").addClass("ui-icon-trash").text(l.Clear);f.appendTo(u).attr("title",l.Clear);t&&!n.input.elementToField(u).tagged("image-editor-none")&&(!r||r.length===1&&r[0].type.match(/^image/))&&t.icon("material-icon-"+(n.agent.ie?"tune":"draw"),yt("app-draw ui-btn ui-btn-icon-notext").appendTo(u).attr("title",e.Draw.Draw))}else g(u.css("min-height",""),k())}function ut(){var v,w;if(!u.is(".app-drop-box")){tt();var e=o(h),s=e.findField(f),k=e.editRow(),c=k[s.Index],i=c&&!c.match(/null\|/);if(s.OnDemandStyle===2){u.empty().attr("title",l.Sign);v=a("canvas").width("100%").appendTo(u).get(0);u.addClass("app-signature").data("signature",new SignaturePad(v,{backgroundColor:"white",onEnd:function(){u.removeClass("app-empty")}}));$(t?yt("material-icon app-icon app-clear"):fi("app-clear ui-btn ui-btn-inline ui-corner-all")).insertAfter(u).text(t?"delete":l.Clear).attr("title",l.Clear).on(p,function(){if(u.data("signature").isEmpty()){t&&t.activeLink();return}u.addClass("app-dragging");t&&t.saveLastFocusedField(f);n.confirm(l.ClearConfirm).then(function(){if(u.removeClass("app-dragging").addClass("app-empty").focus(),b(),h){var n=o(h);hi(n,f,null)}r.change&&r.change()}).fail(function(){u.removeClass("app-dragging").focus()})});t||b()}else{i&&(u.addClass("app-had-blob"),nt(i));w=a("input",null,'type="file"').insertAfter(u).hide().on("change",function(){var n=this.files;n.length>0&&y(n)});r.multiple&&w.attr("multiple","");u.on("dragenter dragover",function(n){return n.originalEvent.dataTransfer.files.length?u.addClass("app-dragging"):n.originalEvent.preventDefault(),!1}).on("dragend dragleave",function(){return u.removeClass("app-dragging"),!1}).on("drop",function(i){u.removeClass("app-dragging");i.preventDefault();var f=i.originalEvent.dataTransfer.files,r;if(f.length&&!u.is(".app-uploading")){if(t&&(r=n.input.elementToField(u),n.input.focus({field:r.Name}),r.tagged("image-user-defined-none")))return;y(f)}}).on(p,function(e){if(t&&t.saveLastFocusedField(f),!u.is(".app-uploading"))var s=$(e.target);if(s.closest(".app-draw").length)n.input.methods.blob.draw(u);else if(s.closest(".app-clear").length)u.addClass("app-dragging"),n.confirm(u.find("div").map(function(){return $(this).text()}).get().join(", ")+"\n\n"+l.ClearConfirm,function(){if(u.removeClass("app-dragging").focus(),tt(),u.next().val(""),h){var t=o(h),n=null;i&&(n=[new Blob],u.addClass("app-clearing"));hi(t,f,n)}return r.change&&r.change(),i&&nt(i),!1},function(){u.removeClass("app-dragging").focus()});else try{if(t&&(n.input.blur(),n.input.elementToField(u).tagged("image-user-defined-none")))return n.input.of(s).find(".app-draw").trigger(p),!1;u.next()[0].click()}catch(c){}return!1})}}}function ft(){r.change=null;u.is(".app-signature")?(u.removeData().find("canvas").off(),u.next().off().remove()):u.off().addClass("app-drop-box-destroyed").next().off().remove()}function it(t,i,r){if(i>=t.length)y(t,!0);else{var u=r.width,f=r.height,e=u,o=f,c=r.background,v=r.small,s=r.large,h=t[i],l=new FileReader;l.onload=function(l){var y=new Image;y.onload=function(){var l=y.width,p=y.height,ut=v==="reject",ft=s==="reject",g,k,et;if(ut&&l<u&&p<f||ft&&l>u&&p>f)t.splice(i,1);else if(ut&&ft)i++;else{l>=p?l>u?(f=u*p/l,s==="cover"?(u*=o/f,f=o,u<e&&(f*=e/u,u=e)):f>o&&(u*=o/f,f=o)):(u=l,f=p):p>f?(u=f*l/p,s==="cover"?(f*=e/u,u=e,f<o&&(u*=o/f,f=e)):u>e&&(f*=e/u,u=e)):(f=p,u=l);u=Math.floor(u);f=Math.floor(f);var d=y,tt,w=u,b=f;if(u!==l||f!==p)if(l*.5*.5<u)w=l,b=p;else for(d=a("canvas")[0],tt=d.getContext("2d"),w=Math.floor(l*.5),b=Math.floor(p*.5),d.width=w,d.height=b,tt.drawImage(y,0,0,w,b);w*.5>u;)w=Math.floor(w*.5),b=Math.floor(b*.5),tt.drawImage(d,0,0,w*2,b*2,0,0,w,b);s==="clip"&&(e=Math.min(u,e),o=Math.min(f,o));g=a("canvas")[0];k=g.getContext("2d");g.width=e;g.height=o;(e!==u||o!==f)&&(k.beginPath(),k.rect(0,0,e,o),et=k.fillStyle,k.fillStyle=c,et===k.fillStyle&&(k.fillStyle="#"+c),k.fill());k.drawImage(d,0,0,w,b,Math.floor(e-u)/2,Math.floor(o-f)/2,u,f);var ot=r.format,nt=n.dataUrlToBlob(g.toDataURL("image/"+ot,r.quality)),rt=h.name.match(/^(.+?)(\..+)?$/);rt=rt[1];nt.name=rt+"."+ot;nt.lastModified=h.lastModified;nt.lastModifiedDate=h.lastModifiedDate;nt.quality=r.quality;t[i++]=nt;it(t,i,r)}};y.src=l.target.result};l.readAsDataURL(h)}}function y(n,i){!r.multiple&&n.length>1&&(n=[n[0]]);var p=0,e=o(h),s=e.findField(f),c,w,b,k,d,g,tt,l,v,rt,y=!n.length;if(!i&&(c=s.tagged(/\bimage\-size\-(\d+)x(\d+)\b/),c)){for(l=[],v=0;v<n.length;v++)rt=n[v],rt.type.match(/^image\//)&&l.push(rt);l.length&&(b=s.tagged(/\bimage\-small\-(\w+)\b/),k=s.tagged(/\bimage\-large\-(\w+)\b/),d=s.tagged(/\bimage\-format\-(\w+)\b/),g=s.tagged(/\bimage\-quality\-(\d+)\b/),w=s.tagged(/\bimage\-background\-(\w+)\b/),it(l,0,{width:parseInt(c[1]),height:parseInt(c[2]),background:w?w[1]:"fff",large:k?k[1]:"fit",small:b?b[1]:"center",format:d?d[1]:"png",quality:Math.min(1,(g?g[1]:100)/100)}));return}tt=e&&!t&&e.get_isModal()?$(e._container).height():0;u.is(":empty")||u.css("min-height",u.height());u.find("img div").off();u.empty().toggleClass("app-empty",y);$(n).each(function(i){var f=this,s=n.length>1?(i+1).toString()+". ":"",h=wr(f.size),c=rr().appendTo(u).text(s+f.name+" - "+h),o;si.fileReader&&f.type.match(/^image\//i)&&(p++,o=new FileReader,o._fileInfo=c,o.onload=function(n){a("img","",'draggable="false"').attr("src",n.target.result).insertAfter(this._fileInfo).one("load",function(){r.change&&r.change()});this._fileInfo=null;--p==0&&(u.css("min-height",""),tt&&$(e._container).height(tt),t&&(t.syncEmbeddedViews(),t.summary("fetch")))},o.readAsDataURL(f));p||(u.css("min-height",""),r.change&&r.change())});y||u.removeClass("app-clearing");nt(!y,n);s.tagged("image-user-defined-none")&&u.removeAttr("title");e&&!y&&hi(e,f,n)}function et(){var n=a("progress",null,'max="100"');return r.container.addClass("app-uploading"),n.val(0).insertBefore(r.container.contents().first()),r.progress=function(t){if(t.lengthComputable){var i=t.loaded/t.total*100|0;n.val(i)}},d.upload(r).done(function(){r.container.removeClass("app-uploading")}).fail(function(){r.container.removeClass("app-uploading");n.remove()})}var w,c;if(!arguments.length||!si.formData)return si.formData;var v=r.field,u=$(r.container),h=v?v._dataView._id:r.dataViewId,f=v?v.Name:r.fieldName,p=t?"vclick":"click";switch(i){case"create":ut();break;case"destroy":ft();break;case"execute":return et();case"resize":w=u.data("screen-width");(t||w==null||w!==bt.width())&&(u.is(":visible")&&u.data("screen-width",bt.width()),b());break;case"validate":return rt();case"capture":c=r.files;c.length||(c=[c]);y(c)}};n.upload.multi={show:function(i,r){d.getControllers(i._controller).then(function(u){var e=u[0],f;r||(r="createForm1");e.views.forEach(function(n){n.id===r&&(f=n)});f&&t&&(t.whenPageShown(function(){$(".ui-page-active input:file").trigger("click")}),n.survey({text:f.label,text2:ni.ActionBar.Upload.HeaderText,context:{id:i._id,controller:e,view:f},controller:"multi_file_upload",topics:[{wrap:!0,questions:[{name:"files",text:!1,type:"blob",multiple:!0}]}],options:{materialIcon:"upload",discardChangesPrompt:!1,modal:{fitContent:!0,max:"xs",always:!0,autoGrow:!0}},submitText:ut.Submit,submit:"multifileupload.app"}))})},send:function(i){function o(r){t.busy(!1);t.notify(r?{text:r,force:!0,duration:"long"}:!1);n.find(i.id).sync(i.sync,!0)}var h=i.files,c=i.index++,f=i.context,u,e=f||{},l=i.controller,a=[],r,s;if(c<h.length){if(t.busy(!0),u=h[c],t.notify({text:String.format(ut.Sync.Uploading,u.name),duration:6e4,force:!0}),i.name&&(r=u.name,r.length>i.nameLen&&(r=r.match(/^(.+?)(\..+)$/),r=r[1].substring(0,i.nameLen-r[2].length)+r[2]),e[i.name]=r),i.type&&(e[i.type]=u.type),i.size&&(e[i.size]=u.size),f)for(s in f)a.push({Name:s,Value:f[s]});n.execute({controller:l,view:i.view,command:"Insert",values:e,externalFilter:a}).then(function(t){if(t.errors.length)o(t.errors.join("\n"));else{var r=t[l][i.key];r==null&&i.name===i.key&&(r=u.name);i.sync||(i.sync=r);d.uploadFile({apiVer:2,key:r,handler:i.handler,file:u}).then(function(){n.upload.multi.send(i)}).fail(function(){o()})}}).fail(function(){o()})}else o()}};tt.on("multifileupload.app",function(i){function f(t,i){for(var c=n.blobFields[t],s,e,o=0;o<c.length;o++)if(s=u._map.fields[(i&&r.name||"")+c[o]],s){e=s.name;break}return!e&&i&&(e=f(t)),t==="name"&&e&&(h=e.length),e}var c=i.dataView,p=c.data(),e=c.survey().context,u=e.controller,l=e.view,a=e.id,o=n.find(a),r,s,h,w=[],v=p.files,y={};l.categories.forEach(function(n){n.dataFields.forEach(function(n){var t=u._map.fields[n.fieldName];t.onDemand&&!r&&(r=t);t.type!=="String"||t.hidden||s||(s=t.name,h=t.length);w.push(t)})});r&&v&&(o._externalFilter.forEach(function(n){var t=n.Name;y[t]=n.Literal?n.Value:o.convertStringToFieldValue(o.findField(t),n.Value)}),t.pageShown(function(){n.upload.multi.send({id:a,controller:u.name,view:l.Id,files:v,blob:r.name,handler:r.onDemandHandler,index:0,context:y,name:f("name",!0)||s,nameLen:h,type:f("type",!0),size:f("size",!0),key:u.key[0].name})}))});n.uploadFileAjax=function(n){var t=new FormData,r=n.names,i=n.files;return"length"in i||(i=[i]),$(i).each(function(n){var i=this;i.size?r?t.append("file",i,r[n]):t.append("file",i):t.append("file",i,"_delete_")}),$.ajax({url:n.url,method:"POST",processData:!1,data:t,processData:!1,contentType:!1,xhr:function(){var t=new s.XMLHttpRequest;return n.progress&&t.upload.addEventListener("progress",n.progress,!1),t}})};n.safeHtml=function(n){return n!=null&&(n=n.replace(/<\/?script([\s\S]*?)\/?>/gi,"")),n};n.prettyText=br;n.surveyLibrary={};n.surveyFailedToLoad={};n.action=function(n){t&&t.executeInContext(n.icon,n.text,n.path)};n.toTags=function(t,i){var r,u,f;if(i||(i=""),t!=null){if(typeof t=="boolean")return t?i:i+"-none";if(i&&(i=i+"-"),typeof t=="string"||typeof t=="number")return i+t;r=[];for(u in t)f=n.toTags(t[u],i+u),f&&r.push(f);return r.join(" ").replace(/([A-Z])/g,"-$1").toLowerCase()}return i};n.read=function(n,t){for(var f=t.split(/\./g),e=f.length,r,u=n,i=0;i<e;i++){if(r=f[i],i==e-1)return u[r];if(u[r]!=null)u=u[r];else return null}return null};n.survey=function(i,r){function st(t){b=t.tags||t.options&&n.toTags(t.options)||"";t.text||(b+=" page-header-none ");t.tags=b}function ht(t){return n.find(r.parent).get_baseUrl()+(t.match(/\//)?t:"/js/surveys/"+t)}function rt(t){function e(){ft(f);f.cache===!1&&(n.surveyLibrary[u]=null)}try{f=eval(t);var i=f.layout||"";i.match(/(#ref|\.html)$/i)?(y(!0),$.ajax({url:ht(i=="#ref"?p+".html":i),dataType:"text",cache:!1}).done(function(n){y(!1);f.layout=n;e()}).fail(function(){y(!1);typeof r.create=="function"?r.create():n.alert("Unable to load survey layout for "+u+" from the server.")})):e()}catch(o){n.alert("The definiton of "+u+" survey is invalid.\n\n"+o.message+"\n\n"+(s.location.host.match(/\localhost\b/)?n.htmlEncode(o.stack):""))}}function ut(n){!n.topics&&n.questions&&(n.topics=[{questions:n.questions}],n.questions=null)}function ft(t){var e,i,f;if(ut(t),e=r.parent,i=o(e),t.controller=u,t.baseUrl=i?i.get_baseUrl():w,t.servicePath=i?i.get_servicePath():k,t.confirmContext=r.confirmContext,t.showSearchBar=!0,t.parent=e,t.context=r.context,r.options){t.options||(t.options={});for(f in r.options)t.options[f]==null&&(t.options[f]=r.options[f])}t.submit||(t.submit=r.submit);t.submitText||(t.submitText=r.submitText);t.cancel||(t.cancel=r.cancel);t.init||(t.init=r.init);t.calculate||(t.calculate=r.calculate);n.showModal(i,u,"form1","New","",t.baseUrl,t.servicePath,[],{confirmContext:r.confirmContext,showSearchBar:t.showSearchBar,survey:t,tags:t.tags})}function l(n,t,i,r,u,f,e){var o='function(){var r=this,dv=r.dataView(),s=dv.survey(),e=$.Event("'+(typeof i=="string"?i:t)+'",{rules:r,dataView:dv,survey:s'+(e!=null?",argument:"+h(e):"")+"});"+(typeof i=="string"?"$(document).trigger(e);":"s."+t+"(e);")+(r==="Calculate"?"":"if(e.isDefaultPrevented())")+"r.preventDefault();}",s=o.match(/^function\s*\(\)\s*\{([\s\S]+?)\}\s*$/);u||(u="");n.push({Scope:6,Target:null,Type:1,Test:null,Result:"<id>r"+n.length+"<\/id><command>"+r+"<\/command><argument>"+u+"<\/argument><view>form1<\/view><phase>"+f+"<\/phase><js>"+s[1]+"<\/js>",ViewId:"form1"})}function et(n,t,i,r,u){$(n).each(function(){var n=this;r&&r(n,t);$(n.questions).each(function(){var r=this;u&&u(r,n,t,i)});n.topics&&et(n.topics,n,i+1,r,u)})}function g(t,i,r,u){var f=[],e=[],o=[],s=[];if($(t).each(function(t){var i=this;i.ItemsDataValueField||(i.ItemsDataValueField=n.cache[i.ItemsDataController+"_"+i.ItemsDataView+"_DataValueField"]);i.ItemsDataTextField||(i.ItemsDataTextField=n.cache[i.ItemsDataController+"_"+i.ItemsDataView+"_DataTextField"]);i.ItemsDataValueField&&i.ItemsDataTextField||o.push({controller:i.ItemsDataController,view:i.ItemsDataView,requiresData:!1,metadataFilter:["fields"],_fieldIndex:t})}),o.length){y(!0);n.execute({batch:o,success:function(f){$(f).each(function(i){var r=t[o[i]._fieldIndex],u=this.rawResponse;r.ItemsDataValueField||$(u.Fields).each(function(){var t=this;if(t.IsPrimaryKey)return r.ItemsDataValueField=t.Name,n.cache[r.ItemsDataController+"_"+r.ItemsDataView+"_DataValueField"]=t.Name,!1});r.ItemsDataTextField||(r.ItemsDataTextField=u.Fields[0].Name,n.cache[r.ItemsDataController+"_"+r.ItemsDataView+"_DataTextField"]=r.ItemsDataTextField)});g(t,i,r,u)},error:function(){y(!1)}});return}$(t).each(function(){var t=this,u,v=t._dataView,y=[t.ItemsDataValueField,t.ItemsDataTextField],p=t.Copy,w=t.ContextFields,b={controller:t.ItemsDataController,view:t.ItemsDataView,sortExpression:t.ItemsDataTextField,fieldFilter:y,metadataFilter:["fields"],pageSize:1e3,distinct:n.is(t.Tag,"lookup-distinct")},o,h,c,a,l;if(p)while(u=n._fieldMapRegex.exec(p))y.push(u[2]);if(w){for(o=[];u=n._fieldMapRegex.exec(w);)v?h=v.findField(u[2]):$(i).each(function(){var n=this;if(n.Name==u[2])return h=n,!1}),c=r[h.Index],a=!at(h,t),(a||c!=null)&&(c==null&&a?(t.Items=[],s.push(t)):h.ItemsTargetController||h.ItemsStyle==="CheckBoxList"?(l=n.csv.toArray(c),l.length<=1?o.push({field:u[1],value:l[0]}):o.push({field:u[1],operator:"in",values:l})):o.push({field:u[1],value:c}));o.length&&(b.filter=o)}t.skipPopulate||s.indexOf(t)!=-1||(f.push(b),e.push(t))});f.length?(y(!0),n.execute({batch:f,done:function(n){y(!1);$(e).each(function(t){var r=this,u=f[t],e=n[t].rawResponse,i={};$(e.Fields).each(function(n){i[this.Name]=n});r.Items=[];$(e.Rows).each(function(){for(var f=this,t=[],n=0;n<u.fieldFilter.length;n++)t.push(f[i[u.fieldFilter[n]]]);i.group_count_!=null&&t.push(f[i.group_count_]);r.Items.push(t)})});u&&u(e.concat(s))},fail:function(){y(!1)}})):u&&s.length&&u(e)}function ct(n){var i=t.dataView(),u=i.extension();r.compiled=function(f){var o=u._disposeForm(),e;i._views[0].Layout=r.layout;e=t.createLayout(i,t.calcWidth(o.parent()));e=e.insertAfter(o);t.prepareLayout(i,f.NewRow,e);o.remove();u._skipRefresh=!0;i._pageIndex=-1;i._editRow=null;i._onGetPageComplete(f,null);u._skipRefresh=!1;u.stateChanged(!1);n&&n(e)};ot()}function lt(t,i){var r=n.survey,u;return r.registrations||(r.registrations={}),u=r.registrations[t]!=!0,r.registrations[t]=!0,u&&i&&i(),u}function at(n,t){var i=n.ContextFields,r=new RegExp("=\\s*"+t.Name+"\\s*(,|$)");return!!(i&&i.match(r))}function nt(n,t){var f,u,i;return t||(t="string"),f=n,typeof n!=t&&(i=r._expr,i||(i=r._expr=[]),u=n,typeof u!="function"&&(u=function(){return n}),f="this._survey._expr["+i.length+"].call(this)",i.push(u)),f}function ot(){function s(n,i,r){t.Expressions.push({Scope:n,Target:i,Test:r,Type:1,ViewId:"form1"})}var i=[],v={},w=0,o=r.context,f=o&&o._initData,t={Controller:u,View:"form1",TotalRowCount:-1,Fields:[{Name:"sys_pk_",Type:"Int32",Label:"",IsPrimaryKey:!0,ReadOnly:!0,Hidden:!0,AllowNulls:!0,Columns:20}],Views:[{Id:"form1",Label:r.text,Type:"Form"}],ViewHeaderText:r.description,ViewLayout:r.layout,Expressions:[],ActionGroups:[{Scope:"Form",Id:"form",Actions:[]}],Categories:[],NewRow:[1],Rows:[]},y=r.actions||r.buttons,h,c,a,p,e;return r.submit&&(h=r.submitKey,t.ActionGroups[0].Actions.push({Id:"submit",CommandName:"Confirm",WhenLastCommandName:"New",HeaderText:r.submitText,Confirmation:r.submitConfirmation,Key:h===!1?null:h||"Enter",CssClass:r.submitIcon})),r.cancel!=!1&&t.ActionGroups[0].Actions.push({Id:"a2",CommandName:"Cancel",WhenLastCommandName:"New"}),ut(r),c=0,et(r.topics,null,0,function(n,i,r){var u=t.Categories.length,e=n.visibleWhen,f={Id:"c"+u,Index:u,HeaderText:n.text,Description:n.description,Wizard:n.wizard,Flow:n.flow=="newColumn"||c==0?"NewColumn":n.flow=="newRow"?"NewRow":"",Wrap:n.wrap!=null?n.wrap:null,Floating:!!n.floating,Collapsed:n.collapsed==!0,Tab:n.tab};e!=null&&s(2,f.Id,nt(e));r>0&&(f.Depth=r);t.Categories.push(f);n._categoryIndex=u;c++},function(u,e){var a=u.type||"String",y=u.format||u.dataFormatString,et=u.mode,p=u.columns,it=u.rows,ot=u.options,g=ot?n.toTags(ot):u.tags,c=u.items,w,rt,ut,l=u.value,tt=u.context,b=u.name,st=u.visibleWhen,ht=u.readOnlyWhen,ct=u.tooltip,lt=u.label,at=lt==null?u.text:lt,h={Name:b,HtmlEncode:!0,AllowNulls:u.required!=!0,Label:at===!1?"&nbsp;":at||br(u.name),Hidden:u.hidden==!0,CausesCalculate:u.causesCalculate==!0},ft,k,d;if(b){f&&(b in f?l=f[b]:"value"in u&&(f[b]=l,o._initVals.push({field:b,value:l})));u.causesCalculate&&(h.CausesCalculate=!0);switch(a.toLowerCase()){case"text":case"string":a="String";break;case"date":a="DateTime";y||(y="d",p==null&&(p=10));break;case"datetime":a="DateTime";p==null&&(p=20);break;case"time":a="DateTime";y||(y="t",p==null&&(p=8));break;case"number":a="Double";break;case"int":a="Int32";break;case"bool":case"Boolean":a="Boolean";!c&&u.required&&(c={style:"CheckBox"},l==null&&(l=!1));break;case"money":a="Currency";break;case"memo":a="String";it==null&&(it=5);break;case"blob":a="Byte[]";h.OnDemand=!0;h.Multiple=u.multiple}h.Type=a;a==="String"&&(h.Len=u.length||100);a!=="DateTime"||y||(y="g");a!=="Currency"||y||(y="c");y&&(typeof y=="string"?h.DataFormatString=y:(ft=y.DataFormatString,ft&&(h.DataFormatString=ft,a==="DateTime"&&(h.TimeFmtStr=y.TimeFmtStr,h.DateFmtStr=y.DateFmtStr)),delete u.format));p&&(h.Columns=p);it&&(h.Rows=it,a==="String"&&it>1&&(h.Len=0));u.placeholder&&(h.Watermark=u.placeholder);g&&(h.Tag=typeof g=="string"?g:g.join(","));tt&&(typeof tt!="string"&&(tt.forEach(function(n,t){n.match(/=/)||(tt[t]=n+"="+n)}),tt=tt.join(",")),h.ContextFields=tt);u.htmlEncode===!1&&(h.HtmlEncode=!1);et&&(h.TextMode=["password","rtf","note","static"].indexOf(et)+1);(r.readOnly||u.readOnly&&typeof u.readOnly!="function")&&(h.ReadOnly=!0);h.Hidden||(h.CategoryIndex=e._categoryIndex);u.extended&&(h.Extended=u.extended);u.altText&&(h.AltHeaderText=u.altText);u.footer&&(h.FooterText=u.footer);ct&&(h.ToolTip=ct);u.htmlEncode==!1&&(h.HtmlEncode=!1);k=c&&c.filter;k&&(typeof k!="string"&&(k=[],$(c.filter).each(function(){var n=this;k.push(n.match+"="+n.to)}),k=k.join(",")),h.ContextFields=k);c&&(rt=c.controller,w=c.style||(c.list||!rt?"DropDownList":"Lookup"),h.Items=[],_isTagged(g,"lookup-auto-complete-anywhere")&&(h.SearchOptions="$autocompleteanywhere"),w==="Lookup"&&_isTagged(g,"lookup-distinct")&&(w="AutoComplete"),w.match(/AutoComplete|Lookup|DropDown/)&&_isTagged(g,"lookup-multiple")&&(h.ItemsTargetController="_basket",w==="AutoComplete"&&l!=null&&(c.dataValueField===c.dataTextField?(typeof l=="string"&&(l=n.csv.toArray(l)),$(l).each(function(){var n=this;h.Items.push([n,n,null])})):i.push(h))),ut=c.targetController,ut&&(h.ItemsTargetController=ut),l!=null&&(h.ItemsTargetController||w==="CheckBoxList")&&(Array.isArray(l)?l=n.csv.toString(l):typeof l!="string"&&(l=l.toString())),c.list?$(c.list).each(function(){var n=this,t=n.value,i=n.text,r=n.count,u=[t,i==null?t:i];r!=null&&u.push(r);h.Items.push(u)}):rt&&(h.ItemsDataController=rt,h.ItemsDataView=c.view||"grid1",h.ItemsDataValueField=c.dataValueField,h.ItemsDataTextField=c.dataTextField,h.ItemsNewDataView=c.newView,w.match(/AutoComplete|Lookup/)||i.push(h),c.dataValueField!==c.dataTextField&&(h._autoAlias=!0)),h.ItemsStyle=w,c.disabled&&(h.ItemsStyle=null),d=c.copy,d&&(typeof d!="string"&&(d=[],$(c.copy).each(function(){var n=this;d.push(n.to+"="+n.from);n.from===c.dataTextField&&(h.AliasName=n.to,h._autoAlias=!1)}),d=d.join("\n")),h.Copy=d));st!=null&&s(3,b,nt(st));ht!=null&&s(5,b,nt(ht),5);t.Fields.push(h);v[h.Name]=h;typeof l!="function"&&(t.NewRow[t.Fields.length-1]=l)}}),t.Fields.forEach(function(t){var i=t.ContextFields;t.Index=w++;i&&$(i.split(n._simpleListRegex)).each(function(){var i=this.split(n._fieldMapRegex),r=i?v[i[2]]:null;if(r&&r.ItemsDataController===t.ItemsDataController)return t.requiresDynamicNullItem=!0,!1})}),r.init&&l(t.Expressions,"init",r.init,"New","form1","After"),r.submit&&l(t.Expressions,"submit",r.submit,"Confirm",null,"Before"),r.cancel&&l(t.Expressions,"cancel",r.cancel,"Cancel",null,"Before"),r.calculate&&l(t.Expressions,"calculate",r.calculate,"Calculate",null,"Execute"),y&&(a={form:t.ActionGroups[0]},p=0,r._handlers={},y.forEach(function(n,i){var u=n.scope,f,e,h=n.when,c=n.click||n.execute,o=n.id||"b"+i,v=n.text,y=n.position,s;u||(u="form");f=a[u];e=v?{Id:o,CommandName:o,WhenLastCommandName:"New",HeaderText:v,Key:n.key,CausesValidation:n.causesValidation}:{Id:"div"+f.Actions.length,WhenLastCommandName:"New"};n.icon&&(e.CssClass=n.icon);h&&(e.WhenClientScript=typeof h=="function"?h:function(){var t=$.Event(h,{dataView:this,argument:n.argument});return tt.trigger(t),!t.isDefaultPrevented()});f||(f={Scope:u[0].toUpperCase()+u.substring(1),Id:u,Actions:[]},t.ActionGroups.push(f),a[u]=f);s=f.Actions;u==="form"&&y!=="after"?y==="before"?s.splice(p++,0,e):s.splice(s.length-1,0,e):s.push(e);c&&(typeof c=="function"&&(r._handlers[o]=function(n){n.preventDefault();c.call(n.dataView,n)}),l(t.Expressions,"_handlers."+o,c,o,null,"Execute",n.argument))})),st(r),t.Tag=(r.tags||"")+" ignore-unsaved-changes",t.Fields.length===1&&(t.Fields[0].Hidden=!1),e=r.compiled,e&&(i.length?g(i,t.Fields,t.NewRow,function(){e(t)}):e(t),r.compiled=null),t}function it(){y(!1);var t=r.create;t?typeof t=="string"?tt.trigger($.Event(t,{survey:r})):t.call(r):n.alert("Unable to load survey "+u+" from the server.")}var f,a,v;typeof i!="string"&&(r=arguments[0],i="show");var p=r.controller||"survey",u=p.replace(/\W/g,"_"),b,e=r.values||r.data,c,d;if(i==="show"&&e){if(Array.isArray(e))r.data=c={},e.forEach(function(n){c[n.field]="newValue"in n?n.newValue:"oldValue"in n?n.oldValue:n.value});else{c=e;e=[];for(d in c)e.push({name:d,value:c[d]})}r.context||(r.context={});r.context._initVals=e;r.context._initData=c}if(r.external=!(r.topics||r.questions),i==="show")r.external?(f=n.surveyLibrary[u],f?rt(f):(y(!0),a=o(r.parent),r.tryLoad===!1||n.surveyFailedToLoad[u]?it({}):$.ajax({url:k+"/GetSurvey",data:h({name:p}),processData:!1,method:"POST",cache:!1}).done(function(t){y(!1);t=t.d;typeof t=="string"?(n.surveyLibrary[u]=t,rt(t)):(it(t),n.surveyFailedToLoad[u]=!0)}).fail(it))):ft(r);else{if(i==="compile")return ot();if(i==="populateItems")v=[],a=r.dataView,$(a._allFields).each(function(){var n=this;n.ItemsAreDynamic&&n.ContextFields&&!n.skipPopulate&&v.push(n)}),v.length&&g(v,a._allFields,a.row(),r.callback);else if(i==="refresh")ct(arguments[2]);else{if(i==="register")return lt(arguments[1],arguments[2]);n.alert("Unsupported survey method: "+i)}}};n.keyboard=function(){var n=arguments;return n.length&&(tr[n[0]]=n[1]),tr};tt.on("beforetouchinit.app",function(){t=n.touch;d=n.odp}).on("batcheditsubmit.dataview.app",function(i){var e=i.rules,f;if(e.busy()){e.preventDefault();return}var r=e.dataView(),s=r.row(),h=r.survey().context,u=[],o;$(r._allFields).each(function(){var v=this,c=v.Name,l=c.match(/^(.+?)\_Batch(Edit|Keep)$/),t,f,e,a,h,i;if(l&&v.Type==="Boolean"&&(t=r.findField(c),t&&s[t.Index]))if(l[2]==="Keep")u.length&&u[u.length-1].newValue!=null&&u.push({name:c,value:!0});else{if(t=r.findField(l[1]),t&&(h=s[t.Index]),f=t.Extended,e=t.Copy,e)for(i=n._fieldMapRegex.exec(e);i;)i=r.findField(i[1]),u.push({name:i.Name,newValue:s[i.Index],readOnly:i.isReadOnly()}),i=n._fieldMapRegex.exec(e);if(f&&!f.allowNulls&&h==null)return o=t,!1;if(a=f.dependency,a&&$(a).each(function(){var f=this,n=r.findField(f.Name),i=s[n.Index];if(h==null&i!=null)return o=t,!1;u.push({name:n.Name,newValue:i})}),o)return!1;u.push({name:t.Name,newValue:h})}});e.preventDefault();o?e.result.focus(o.Name,rt.RequiredField):u.length&&(y(!0),f=r.get_parentDataView(),$(f._keyFields).each(function(){var n=this;u.push({name:n.Name})}),n.confirm(nr.Confirmation).then(function(){n.execute({controller:h.controller,view:h.view,command:"Update",lastCommand:"BatchEdit",values:u,selectedKeys:f._selectedKeyList,error:function(){y(!1)}}).done(function(n){function i(){f._clearSelectedKey();f._selectedKeyList=[];f.sync()}y(!1);t?(t.pageShown(function(){t.notify(String.format(ut.BatchEdited,n.rowsAffected));i()}),r.cancel()):(r.cancel(),f.set_selectedValue(""),i())})}))});typeof Sys!="undefined"&&ht.notifyScriptLoaded();
/*!
    * Signature Pad v1.3.5
    * https://github.com/szimek/signature_pad
    *
    * Copyright 2015 Szymon Nowak
    * Released under the MIT license
    *
    * The main idea and some parts of the code (e.g. drawing variable width Bzier curve) are taken from:
    * http://corner.squareup.com/2012/07/smoother-signatures.html
    *
    * Implementation of interpolation using cubic Bzier curves is taken from:
    * http://benknowscode.wordpress.com/2012/09/14/path-interpolation-using-cubic-bezier-and-control-point-estimation-in-javascript
    *
    * Algorithm for approximated length of a Bzier curve is taken from:
    * http://www.lemoda.net/maths/bezier-length/index.html
    *
    */
s.SignaturePad=function(){var n=function(n,t){var i=this,r=t||{};i.velocityFilterWeight=r.velocityFilterWeight||.7;i.minWidth=r.minWidth||.5;i.maxWidth=r.maxWidth||2.5;i.dotSize=r.dotSize||function(){return(i.minWidth+i.maxWidth)/2};i.penColor=r.penColor||"black";i.backgroundColor=r.backgroundColor||"rgba(0,0,0,0)";i.onEnd=r.onEnd;i.onBegin=r.onBegin;i._canvas=n;i._ctx=n.getContext("2d");i.clear();i._handleMouseEvents();i._handleTouchEvents()},t,i;return n.prototype.clear=function(){var t=this._ctx,n=this._canvas;t.fillStyle=this.backgroundColor;t.clearRect(0,0,n.width,n.height);t.fillRect(0,0,n.width,n.height);this._reset()},n.prototype.toDataURL=function(){var n=this._canvas;return n.toDataURL.apply(n,arguments)},n.prototype.fromDataURL=function(n){var t=this,i=new Image,r=s.devicePixelRatio||1,u=t._canvas.width/r,f=t._canvas.height/r;t._reset();i.src=n;i.onload=function(){t._ctx.drawImage(i,0,0,u,f)};t._isEmpty=!1},n.prototype._strokeUpdate=function(n){var t=this._createPoint(n);this._addPoint(t)},n.prototype._strokeBegin=function(n){var t=this._ctx,i=this._canvas;if(this._isEmpty&&(t.fillStyle=this.backgroundColor,t.fillRect(0,0,i.width,i.height),t.fillStyle=this.penColor),this._reset(),this._strokeUpdate(n),typeof this.onBegin=="function")this.onBegin(n)},n.prototype._strokeDraw=function(n){var t=this._ctx,i=typeof this.dotSize=="function"?this.dotSize():this.dotSize;t.beginPath();this._drawPoint(n.x,n.y,i);t.closePath();t.fill()},n.prototype._strokeEnd=function(n){var i=this.points.length>2,t=this.points[0];if(!i&&t&&this._strokeDraw(t),typeof this.onEnd=="function")this.onEnd(n)},n.prototype._handleMouseEvents=function(){var n=this,t=$(n._canvas);n._mouseButtonDown=!1;t.on("mousedown",function(t){t=t.originalEvent;t.which===1&&(n._mouseButtonDown=!0,n._strokeBegin(t))});t.on("mousemove",function(t){t=t.originalEvent;n._mouseButtonDown&&n._strokeUpdate(t)});tt.on("mouseup",function(t){t=t.originalEvent;t.which===1&&n._mouseButtonDown&&(n._mouseButtonDown=!1,n._strokeEnd(t))})},n.prototype._handleTouchEvents=function(){var n=this,t=$(n._canvas);n._canvas.style.msTouchAction="none";t.on("touchstart",function(t){t=t.originalEvent;var i=t.changedTouches[0];n._strokeBegin(i)});t.on("touchmove",function(t){t=t.originalEvent;t.preventDefault();var i=t.changedTouches[0];n._strokeUpdate(i)});tt.on("touchend",function(t){t=t.originalEvent;var i=t.target===n._canvas;i&&n._strokeEnd(t)})},n.prototype.isEmpty=function(){return this._isEmpty},n.prototype._reset=function(){this.points=[];this._lastVelocity=0;this._lastWidth=(this.minWidth+this.maxWidth)/2;this._isEmpty=!0;this._ctx.fillStyle=this.penColor},n.prototype._createPoint=function(n){var i=this._canvas.getBoundingClientRect();return new t(n.clientX-i.left,n.clientY-i.top)},n.prototype._addPoint=function(n){var t=this.points,u,f,e,r;t.push(n);t.length>2&&(t.length===3&&t.unshift(t[0]),r=this._calculateCurveControlPoints(t[0],t[1],t[2]),u=r.c2,r=this._calculateCurveControlPoints(t[1],t[2],t[3]),f=r.c1,e=new i(t[1],u,f,t[2]),this._addCurve(e),t.shift())},n.prototype._calculateCurveControlPoints=function(n,i,r){var e=n.x-i.x,o=n.y-i.y,s=i.x-r.x,h=i.y-r.y,f={x:(n.x+i.x)/2,y:(n.y+i.y)/2},u={x:(i.x+r.x)/2,y:(i.y+r.y)/2},p=Math.sqrt(e*e+o*o),c=Math.sqrt(s*s+h*h),w=f.x-u.x,b=f.y-u.y,l=c/(p+c),a={x:u.x+w*l,y:u.y+b*l},v=i.x-a.x,y=i.y-a.y;return{c1:new t(f.x+v,f.y+y),c2:new t(u.x+v,u.y+y)}},n.prototype._addCurve=function(n){var r=n.startPoint,u=n.endPoint,t,i;t=u.velocityFrom(r);t=this.velocityFilterWeight*t+(1-this.velocityFilterWeight)*this._lastVelocity;i=this._strokeWidth(t);this._drawCurve(n,this._lastWidth,i);this._lastVelocity=t;this._lastWidth=i},n.prototype._drawPoint=function(n,t,i){var r=this._ctx;r.moveTo(n,t);r.arc(n,t,i,0,2*Math.PI,!1);this._isEmpty=!1},n.prototype._drawCurve=function(n,t,i){var l=this._ctx,p=i-t,a,y,o,r,s,h,u,c,v,f,e;for(a=Math.floor(n.length()),l.beginPath(),o=0;o<a;o++)r=o/a,s=r*r,h=s*r,u=1-r,c=u*u,v=c*u,f=v*n.startPoint.x,f+=3*c*r*n.control1.x,f+=3*u*s*n.control2.x,f+=h*n.endPoint.x,e=v*n.startPoint.y,e+=3*c*r*n.control1.y,e+=3*u*s*n.control2.y,e+=h*n.endPoint.y,y=t+h*p,this._drawPoint(f,e,y);l.closePath();l.fill()},n.prototype._strokeWidth=function(n){return Math.max(this.maxWidth/(n+1),this.minWidth)},t=function(n,t,i){this.x=n;this.y=t;this.time=i||(new Date).getTime()},t.prototype.velocityFrom=function(n){return this.time!==n.time?this.distanceTo(n)/(this.time-n.time):1},t.prototype.distanceTo=function(n){return Math.sqrt(Math.pow(this.x-n.x,2)+Math.pow(this.y-n.y,2))},i=function(n,t,i,r){this.startPoint=n;this.control1=t;this.control2=i;this.endPoint=r},i.prototype.length=function(){for(var e=10,o=0,t,i,r,s,h,u,f,n=0;n<=e;n++)t=n/e,i=this._point(t,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),r=this._point(t,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y),n>0&&(u=i-s,f=r-h,o+=Math.sqrt(u*u+f*f)),s=i,h=r;return o},i.prototype._point=function(n,t,i,r,u){return t*(1-n)*(1-n)*(1-n)+3*i*(1-n)*(1-n)*n+3*r*(1-n)*n*n+u*n*n*n},n}(document);n.storage={instance:function(n){if(arguments.length){if(n==="avatars"||n==="identities")return s.localStorage;(n==="session"||n==="local")&&(ct=s[n+"Storage"]);n==="default"&&(ct=null)}return ct||(ct=s[((t?t.settings("ui.state.storage"):"")||"local")+"Storage"]),ct},clearUIState:function(){if(!ot){n.storage.instance("default");var r=__settings.appInfo.replace(/\W/g,"_")+"_",u=[],t,i;for(t in ct)t.indexOf(r)===0&&(i=t.substring(r.length),i.length&&!!i.match(/\_/)&&u.push(t));try{u.forEach(function(n){ct.removeItem(n)});p.clear()}catch(f){}}},set:function(n,t){var i=this.instance(n),r,u,f,e;if(i)try{if(n.match(/\*$/)){n=n.substring(0,n.length-1);r=[];for(u in i)u.indexOf(n)==0&&r.push(u);t=JSON.parse(t);r.forEach(function(n){for(f in t)if(n.endsWith("_"+f)){e=t[f];e==null?i.removeItem(n):i[n]=e;break}})}else t==null?i.removeItem(n):i[n]=t}catch(o){}},get:function(n){var t=this.instance(n);if(t)try{return t[n]}catch(i){return null}else return null},remove:function(n){this.set(n,null)},lock:function(){},unlock:function(){}};n.AccountManager={enabled:function(){return t&&t.settings("membership.enabled")!==!1&&t.settings("membership.accountManager.enabled")!==!1},current:function(){if(this.enabled()){var n=this.list(!0);return n[$app.userName()]}},session:function(n){try{if(arguments.length===1)n!=null?sessionStorage.setItem("AccountManager_Id",h(n)):sessionStorage.removeItem("AccountManager_Id");else{var t=sessionStorage.getItem("AccountManager_Id");if(t)return JSON.parse(t)}}catch(i){}return null},set:function(t){var r;t.UserName&&(t={name:t.UserName,email:t.Email,access_token:t.AccessToken,refresh_token:t.RefreshToken,picture:t.Picture,claims:t.Claims});var f=this,u=t.name,e=t.picture,i;ot||(i=n.storage.get("avatars"),f._avatar=i=i?JSON.parse(i):{},e?i[u]=e:delete i[u],n.storage.set("avatars",h(i)));delete t.picture;f.enabled()&&(r=f.list(),t.session?(delete r[u],delete r._lastUser,f.session(t)):(r[u]=t,r._lastUser=u),n.storage.set("identities",h(r)))},count:function(){var t=this.list(),n=0;for(var i in t)i!=="_lastUser"&&n++;return n},list:function(i){var r,u;return t?(r=n.storage.get("identities"),r=r?JSON.parse(r):{},i&&(u=this.session(),u&&(r[u.name]=u)),r):{}},remove:function(i,r){if(t){var u=this.list();u.hasOwnProperty(i)?r?delete u[i]:(u[i].access_token=null,u[i].refresh_token=null):this.session(null);delete u._lastUser;n.storage.set("identities",h(u))}},avatar:function(t,i){var u=this,f,r=u._avatars,e;return r||(e=n.storage.get("avatars"),r=u._avatars=e?JSON.parse(e):{}),u._oldAvatars!=r&&(u._oldAvatars=r,$(document).trigger("useravatarchanged.app")),r&&(f=r[t]),f&&i&&i.css("background-image",'url("'+f+'")').parent().addClass("app-has-avatar-with-picture"),f}}})();