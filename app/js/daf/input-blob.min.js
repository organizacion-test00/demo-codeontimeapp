/*!
* Data Aquarium Framework  - Universal Input / Blob
* Copyright 2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function h(i,r,u){t.isInTransition()?setTimeout(h,50,i,r,u):r.closest(".ui-page-active").length&&n.upload("capture",{field:i,container:r.find(".app-drop-box"),files:u})}var n=$app,r=n.input,t=n.touch,a=$(document),f=Web.DataViewResources,c=f.Data,e=c.BlobDownloadHint,v=n.clientRect,i=n.html,y=i.tag,p=i.div,w=i.span,u=i.$tag,b=i.$p,o=i.$div,s=i.$span,l=i.$a,k=i.$i,d=i.$li,g=i.$ul;r.methods.blob={_mapRequest:function(n,t,i,r){var u={autofill:"map"},f=0,e=0,o=0;return r.forEach(function(r){if(!r.match(/^_/)&&r in i){var s=i[r],h=s.trigger,l=n.findField(s.field),c=t[l.Index];h&&e++;c!=null&&(u[r]=c,f++,h&&o++)}}),f&&e===o?u:null},_mapUpdate:function(n,t,i,r){var u="",f,e;i=JSON.parse(i);r&&(r=JSON.parse(r),r.image&&(u="url(data:"+r.contentType+";base64,"+r.image+")"));f=[];e=i.latitude;e==null||"address1"in i?["address1","address2","address3","city","region","postalcode","country"].forEach(function(n){var t=i[n];t!=null&&f.push(t)}):f.push(e,i.longitude);n.attr("title",f.join(", "));n.css({backgroundImage:u,width:u?i.width:"",backgroundSize:i.scale>1?"100% auto":""}).data("r",i);t.toggleClass("app-has-map",u.length>0)},render:function(i){var tt=this,d=i.container,v=i.inner,h=i.field,wt=h.OnDemandStyle,b=h._dataView,it=i.row,ut=i.editing,rt=it[h.Index],w,ot,y,p,st,ht,ct,ft,bt,a,k,kt,lt,at,nt,vt,et,yt,pt,g;if(w=r.fieldToPlaceholder(h),h.tagged("autofill-address","autofill-geocode")){p=v.find(".app-map-placeholder");p.length||(p=o("app-map-placeholder").appendTo(v.empty()),d.attr("data-read-only","true"),w?s("app-data-input-placeholder").text(w).appendTo(p):p.html("&nbsp;"));t.autofillConfig(b,"");st=b._autoFill;ht=b._controller;for(lt in st)if(h.tagged(lt+"-map")&&(ct=st[lt],ft=tt._mapRequest(b,it,ct,["latitude","longitude"]),bt=tt._mapRequest(b,it,ct,["address1","address2","address3","city","region","city","country"]),a=bt,a?"address1"in a||!ft||(a=ft):a=ft,v.toggleClass("app-has-map",a!=null),a)){kt="";p.css({width:"",height:h.tagged("map-height-")?n.tagSuffix:""});a.width=Math.floor(p.width());a.height=Math.floor(p.height());p.css("width",a.width);a.scale=Math.ceil(window.devicePixelRatio)||1;at=h.Tag.match(/\bmap\-type\-(\w+)\b/);at&&(a.mapType=at[1]);a.zoom=h.tagged("map-zoom-")?parseInt(n.tagSuffix):16;a=JSON.stringify(a);k=n.cache["map:"+a];k?k!==!0&&tt._mapUpdate(p,v,a,k):(n.cache["map:"+a]=!0,n.execute({controller:ht,view:b._viewId,command:"AutoFill",trigger:a,background:!0}).done(function(t){k=t[ht].AutoFill;tt._mapUpdate(p,v,a,k);n.cache["map:"+a]=k}));break}kt==null&&p.css({backgroundImage:"",width:"",height:""}).removeData("r")}else v.empty(),!rt||rt.match(/^null/)?(d.addClass("app-null"),w&&(w===f.Validator.Required&&(w=""),s("app-blob-placeholder").text(w).appendTo(v))):(w=rt,ut||(g=v.find(".app-drop-box"),g.length&&n.upload("destroy",{container:g})),y=l("",'rel="external"').appendTo(v),vt=h.Name.toLowerCase(),et=h.tagged(/\bimage\-original\-(\w+)\b/),n.odp.blob("init",{link:y,field:h,key:w}),wt!==1?($(b._allFields).each(function(){var n=this,t=n.Name.toLowerCase();if(t===vt+"contenttype"||t===vt+"content_type")return nt=it[n.Index],!1}),$(b._allFields).each(function(){var n=this,t=n.Name.toLowerCase();if(t==="contenttype"||t==="content_type")return nt=it[n.Index],!1}),nt||(nt="image"),yt=nt.match(/^image/i),yt&&et&&(et[1]==="always"||et[1]==="editing"&&ut)&&(ot=!0),y.addClass("app-has-image"),n.odp.blob("init",{image:u("img","",t.observableAttr()).appendTo(y).attr({title:e}),field:h,key:w}),yt?y.attr("data-content-type",nt):t.pointer("touch")||y.attr("target","_blank"),ot&&!ut&&(pt=y.data("href"),u("img","",'draggable="false"').css("max-width","100%").attr({src:pt,"data-href":pt,title:e}).appendTo(v),y.remove())):(y.appendTo(v).addClass("app-link-blob").attr("title",e),s().text(c.BlobDownloadLink).appendTo(y),t.pointer("touch")||y.attr("target","_blank"))),ut&&(n.upload("create",{container:o("drop-box-"+h.Index,'tabindex="0"').appendTo(v),dataViewId:b._id,fieldName:h.Name,multiple:h.Multiple,change:function(){var i=!!d.find(".app-drop-box.app-empty").length;d.toggleClass("app-null",i);r.execute({dataView:h._dataView,values:{field:h,value:i?null:"0"},skipDrawingInput:d});t.pageResized(!1);i&&t&&h.OnDemandStyle!==2&&r.methods.blob._setDefaultValue(h,n.input.of(v))}}),(rt==null||rt.match(/^null\|/))&&wt!==2?tt._setDefaultValue(h,d):ot&&y&&(g=v.find(".app-drop-box").removeClass("app-empty"),g.find(".app-drop-text").remove(),u("img","",'draggable="false"').attr("src",y.data("href")).insertBefore(g.children().first()),y.remove()));r.methods.text._createFooter(i)},focus:function(n){return r.beforeFocus(n),t.hasFocus(n),n.is(":input")?void 0:(t.findInput().blur(),n.find(".app-drop-box").focus(),t.saveLastFocusedField(n),!0)},blur:function(n){t.hasFocus(n.target,!1)},_setDefaultValue:function(t,i){var w,y,d,r,e,b,s,c,g,p,k;getDefaultBlobEvent=$.Event("getdefaultblob.app",{dataView:t._dataView,field:t.Name,blob:{}});a.trigger(getDefaultBlobEvent);w=getDefaultBlobEvent.blob.url;c=getDefaultBlobEvent.blob.icon;(w||c)&&(y=i.find(".app-drop-box").empty().removeClass("app-empty"),o().text(f.HeaderFilter.Loading).appendTo(y),d=t.OnDemandStyle!==1?300:0,g=t.tagged(/\bimage\-size\-(\d+)x(\d+)\b/),g&&(r=parseInt(g[1]),e=parseInt(g[2]),dropBoxRect=v(y),d=dropBoxRect.width<r?y.width()*(r>e?r/e:e/r):e),d&&u("img","",'draggable="false"').css({visibility:"hidden",width:"100%",height:d}).appendTo(y),l("app-clear ui-btn ui-btn-icon-notext ui-icon-trash ui-corner-all").css("visibility","hidden").appendTo(y),w?(blobFileName=w.match(/\/([\w\.\-]+?)(\?|$)/),blobFileName=getDefaultBlobEvent.blob.fileName||blobFileName?blobFileName[1]:null,p=new XMLHttpRequest,p.open("GET",n.resolveClientUrl(w),!0),p.responseType="blob",p.onload=function(){var n=p.response;n.name=blobFileName;h(t,i,n)},p.send()):(r=r||512,e=e||512,b=u("canvas")[0],b.width=r,b.height=e,s=b.getContext("2d"),s.textBaseline="top",s.fillStyle="#fff",s.fillRect(0,0,r,e),s.fillStyle=getDefaultBlobEvent.blob.color||"#000",k=Math.min(r,e),s.font=k+"px Material Icons",s.fillText(c,(r-k)/2,(e-k)/2,k),c=n.dataUrlToBlob(b.toDataURL("image/png",1)),c.name=t.Name+".png",h(t,i,c)))},draw:function(t){var i=this;n.getScript("~/js/daf/input-draw",function(){i._draw(t)})}}})();